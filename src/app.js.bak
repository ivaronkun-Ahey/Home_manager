/* global api */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];

const state = { route:'dashboard', profileId:'all', profiles:[], tags:[], userStats: null, calendar: { month: todayISO().slice(0,7), selected: todayISO() } };
const STORAGE_KEYS = { currentPropertyId: 'hm:currentPropertyId' };

// –ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
const MENU_MODULES = [
  { key: 'dashboard', icon: 'üè†', label: '–î–∞—à–±–æ—Ä–¥', route: 'dashboard', section: '–ì–ª–∞–≤–Ω–æ–µ' },
  { key: 'tasks', icon: 'üìã', label: '–î–µ–ª–∞', route: 'tasks', section: '–ì–ª–∞–≤–Ω–æ–µ' },
  { key: 'calendar', icon: 'üìÖ', label: '–ö–∞–ª–µ–Ω–¥–∞—Ä—å', route: 'calendar', section: '–ì–ª–∞–≤–Ω–æ–µ' },
  { key: 'property', icon: 'üè†', label: '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', route: 'property', section: '–ú–æ–π –¥–æ–º' },
  { key: 'rooms', icon: 'üõãÔ∏è', label: '–ö–æ–º–Ω–∞—Ç—ã', route: 'rooms', section: '–ú–æ–π –¥–æ–º' },
  { key: 'inventory', icon: 'üì¶', label: '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', route: 'inventory', section: '–ú–æ–π –¥–æ–º' },
  { key: 'assets', icon: 'üì¶', label: '–û–±—ä–µ–∫—Ç—ã', route: 'assets', section: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
  { key: 'maintenance', icon: 'üîß', label: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', route: 'maintenance', section: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
  { key: 'routines', icon: 'üîÑ', label: '–†—É—Ç–∏–Ω—ã', route: 'routines', section: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
  { key: 'checklists', icon: '‚úÖ', label: '–ß–µ–∫-–ª–∏—Å—Ç—ã', route: 'checklists', section: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
  { key: 'meters', icon: 'üíß', label: '–°—á—ë—Ç—á–∏–∫–∏', route: 'meters', section: '–§–∏–Ω–∞–Ω—Å—ã' },
  { key: 'utility', icon: 'üí∞', label: '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä', route: 'utility', section: '–§–∏–Ω–∞–Ω—Å—ã' },
  { key: 'goals', icon: 'üéØ', label: '–¶–µ–ª–∏/–ø–æ–∫—É–ø–∫–∏', route: 'goals', section: '–§–∏–Ω–∞–Ω—Å—ã' },
  { key: 'contacts', icon: 'üìû', label: '–ö–æ–Ω—Ç–∞–∫—Ç—ã', route: 'contacts', section: '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏' },
  { key: 'documents', icon: 'üìÑ', label: '–î–æ–∫—É–º–µ–Ω—Ç—ã', route: 'documents', section: '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏' },
  { key: 'analytics', icon: 'üìà', label: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞', route: 'analytics', section: '–°–∏—Å—Ç–µ–º–∞' },
  { key: 'stats', icon: 'üèÜ', label: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', route: 'stats', section: '–°–∏—Å—Ç–µ–º–∞' },
  { key: 'settings', icon: '‚öôÔ∏è', label: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏', route: 'settings', section: '–°–∏—Å—Ç–µ–º–∞' },
  { key: 'backup', icon: 'üíæ', label: '–ë—ç–∫–∞–ø', route: 'backup', section: '–°–∏—Å—Ç–µ–º–∞' }
];

let visibleModules = {};

async function loadVisibleModules() {
  const r = await api.settings.getVisibleModules();
  if (r.ok) {
    visibleModules = r.data;
  }
}

function renderNav() {
  const nav = $('#nav');
  if (!nav) return;

  const sections = {};
  MENU_MODULES.forEach(m => {
    if (visibleModules[m.key] !== false) {
      if (!sections[m.section]) sections[m.section] = [];
      sections[m.section].push(m);
    }
  });

  let html = '';
  Object.keys(sections).forEach(sectionName => {
    html += `<div class="navSection">${sectionName}</div>`;
    sections[sectionName].forEach(m => {
      html += `<button class="navItem ${state.route === m.route ? 'active' : ''}" data-route="${m.route}">${m.icon} ${m.label}</button>`;
    });
  });

  nav.innerHTML = html;
}

function openMenuSettings() {
  const content = MENU_MODULES.map(m => `
    <div class="formRow">
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox"
               ${visibleModules[m.key] !== false ? 'checked' : ''}
               onchange="toggleModule('${m.key}', this.checked)"
               ${m.key === 'dashboard' || m.key === 'settings' ? 'disabled' : ''}>
        <span>${m.icon} ${m.label}</span>
      </label>
    </div>
  `).join('');

  openModal('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é', `
    <div class="form">
      <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–µ–Ω—é. Dashboard –∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–ª—å–∑—è —Å–∫—Ä—ã—Ç—å.</p>
      ${content}
    </div>
  `);
}

async function toggleModule(key, visible) {
  await api.settings.setModuleVisibility(key, visible);
  visibleModules[key] = visible;
  renderNav();
}

// ===== THEME MANAGEMENT =====
function applyTheme(theme) {
  if (theme === 'auto') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
  } else {
    document.documentElement.setAttribute('data-theme', theme);
  }
}

async function setTheme(theme) {
  await api.stats.update({ theme });
  if (state.userStats) state.userStats.theme = theme;
  applyTheme(theme);
}

async function toggleTelegram(enabled) {
  if (state.userStats) {
    state.userStats.telegram_enabled = enabled;
  }
  const configDiv = $('#telegram-config');
  if (configDiv) {
    configDiv.style.display = enabled ? 'block' : 'none';
  }
}

async function toggleGamification(enabled) {
  await api.stats.update({ gamification_enabled: enabled });
  if (state.userStats) {
    state.userStats.gamification_enabled = enabled;
  }
  toast(enabled ? '–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞');
  render();
}

async function toggleAnimations(enabled) {
  await api.stats.update({ animations_enabled: enabled });
  if (state.userStats) {
    state.userStats.animations_enabled = enabled;
  }
}

// Listen for system theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
  if (state.userStats && state.userStats.theme === 'auto') {
    applyTheme('auto');
  }
});

function getCurrentPropertyId(){
  return localStorage.getItem(STORAGE_KEYS.currentPropertyId);
}
function setCurrentPropertyId(id){
  if(id) localStorage.setItem(STORAGE_KEYS.currentPropertyId, id);
}
function clearCurrentPropertyId(){
  localStorage.removeItem(STORAGE_KEYS.currentPropertyId);
}
function resolveCurrentProperty(properties){
  if(!properties.length) return null;
  const storedId = getCurrentPropertyId();
  const primary = properties.find(p=>p.is_primary);
  const current = properties.find(p=>p.id===storedId) || primary || properties[0];
  if(current) setCurrentPropertyId(current.id);
  return current;
}
function propertySelectHtml(properties, selectedId){
  return `
    <select class="input" id="propertyPicker">
      ${properties.map(p=>`
        <option value="${p.id}" ${p.id===selectedId?'selected':''}>${escapeHtml(p.name)}${p.is_primary ? ' ‚òÖ' : ''}</option>
      `).join('')}
    </select>
  `;
}

function toast(msg, type = 'info'){
  const el=$('#toast');
  el.textContent=msg;
  el.hidden=false;

  // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
  el.className = 'toast';

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞
  if (type === 'success') el.style.borderLeftColor = 'var(--ok)';
  else if (type === 'error') el.style.borderLeftColor = 'var(--danger)';
  else if (type === 'warning') el.style.borderLeftColor = 'var(--warn)';
  else el.style.borderLeftColor = 'var(--accent)';

  clearTimeout(toast._t);
  const duration = type === 'error' ? 4000 : 2200; // –û—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ª—å—à–µ
  toast._t=setTimeout(()=>el.hidden=true, duration);
}
function todayISO(){
  const d=new Date(); const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function toISODate(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function parseISODate(iso){
  if(!iso) return null;
  return new Date(`${iso}T00:00:00`);
}
function startOfDayLocal(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function startOfWeek(d){
  const day = d.getDay() || 7; // Monday=1..Sunday=7
  const start = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  start.setDate(start.getDate() - (day - 1));
  return start;
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function startOfYear(d){ return new Date(d.getFullYear(), 0, 1); }
function inRange(iso, from, to){
  if(!iso) return false;
  const d = parseISODate(iso);
  if(!d) return false;
  if(from && d < from) return false;
  if(to && d > to) return false;
  return true;
}
function clampNumber(n){ return Number.isFinite(n) ? n : 0; }
function makeBuckets(from, to, unit){
  const buckets = [];
  if(!from || !to) return buckets;
  const cursor = new Date(from.getTime());
  while(cursor <= to){
    const label = unit === 'day'
      ? toISODate(cursor)
      : `${cursor.getFullYear()}-${String(cursor.getMonth()+1).padStart(2,'0')}`;
    const next = unit === 'day'
      ? new Date(cursor.getFullYear(), cursor.getMonth(), cursor.getDate()+1)
      : new Date(cursor.getFullYear(), cursor.getMonth()+1, 1);
    buckets.push({ label, from: new Date(cursor.getTime()), to: new Date(next.getTime()-1), spent:0, collected:0, done:0 });
    cursor.setTime(next.getTime());
  }
  return buckets;
}

function buildMonthGrid(year, monthIndex){
  const first = new Date(year, monthIndex, 1);
  const startOffset = (first.getDay() + 6) % 7; // Monday start
  const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
  const cells = Math.ceil((startOffset + daysInMonth) / 7) * 7;
  const grid = [];
  for(let i = 0; i < cells; i++){
    const dayNumber = i - startOffset + 1;
    const date = new Date(year, monthIndex, dayNumber);
    grid.push({
      date,
      inMonth: dayNumber >= 1 && dayNumber <= daysInMonth
    });
  }
  return grid;
}

function monthLabel(year, monthIndex){
  return new Date(year, monthIndex, 1).toLocaleString('ru-RU', { month:'long', year:'numeric' });
}
function buildWeekGrid(anchorDate){
  const start = startOfWeek(anchorDate);
  return Array.from({ length: 7 }, (_, i) => {
    const date = new Date(start.getFullYear(), start.getMonth(), start.getDate() + i);
    return { date, inMonth: true };
  });
}
function daysDiff(fromISO,toISO){
  const a=new Date(fromISO+'T00:00:00'); const b=new Date(toISO+'T00:00:00');
  return Math.floor((b-a)/(24*3600*1000));
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function profileName(id){ return state.profiles.find(p=>p.id===id)?.name || '‚Äî'; }
function formatMoneyRUB(value){
  return `${Math.round(value || 0).toLocaleString('ru-RU')} ‚ÇΩ`;
}

function setRoute(route){
  state.route=route;
  renderNav(); // Re-render nav to update active states
  render();
}
function openModal(title, innerHtml, onBind){
  const overlay=$('#modalOverlay'); const modal=$('#modal');
  modal.innerHTML=`
    <div class="modalHeader">
      <div class="modalTitle">${title}</div>
      <button class="iconBtn" id="modalClose">‚úï</button>
    </div>
    <div class="modalBody">${innerHtml}</div>
  `;
  overlay.hidden=false;
  $('#modalClose').onclick=closeModal;
  overlay.onclick=(e)=>{ if(e.target===overlay) closeModal(); };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
  if(overlay._escHandler){
    document.removeEventListener('keydown', overlay._escHandler);
  }
  const escHandler = (e) => { if(e.key === 'Escape') closeModal(); };
  overlay._escHandler = escHandler;
  document.addEventListener('keydown', escHandler);

  onBind && onBind(modal);

  // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
  setTimeout(() => {
    const firstInput = modal.querySelector('input:not([type="hidden"]), textarea, select');
    if (firstInput) firstInput.focus();
  }, 50);
}

function closeModal(){
  const overlay = $('#modalOverlay');
  if (overlay._escHandler) {
    document.removeEventListener('keydown', overlay._escHandler);
    delete overlay._escHandler;
  }
  overlay.hidden=true;
  $('#modal').innerHTML='';
}

function profileOptions(selected){
  const all=[{id:'all',name:'–í—Å–µ'}, ...state.profiles.filter(p=>!p.is_archived)];
  return all.map(p=>`<option value="${p.id}" ${p.id===selected?'selected':''}>${escapeHtml(p.name)}</option>`).join('');
}
async function loadMeta(){
  const r=await api.meta.getAppInfo();
  if(r.ok) $('#appInfo').textContent=`v${r.data.version} ‚Ä¢ ${r.data.platform}`;
}
async function loadProfiles(){
  const r=await api.profiles.list();
  if(!r.ok) return toast(r.error, 'error');
  state.profiles=r.data;
  $('#profileSelect').innerHTML=profileOptions(state.profileId);
}
async function loadTags(){
  const r=await api.tags.list();
  if(r.ok) state.tags=r.data;
}

function tagPickerHtml(selectedIds=[]){
  const selected=new Set(selectedIds||[]);
  const options=state.tags.map(t=>`
    <label class="badge" style="border-color:${t.color};">
      <input type="checkbox" value="${t.id}" ${selected.has(t.id)?'checked':''} />
      ${escapeHtml(t.name)}
    </label>
  `).join(' ');
  return `
    <div class="card">
      <div class="muted">–¢–µ–≥–∏</div>
      <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">${options || '<span class="muted">–¢–µ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</span>'}</div>
      <div class="row" style="margin-top:10px; gap:8px;">
        <input class="input" id="newTagName" placeholder="–ù–æ–≤—ã–π —Ç–µ–≥ (Enter)" />
        <button class="btn" id="addTagBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  `;
}
function readTagPicker(root){
  return $$('input[type="checkbox"]', root).filter(x=>x.checked).map(x=>x.value);
}

function isOverdue(t){ return t.due_at && t.status!=='done' && t.due_at < todayISO(); }

function normalizeChecklistProgress(progress, checklist){
  const completed = Array.isArray(progress?.completed_items)
    ? progress.completed_items
    : Array.isArray(progress?.completed)
      ? progress.completed
      : [];
  const total = Array.isArray(checklist?.items) ? checklist.items.length : (progress?.total || 0);
  return { completed, total };
}

// ============================================
// GAMIFICATION SYSTEM
// ============================================

const ACHIEVEMENTS = [
  // –ó–∞–¥–∞—á–∏
  { id: 'first_task', name: '–ü–µ—Ä–≤–æ–µ –¥–µ–ª–æ', description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É', icon: 'üéØ', xp: 10 },
  { id: 'tasks_10', name: '10 –¥–µ–ª', description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 10 –∑–∞–¥–∞—á', icon: 'üìã', xp: 50 },
  { id: 'tasks_50', name: '50 –¥–µ–ª', description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 50 –∑–∞–¥–∞—á', icon: 'üìö', xp: 200 },
  { id: 'tasks_100', name: '100 –¥–µ–ª', description: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 100 –∑–∞–¥–∞—á', icon: 'üèÖ', xp: 500 },

  // Streak
  { id: 'streak_3', name: '3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', description: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', icon: 'üî•', xp: 30 },
  { id: 'streak_7', name: '–ù–µ–¥–µ–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', description: '7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üí™', xp: 100 },
  { id: 'streak_30', name: '–ú–µ—Å—è—Ü –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', description: '30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', icon: 'üèÜ', xp: 500 },

  // –£—Ä–æ–≤–Ω–∏
  { id: 'level_5', name: '–£—Ä–æ–≤–µ–Ω—å 5', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 5 —É—Ä–æ–≤–Ω—è', icon: '‚≠ê', xp: 100 },
  { id: 'level_10', name: '–£—Ä–æ–≤–µ–Ω—å 10', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 10 —É—Ä–æ–≤–Ω—è', icon: 'üåü', xp: 300 },
  { id: 'level_25', name: '–£—Ä–æ–≤–µ–Ω—å 25', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 25 —É—Ä–æ–≤–Ω—è', icon: 'üí´', xp: 1000 },

  // –°—á—ë—Ç—á–∏–∫–∏
  { id: 'meter_first', name: '–ü–µ—Ä–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è', description: '–í–Ω–µ—Å–∏—Ç–µ –ø–µ—Ä–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞', icon: 'üíß', xp: 20 },
  { id: 'meter_streak_3', name: '–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å', description: '3 –º–µ—Å—è—Ü–∞ –ø–æ–¥—Ä—è–¥ –≤–Ω–æ—Å–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è', icon: 'üìä', xp: 100 },

  // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
  { id: 'inventory_10', name: '–£—á—ë—Ç—á–∏–∫', description: '–î–æ–±–∞–≤—å—Ç–µ 10 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å', icon: 'üì¶', xp: 50 },
  { id: 'inventory_50', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', description: '–î–æ–±–∞–≤—å—Ç–µ 50 –ø—Ä–µ–¥–º–µ—Ç–æ–≤', icon: 'üóÉÔ∏è', xp: 200 },

  // –ß–µ–∫-–ª–∏—Å—Ç—ã
  { id: 'checklist_first', name: '–ß–µ–∫-–ª–∏—Å—Ç –º–∞—Å—Ç–µ—Ä', description: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç', icon: '‚úÖ', xp: 30 },

  // –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
  { id: 'maintenance_first', name: '–ü–µ—Ä–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', description: '–ó–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', icon: 'üîß', xp: 20 },
  { id: 'maintenance_10', name: '–¢–µ—Ö–Ω–∏–∫', description: '10 –∑–∞–ø–∏—Å–µ–π –≤ –∂—É—Ä–Ω–∞–ª–µ', icon: '‚öôÔ∏è', xp: 100 },

  // –¶–µ–ª–∏
  { id: 'goal_first', name: '–ü–µ—Ä–≤–∞—è —Ü–µ–ª—å', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å', icon: 'üéØ', xp: 50 },
  { id: 'goal_5', name: '–¶–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª—ë–Ω–Ω—ã–π', description: '–î–æ—Å—Ç–∏–≥–Ω–∏—Ç–µ 5 —Ü–µ–ª–µ–π', icon: 'üèÅ', xp: 200 },

  // –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å
  { id: 'first_property', name: '–î–æ–º–æ–≤–ª–∞–¥–µ–ª–µ—Ü', description: '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', icon: 'üè†', xp: 20 },

  // –ö–æ–Ω—Ç–∞–∫—Ç—ã
  { id: 'contact_keeper', name: '–ö–æ–Ω—Ç–∞–∫—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ', description: '–î–æ–±–∞–≤—å—Ç–µ 5 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤', icon: 'üìû', xp: 20 },

  // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ
  { id: 'organized', name: '–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä', description: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å–µ –º–æ–¥—É–ª–∏', icon: 'üóÇÔ∏è', xp: 100 },
  { id: 'early_bird', name: '–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞', description: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–æ 8 —É—Ç—Ä–∞', icon: 'üåÖ', xp: 30 },
  { id: 'night_owl', name: '–ù–æ—á–Ω–∞—è —Å–æ–≤–∞', description: '–ó–∞–≤–µ—Ä—à–∏—Ç–µ –∑–∞–¥–∞—á—É –ø–æ—Å–ª–µ –ø–æ–ª—É–Ω–æ—á–∏', icon: 'ü¶â', xp: 30 }
];

function getLevelForXP(xp) {
  // Level formula: level = floor(sqrt(xp / 100)) + 1
  // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
  const safeXP = Math.max(0, xp || 0);
  return Math.floor(Math.sqrt(safeXP / 100)) + 1;
}

function getXPForLevel(level) {
  // XP needed for level: (level - 1)^2 * 100
  return Math.pow(level - 1, 2) * 100;
}

function getXPProgressForCurrentLevel(xp) {
  const safeXP = Math.max(0, xp || 0);
  const currentLevel = getLevelForXP(safeXP);
  const currentLevelXP = getXPForLevel(currentLevel);
  const nextLevelXP = getXPForLevel(currentLevel + 1);
  const progressXP = safeXP - currentLevelXP;
  const requiredXP = nextLevelXP - currentLevelXP;
  const percentage = requiredXP > 0 ? Math.round((progressXP / requiredXP) * 100) : 0;
  return { progressXP, requiredXP, percentage: Math.max(0, Math.min(100, percentage)) };
}

async function loadUserStats() {
  const res = await api.stats.get();
  if (res.ok) {
    state.userStats = res.data;
    updateStatsDisplay();
  }
}

function updateStatsDisplay() {
  const statsEl = $('#statsDisplay');
  if (!statsEl) return;

  const stats = state.userStats;
  if (!stats || !stats.gamification_enabled) {
    statsEl.style.display = 'none';
    return;
  }

  const level = getLevelForXP(stats.xp);
  const { percentage } = getXPProgressForCurrentLevel(stats.xp);

  statsEl.style.display = 'flex';
  statsEl.style.alignItems = 'center';
  statsEl.style.gap = '12px';
  statsEl.style.cursor = 'pointer';
  statsEl.title = '–û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è';

  statsEl.innerHTML = `
    <div style="display:flex; align-items:center; gap:8px; padding:6px 12px; border-radius:12px; background:rgba(96,165,250,0.1); border:1px solid rgba(96,165,250,0.3);">
      <span style="font-size:16px;">‚≠ê</span>
      <div style="display:flex; flex-direction:column; gap:2px;">
        <div style="font-size:12px; font-weight:700; line-height:1;">–£—Ä. ${level}</div>
        <div style="font-size:10px; color:var(--muted); line-height:1;">${stats.xp} XP</div>
      </div>
      <div style="width:40px; height:4px; background:var(--border); border-radius:999px; overflow:hidden;">
        <div style="width:${percentage}%; height:100%; background:linear-gradient(90deg, var(--accent), var(--ok)); transition:width 0.3s;"></div>
      </div>
    </div>
    ${stats.current_streak && stats.current_streak > 0 ? `
      <div style="font-size:16px;" title="–°–µ—Ä–∏—è: ${stats.current_streak} –¥–Ω–µ–π">üî• ${stats.current_streak}</div>
    ` : ''}
  `;

  statsEl.onclick = () => setRoute('stats');
}

async function awardXP(amount, reason = '') {
  if (!state.userStats || !state.userStats.gamification_enabled) return;

  const currentXP = Math.max(0, state.userStats.xp || 0);
  const oldLevel = getLevelForXP(currentXP);
  const newXP = Math.max(0, currentXP + amount);
  const newLevel = getLevelForXP(newXP);

  const res = await api.stats.update({ xp: newXP });
  if (!res.ok) return;

  state.userStats.xp = newXP;
  updateStatsDisplay();

  // Check for level up
  if (newLevel > oldLevel) {
    toast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${newLevel}! +${amount} XP`);
    checkAchievementsDebounced();
  } else {
    toast(`+${amount} XP${reason ? ': ' + reason : ''}`);
  }
}

// Debounce helper to avoid calling checkAchievements too frequently
let checkAchievementsTimeout = null;
function checkAchievementsDebounced() {
  if (checkAchievementsTimeout) clearTimeout(checkAchievementsTimeout);
  checkAchievementsTimeout = setTimeout(() => checkAchievements(), 1000);
}

async function checkAchievements() {
  if (!state.userStats || !state.userStats.gamification_enabled) return;

  const unlockedSet = new Set(state.userStats.unlocked_achievements || []);
  const newlyUnlocked = [];

  // Get counts for various achievements (all parallel for performance)
  const [tasksRes, propertiesRes, inventoryRes, readingsRes, contactsRes, checklistsRes, goalsRes, maintenanceLogsRes] = await Promise.all([
    api.tasks.list({ status: 'all', range: 'all' }),
    api.properties.list(),
    api.inventory.list({}),
    api.meters.getReadings({}),
    api.contacts.list({}),
    api.checklists.list(),
    api.goals.list({}),
    api.maintenance.logs.list({})
  ]);

  const tasksData = tasksRes.ok ? tasksRes.data : [];
  const tasksCompleted = tasksData.filter(t => t.status === 'done').length;
  const propertiesCount = propertiesRes.ok ? propertiesRes.data.length : 0;
  const inventoryCount = inventoryRes.ok ? inventoryRes.data.length : 0;
  const readingsCount = readingsRes.ok ? readingsRes.data.length : 0;
  const contactsCount = contactsRes.ok ? contactsRes.data.length : 0;
  const goalsData = goalsRes.ok ? goalsRes.data : [];
  const goalsAchieved = goalsData.filter(g => g.status === 'archived' && g.saved_amount >= g.target_amount).length;
  const maintenanceCount = maintenanceLogsRes.ok ? maintenanceLogsRes.data.length : 0;

  // Calculate checklists completed (parallel for performance)
  let checklistsCompleted = 0;
  if (checklistsRes.ok && checklistsRes.data.length > 0) {
    const progressResults = await Promise.all(
      checklistsRes.data.map(cl => api.checklists.getProgress({ id: cl.id }))
    );
    checklistsCompleted = progressResults.filter(
      res => res.ok && res.data.completed.length === res.data.total
    ).length;
  }

  // Calculate meter streak (consecutive months with readings)
  let meterStreak = 0;
  if (readingsRes.ok && readingsRes.data.length > 0) {
    const readings = readingsRes.data.sort((a, b) => b.reading_date.localeCompare(a.reading_date));
    const months = [...new Set(readings.map(r => r.reading_date.slice(0, 7)))].sort().reverse();
    for (let i = 0; i < months.length; i++) {
      if (i === 0 || months[i - 1].slice(0, 4) === months[i].slice(0, 4) &&
          parseInt(months[i - 1].slice(5)) - parseInt(months[i].slice(5)) === 1) {
        meterStreak++;
      } else {
        break;
      }
    }
  }

  // Check for early bird and night owl (if tasks have completion time)
  let hasEarlyBird = false;
  let hasNightOwl = false;
  for (const task of tasksData.filter(t => t.status === 'done' && t.done_at)) {
    if (task.done_at_time) {
      const hour = parseInt(task.done_at_time.split(':')[0]);
      if (hour < 8) hasEarlyBird = true;
      if (hour >= 0 && hour < 6) hasNightOwl = true;
    }
  }

  // Check if all modules have been used (organized achievement)
  const usedModules = new Set();
  if (tasksCompleted > 0) usedModules.add('tasks');
  if (propertiesCount > 0) usedModules.add('properties');
  if (inventoryCount > 0) usedModules.add('inventory');
  if (readingsCount > 0) usedModules.add('meters');
  if (contactsCount > 0) usedModules.add('contacts');
  if (checklistsCompleted > 0) usedModules.add('checklists');
  if (goalsData.length > 0) usedModules.add('goals');
  if (maintenanceCount > 0) usedModules.add('maintenance');
  const isOrganized = usedModules.size >= 6;

  const currentLevel = getLevelForXP(state.userStats.xp);
  const currentStreak = state.userStats.current_streak || 0;

  // Check each achievement
  for (const achievement of ACHIEVEMENTS) {
    if (unlockedSet.has(achievement.id)) continue;

    let unlocked = false;

    switch (achievement.id) {
      // Tasks
      case 'first_task': unlocked = tasksCompleted >= 1; break;
      case 'tasks_10': unlocked = tasksCompleted >= 10; break;
      case 'tasks_50': unlocked = tasksCompleted >= 50; break;
      case 'tasks_100': unlocked = tasksCompleted >= 100; break;

      // Streaks
      case 'streak_3': unlocked = currentStreak >= 3; break;
      case 'streak_7': unlocked = currentStreak >= 7; break;
      case 'streak_30': unlocked = currentStreak >= 30; break;

      // Levels
      case 'level_5': unlocked = currentLevel >= 5; break;
      case 'level_10': unlocked = currentLevel >= 10; break;
      case 'level_25': unlocked = currentLevel >= 25; break;

      // Meters
      case 'meter_first': unlocked = readingsCount >= 1; break;
      case 'meter_streak_3': unlocked = meterStreak >= 3; break;

      // Inventory
      case 'inventory_10': unlocked = inventoryCount >= 10; break;
      case 'inventory_50': unlocked = inventoryCount >= 50; break;

      // Checklists
      case 'checklist_first': unlocked = checklistsCompleted >= 1; break;

      // Maintenance
      case 'maintenance_first': unlocked = maintenanceCount >= 1; break;
      case 'maintenance_10': unlocked = maintenanceCount >= 10; break;

      // Goals
      case 'goal_first': unlocked = goalsAchieved >= 1; break;
      case 'goal_5': unlocked = goalsAchieved >= 5; break;

      // Properties
      case 'first_property': unlocked = propertiesCount >= 1; break;

      // Contacts
      case 'contact_keeper': unlocked = contactsCount >= 5; break;

      // Special
      case 'organized': unlocked = isOrganized; break;
      case 'early_bird': unlocked = hasEarlyBird; break;
      case 'night_owl': unlocked = hasNightOwl; break;
    }

    if (unlocked) {
      newlyUnlocked.push(achievement);
      unlockedSet.add(achievement.id);
    }
  }

  // Save newly unlocked achievements
  if (newlyUnlocked.length > 0) {
    await api.stats.update({ unlocked_achievements: Array.from(unlockedSet) });
    state.userStats.unlocked_achievements = Array.from(unlockedSet);

    // Award bonus XP for achievements
    for (const achievement of newlyUnlocked) {
      if (achievement.xp > 0) {
        await awardXP(achievement.xp, achievement.name);
      }
      toast(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${achievement.name}`);
    }
  }
}

async function updateStreak() {
  if (!state.userStats || !state.userStats.gamification_enabled) return;

  const today = todayISO();
  const lastActivity = state.userStats.last_activity_date;

  if (lastActivity === today) return; // Already active today

  let newStreak = 1;
  if (lastActivity) {
    const daysSince = daysDiff(lastActivity, today);
    if (daysSince === 1) {
      // Consecutive day
      newStreak = (state.userStats.current_streak || 0) + 1;
    } else if (daysSince > 1) {
      // Streak broken
      newStreak = 1;
    }
  }

  await api.stats.update({
    current_streak: newStreak,
    longest_streak: Math.max(newStreak, state.userStats.longest_streak || 0),
    last_activity_date: today
  });

  state.userStats.current_streak = newStreak;
  state.userStats.longest_streak = Math.max(newStreak, state.userStats.longest_streak || 0);
  state.userStats.last_activity_date = today;

  updateStatsDisplay();
  checkAchievementsDebounced();
}

function itemTaskHtml(t){
  const due = t.due_at ? `<span class="badge ${isOverdue(t)?'danger':''}">${t.due_at}</span>` : `<span class="badge">–±–µ–∑ —Å—Ä–æ–∫–∞</span>`;
  return `
    <div class="item" data-task-id="${t.id}">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(t.title)}</div>
        <div class="itemMeta">
          ${due}
          ${t.profile_id ? `<span class="badge">${escapeHtml(profileName(t.profile_id))}</span>`:''}
        </div>
      </div>
      <div class="itemActions">
        <button class="iconBtn" data-task-done="${t.id}">‚úì</button>
        <button class="iconBtn" data-task-edit="${t.id}">‚úé</button>
        <button class="iconBtn" data-task-del="${t.id}">üóë</button>
      </div>
    </div>
  `;
}
function bindTaskRowActions(root){
  $$('[data-task-done]', root).forEach(b=>b.onclick=async ()=>{
    const r=await api.tasks.setStatus({ id:b.dataset.taskDone, status:'done' });
    if(!r.ok) return toast(r.error, 'error');
    await updateStreak();
    await awardXP(5, '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
    checkAchievementsDebounced();
    toast('–ì–æ—Ç–æ–≤–æ', 'success'); render();
  });
  $$('[data-task-edit]', root).forEach(b=>b.onclick=async ()=>{
    const id=b.dataset.taskEdit;
    const all=await api.tasks.list({ profile_id: state.profileId, status:'all', range:'all' });
    const t=all.ok ? all.data.find(x=>x.id===id) : null;
    if(t) openTaskModal(t);
  });
  $$('[data-task-del]', root).forEach(b=>b.onclick=async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
    const r=await api.tasks.delete({ id:b.dataset.taskDel });
    if(!r.ok) return toast(r.error, 'error');
    toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); render();
  });
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–º–Ω–æ–≥–æ Dashboard
function formatDateShort(isoDate) {
  if (!isoDate) return '';
  const d = new Date(isoDate);
  const days = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
  return `${days[d.getDay()]}, ${d.getDate()}`;
}

function formatMoney(amount) {
  return new Intl.NumberFormat('ru-RU').format(amount || 0) + ' ‚ÇΩ';
}

function renderSmartDashboardSections(data) {
  let html = '';

  // –°—Ä–æ—á–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è)
  if (data.urgent && data.urgent.length > 0) {
    html += `
      <div class="card" style="grid-column: 1 / -1; background: linear-gradient(135deg, #fff5f5, #fff); border-left: 4px solid #e53e3e;">
        <div class="cardHeader">
          <div class="cardTitle">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
          <span class="badge danger">${data.urgent.length}</span>
        </div>
        <div class="cardBody">
          <div style="display:flex; flex-direction:column; gap:8px;">
            ${data.urgent.slice(0, 5).map(item => `
              <div class="urgent-item priority-${item.priority}"
                   style="padding:10px; border-radius:6px; background: ${item.priority === 'high' ? '#fed7d7' : '#feebc8'}; cursor:pointer;"
                   data-route="${item.action.route}" style="cursor:pointer;">
                <div style="font-weight:600;">${escapeHtml(item.title)}</div>
                <div style="font-size:12px; color:#666; margin-top:4px;">${escapeHtml(item.subtitle)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  // –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
  if (data.today && data.today.length > 0) {
    html += `
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üìã –°–µ–≥–æ–¥–Ω—è</div>
          <span class="badge">${data.today.length}</span>
        </div>
        <div class="cardBody">
          ${data.today.slice(0, 5).map(t => `
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <input type="checkbox" onchange="completeTaskQuick('${t.id}')">
              <span style="flex:1;">${escapeHtml(t.title)}</span>
              <span class="badge priority-${t.priority}">${t.priority}</span>
            </div>
          `).join('')}
          ${data.today.length > 5 ? `<div class="muted" style="margin-top:8px;">+${data.today.length - 5} –µ—â—ë</div>` : ''}
          <button class="btn" data-route="tasks" style="margin-top:8px; width:100%;">–í—Å–µ –∑–∞–¥–∞—á–∏ ‚Üí</button>
        </div>
      </div>
    `;
  }

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é
  if (data.weekStats) {
    const s = data.weekStats;
    html += `
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üìä –ù–µ–¥–µ–ª—è</div>
        </div>
        <div class="cardBody">
          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-bottom:12px;">
            <div style="text-align:center;">
              <div style="font-size:24px; font-weight:700;">${s.tasks_completed}</div>
              <div style="font-size:11px; color:#666;">–∑–∞–¥–∞—á</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px; font-weight:700;">${s.maintenance_done}</div>
              <div style="font-size:11px; color:#666;">–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–π</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px; font-weight:700;">üî• ${s.current_streak}</div>
              <div style="font-size:11px; color:#666;">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
            </div>
          </div>
          <div style="background:#eee; height:8px; border-radius:999px; overflow:hidden;">
            <div style="background:linear-gradient(90deg, #3b82f6, #22c55e); height:100%; width:${(s.xp % 100)}%; transition:width 0.5s;"></div>
          </div>
          <div style="text-align:center; margin-top:6px; font-size:12px;">–£—Ä–æ–≤–µ–Ω—å ${s.level} ‚Ä¢ ${s.xp} XP</div>
        </div>
      </div>
    `;
  }

  // –°—á—ë—Ç—á–∏–∫–∏
  if (data.meters && data.meters.length > 0) {
    const needsAttention = data.meters.filter(m => m.status !== 'ok');
    html += `
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üíß –°—á—ë—Ç—á–∏–∫–∏</div>
          ${needsAttention.length > 0 ? `<span class="badge warn">${needsAttention.length}</span>` : '<span class="badge ok">‚úì</span>'}
        </div>
        <div class="cardBody">
          ${needsAttention.length > 0 ? `
            <div style="margin-bottom:8px; color:#d97706; font-weight:600;">${needsAttention.length} —Ç—Ä–µ–±—É—é—Ç –ø–æ–∫–∞–∑–∞–Ω–∏–π</div>
            ${needsAttention.slice(0, 3).map(m => `
              <div style="margin-bottom:6px; padding:8px; background:#fef3c7; border-radius:4px;">
                <div style="font-weight:600;">${escapeHtml(m.name)}</div>
                <div style="font-size:12px; color:#666;">–ü–æ–¥–∞—á–∞: ${m.submission_period} —á–∏—Å–ª–∞</div>
              </div>
            `).join('')}
            <button class="btn warn" data-route="meters" style="margin-top:8px; width:100%;">–í–Ω–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω–∏—è</button>
          ` : `
            <div style="color:#22c55e; font-weight:600;">‚úÖ –í—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã</div>
            <button class="btn" data-route="meters" style="margin-top:8px; width:100%;">–û—Ç–∫—Ä—ã—Ç—å</button>
          `}
        </div>
      </div>
    `;
  }

  // –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è
  if (data.upcoming && data.upcoming.length > 0) {
    html += `
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üìÖ –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div>
          <span class="badge">${data.upcoming.length}</span>
        </div>
        <div class="cardBody">
          ${data.upcoming.slice(0, 5).map(item => `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid #eee;"
                 data-route="${item.action.route}" style="cursor:pointer;">
              <div>
                <div style="font-weight:600;">${escapeHtml(item.title)}</div>
                <div style="font-size:11px; color:#666;">${formatDateShort(item.date)}</div>
              </div>
              <span class="badge">${item.type === 'task' ? 'üìã' : 'üîß'}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  // –¶–µ–ª–∏
  if (data.goals && data.goals.length > 0) {
    html += `
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üéØ –¶–µ–ª–∏</div>
          <span class="badge">${data.goals.length}</span>
        </div>
        <div class="cardBody">
          ${data.goals.map(g => `
            <div style="margin-bottom:12px;" data-route="goals" style="cursor:pointer;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                <div style="font-weight:600; font-size:13px;">${escapeHtml(g.title)}</div>
                <div style="font-size:12px; font-weight:600; color:#3b82f6;">${g.progress}%</div>
              </div>
              <div style="background:#eee; height:6px; border-radius:999px; overflow:hidden;">
                <div style="background:linear-gradient(90deg, #3b82f6, #22c55e); height:100%; width:${g.progress}%; transition:width 0.3s;"></div>
              </div>
              <div style="font-size:11px; color:#666; margin-top:4px;">${formatMoney(g.saved)} / ${formatMoney(g.target)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }

  return html;
}

async function completeTaskQuick(id) {
  const r = await api.tasks.setStatus({ id, status: 'done' });
  if (!r.ok) return toast(r.error, 'error');
  await updateStreak();
  await awardXP(5, '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
  checkAchievementsDebounced();
  toast('–ì–æ—Ç–æ–≤–æ', 'success');
  render();
}

async function renderDashboard(){
  const prof=state.profileId;

  // Ensure routine instances for today exist before building the dashboard lists.
  await api.routines.generate({ daysAhead:14 });

  // Load all data in parallel
  const [
    tasksOverdue, plansOverdue, plansSoon, goals,
    properties, meters, inventory, contacts, checklists
  ] = await Promise.all([
    api.tasks.list({ profile_id: prof, status:'active', range:'overdue' }),
    api.maintenance.plans.list({ range:'overdue', daysSoon:14 }),
    api.maintenance.plans.list({ range:'soon', daysSoon:14 }),
    api.goals.list({ status:'active' }),
    api.properties.list(),
    api.meters.list({}),
    api.inventory.list({}),
    api.contacts.list({}),
    api.checklists.list()
  ]);

  const overdueCount=(tasksOverdue.ok?tasksOverdue.data.length:0)+(plansOverdue.ok?plansOverdue.data.length:0);
  const propertiesData = properties.ok ? properties.data : [];
  const metersData = meters.ok ? meters.data : [];
  const inventoryData = inventory.ok ? inventory.data : [];
  const contactsData = contacts.ok ? contacts.data : [];
  const checklistsData = checklists.ok ? checklists.data : [];

  // Calculate meters needing reading (day 15-25)
  const today = new Date();
  const dayOfMonth = today.getDate();
  const metersNeedingReading = metersData.filter(m => {
    return m.is_active && dayOfMonth >= (m.submission_day_start || 15) && dayOfMonth <= (m.submission_day_end || 25);
  });

  // Get gamification stats
  const stats = state.userStats;
  let levelWidget = '';
  let recentAchievements = [];

  if (stats && stats.gamification_enabled) {
    const level = getLevelForXP(stats.xp);
    const { progressXP, requiredXP, percentage } = getXPProgressForCurrentLevel(stats.xp);
    const unlockedSet = new Set(stats.unlocked_achievements || []);
    recentAchievements = ACHIEVEMENTS.filter(a => unlockedSet.has(a.id)).slice(-3).reverse();

    levelWidget = `
      <div class="card" style="background: linear-gradient(135deg, rgba(96,165,250,0.15) 0%, rgba(139,92,246,0.15) 100%); grid-column: span 2;">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:24px;">‚≠ê</span>
            <div class="cardTitle">–£—Ä–æ–≤–µ–Ω—å ${level}</div>
          </div>
          <span class="badge ok">${stats.xp} XP</span>
        </div>
        <div class="cardBody">
          <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <div style="margin-bottom:6px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                  <div class="muted" style="font-size:11px;">–î–æ —É—Ä–æ–≤–Ω—è ${level + 1}</div>
                  <div style="font-size:12px; font-weight:600;">${progressXP} / ${requiredXP}</div>
                </div>
                <div style="background:var(--border); height:8px; border-radius:999px; overflow:hidden;">
                  <div style="background:linear-gradient(90deg, var(--accent) 0%, var(--ok) 100%); height:100%; width:${percentage}%; transition:width 0.5s;"></div>
                </div>
              </div>
            </div>
            <div style="display:flex; gap:16px;">
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px; margin-bottom:4px;">–°–µ—Ä–∏—è</div>
                <div style="font-size:24px; font-weight:700; color:var(--warn);">${stats.current_streak || 0} üî•</div>
              </div>
              <div style="text-align:center;">
                <div class="muted" style="font-size:11px; margin-bottom:4px;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                <div style="font-size:24px; font-weight:700; color:var(--ok);">${(stats.unlocked_achievements || []).length} üèÜ</div>
              </div>
            </div>
          </div>
          ${recentAchievements.length > 0 ? `
            <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
              <div class="muted" style="font-size:11px; margin-bottom:8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                ${recentAchievements.map(a => `
                  <div class="badge ok" style="font-size:16px;">${a.icon} ${escapeHtml(a.name)}</div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–º–Ω–æ–≥–æ Dashboard
  const dashData = await api.dashboard.getData();
  const smartDashboard = dashData.ok ? dashData.data : null;

  $('#content').innerHTML=`
    <div class="h1">–î–∞—à–±–æ—Ä–¥</div>
    <div class="muted">–í–∞—à –¥–æ–º –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º ‚Ä¢ –í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</div>

    <div class="grid" style="margin-top:12px;">
      ${smartDashboard ? renderSmartDashboardSections(smartDashboard) : ''}
      ${levelWidget}

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
          <span class="badge ${overdueCount > 0 ? 'danger' : ''}">${overdueCount}</span>
        </div>
        <div class="cardBody">
          <div class="muted">–ó–∞–¥–∞—á–∏ + –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
          ${overdueCount > 0 ? `
            <div class="row" style="margin-top:10px; gap:8px;">
              <button class="btn danger" id="goOverdueTasks">–î–µ–ª–∞</button>
              <button class="btn danger" id="goOverdueMaint">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</button>
            </div>
          ` : `<div style="margin-top:10px; color:var(--ok);">‚úì –í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ</div>`}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–°–µ–≥–æ–¥–Ω—è</div>
          <span class="badge">${todayISO()}</span>
        </div>
        <div class="cardBody">
          <div class="muted">–î–µ–ª–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>
          <div class="list" id="todayList" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–°–∫–æ—Ä–æ –æ–±—Å–ª—É–∂–∏—Ç—å</div>
          <span class="badge ${plansSoon.ok && plansSoon.data.length > 0 ? 'warn' : ''}">${plansSoon.ok ? plansSoon.data.length : 0}</span>
        </div>
        <div class="cardBody">
          <div class="muted">–í –±–ª–∏–∂–∞–π—à–∏–µ 14 –¥–Ω–µ–π</div>
          <div class="list" id="soonMaintList" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span>üè†</span>
            <div class="cardTitle">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
          </div>
          <span class="badge">${propertiesData.length}</span>
        </div>
        <div class="cardBody">
          ${propertiesData.length > 0 ? `
            <div class="muted" style="margin-bottom:8px;">–û–±—ä–µ–∫—Ç–æ–≤: ${propertiesData.length}</div>
            <button class="btn" data-dash-route="property">–û—Ç–∫—Ä—ã—Ç—å</button>
          ` : `
            <div class="muted" style="margin-bottom:8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç</div>
            <button class="btn" data-dash-route="property">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          `}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span>üíß</span>
            <div class="cardTitle">–°—á—ë—Ç—á–∏–∫–∏</div>
          </div>
          <span class="badge ${metersNeedingReading.length > 0 ? 'warn' : ''}">${metersNeedingReading.length}</span>
        </div>
        <div class="cardBody">
          ${metersNeedingReading.length > 0 ? `
            <div class="muted" style="margin-bottom:8px;">–ü–æ—Ä–∞ –≤–Ω–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω–∏—è</div>
            <button class="btn warn" data-dash-route="meters">–í–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ</button>
          ` : `
            <div class="muted" style="margin-bottom:8px;">–í—Å–µ–≥–æ: ${metersData.length}</div>
            <button class="btn" data-dash-route="meters">–û—Ç–∫—Ä—ã—Ç—å</button>
          `}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span>üì¶</span>
            <div class="cardTitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
          </div>
          <span class="badge">${inventoryData.length}</span>
        </div>
        <div class="cardBody">
          ${inventoryData.length > 0 ? `
            <div class="muted" style="margin-bottom:8px;">–ü—Ä–µ–¥–º–µ—Ç–æ–≤: ${inventoryData.length}</div>
            ${inventoryData.reduce((sum, i) => sum + (i.purchase_price || 0), 0) > 0 ? `
              <div style="font-size:16px; font-weight:600; margin-bottom:8px;">
                ${inventoryData.reduce((sum, i) => sum + (i.purchase_price || 0), 0).toLocaleString('ru-RU')} ‚ÇΩ
              </div>
            ` : ''}
            <button class="btn" data-dash-route="inventory">–û—Ç–∫—Ä—ã—Ç—å</button>
          ` : `
            <div class="muted" style="margin-bottom:8px;">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div>
            <button class="btn" data-dash-route="inventory">+ –î–æ–±–∞–≤–∏—Ç—å</button>
          `}
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span>üìû</span>
            <div class="cardTitle">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
          </div>
          <span class="badge">${contactsData.length}</span>
        </div>
        <div class="cardBody">
          ${contactsData.filter(c => c.is_favorite).length > 0 ? `
            <div class="muted" style="margin-bottom:8px;">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö: ${contactsData.filter(c => c.is_favorite).length}</div>
          ` : `
            <div class="muted" style="margin-bottom:8px;">–í—Å–µ–≥–æ: ${contactsData.length}</div>
          `}
          <button class="btn" data-dash-route="contacts">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div class="card" id="checklistsWidget">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span>‚úÖ</span>
            <div class="cardTitle">–ß–µ–∫-–ª–∏—Å—Ç—ã</div>
          </div>
          <span class="badge">${checklistsData.length}</span>
        </div>
        <div class="cardBody" id="checklistsMini"></div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <div class="cardHeader">
          <div class="cardTitle">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
        </div>
        <div class="cardBody">
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn" id="quickTask">+ –î–µ–ª–æ</button>
            <button class="btn" id="quickPlan">+ –ü–ª–∞–Ω –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</button>
            <button class="btn" id="quickDoc">+ –î–æ–∫—É–º–µ–Ω—Ç</button>
            <button class="btn" id="quickProperty">+ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</button>
            <button class="btn" id="quickContact">+ –ö–æ–Ω—Ç–∞–∫—Ç</button>
            <button class="btn" id="quickInventory">+ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–¶–µ–ª–∏</div>
          <span class="badge">${goals.ok ? goals.data.length : 0}</span>
        </div>
        <div class="cardBody" id="goalsMini"></div>
      </div>
    </div>
  `;

  // Bind overdue buttons
  if (overdueCount > 0) {
    $('#goOverdueTasks').onclick=()=>{ setRoute('tasks'); renderTasks({ range:'overdue' }); };
    $('#goOverdueMaint').onclick=()=>{ setRoute('maintenance'); renderMaintenance({ range:'overdue' }); };
  }

  // Bind quick action buttons
  $('#quickTask').onclick=()=>openTaskModal();
  $('#quickPlan').onclick=()=>openPlanModal();
  $('#quickDoc').onclick=()=>openDocModal();
  $('#quickProperty').onclick=()=>{ setRoute('property'); renderProperty(); };
  $('#quickContact').onclick=()=>{ setRoute('contacts'); };
  $('#quickInventory').onclick=()=>{ setRoute('inventory'); renderInventory(); };
  // Bind dashboard route buttons (after dynamic inserts)
  const bindDashboardRoutes = () => {
    $$('[data-dash-route]').forEach(b=>b.onclick=()=>setRoute(b.dataset.dashRoute));
  };

  // Today's tasks
  const todayTasks = await api.tasks.list({ profile_id: prof, status:'active', range:'today' });
  const todayEl=$('#todayList');
  if(todayTasks.ok && todayTasks.data.length){
    todayEl.innerHTML=todayTasks.data.slice(0,4).map(itemTaskHtml).join('');
    bindTaskRowActions(todayEl);
  } else todayEl.innerHTML=`<div class="muted">–ù–µ—Ç –¥–µ–ª –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.</div>`;

  // Soon maintenance
  const soonEl=$('#soonMaintList');
  if(plansSoon.ok && plansSoon.data.length){
    soonEl.innerHTML=plansSoon.data.slice(0,4).map(itemPlanMiniHtml).join('');
    bindPlanMiniActions(soonEl);
  } else soonEl.innerHTML=`<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è.</div>`;

  // Checklists progress (only active checklists)
  const checklistsEl = $('#checklistsMini');
  const activeChecklists = checklistsData.filter(cl => cl.is_active !== false);
  if (activeChecklists.length > 0) {
    const checklistsWithProgress = await Promise.all(activeChecklists.slice(0, 2).map(async (cl) => {
      const progRes = await api.checklists.getProgress({ id: cl.id });
      const progress = progRes.ok ? normalizeChecklistProgress(progRes.data, cl) : { completed: [], total: cl.items.length };
      return { ...cl, progress };
    }));

    checklistsEl.innerHTML = checklistsWithProgress.map(cl => {
      const pct = cl.progress.total > 0 ? Math.round((cl.progress.completed.length / cl.progress.total) * 100) : 0;
      return `
        <div style="margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <div style="font-size:13px; font-weight:600;">${escapeHtml(cl.name)}</div>
            <div style="font-size:12px;">${cl.progress.completed.length}/${cl.progress.total}</div>
          </div>
          <div style="background:var(--border); height:6px; border-radius:999px; overflow:hidden;">
            <div style="background:var(--ok); height:100%; width:${pct}%; transition:width 0.3s;"></div>
          </div>
        </div>
      `;
    }).join('');

    checklistsEl.innerHTML += `<button class="btn" data-dash-route="checklists" style="margin-top:8px; width:100%;">–û—Ç–∫—Ä—ã—Ç—å</button>`;
  } else {
    checklistsEl.innerHTML = `
      <div class="muted" style="margin-bottom:8px;">–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–µ–∫-–ª–∏—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
      <button class="btn" data-dash-route="checklists">–û—Ç–∫—Ä—ã—Ç—å</button>
    `;
  }

  bindDashboardRoutes();

  // Goals
  const goalsEl=$('#goalsMini');
  if(goals.ok && goals.data.length){
    goalsEl.innerHTML=goals.data.slice(0,2).map(g=>{
      const pct=g.target_amount?Math.min(100,Math.round((g.saved_amount/g.target_amount)*100)):0;
      return `<div class="item">
        <div class="itemMain">
          <div class="itemTitle">${escapeHtml(g.title)}</div>
          <div class="itemMeta">
            <span class="badge">${g.saved_amount} / ${g.target_amount}</span>
            <span class="badge ok">${pct}%</span>
          </div>
        </div>
        <div class="itemActions">
          <button class="iconBtn" data-goal-open="${g.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      </div>`;
    }).join('');
    $$('[data-goal-open]', goalsEl).forEach(b=>b.onclick=()=>{ setRoute('goals'); renderGoals({ openId:b.dataset.goalOpen }); });
  } else goalsEl.innerHTML=`<div class="muted">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
}

async function renderTasks(presetFilter){
  await api.routines.generate({ daysAhead:14 });
  const filter=Object.assign({ profile_id:state.profileId, status:'active', range:'all', tag_ids:[] }, presetFilter||{});
  $('#content').innerHTML=`
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="h1">–î–µ–ª–∞</div>
        <div class="muted">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á. –ö—Ä–∞—Å–Ω—ã–µ –¥–∞—Ç—ã ‚Äî –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ.</div>
      </div>
      <button class="btn" id="addTaskBtn">+ –î–µ–ª–æ</button>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row">
        <select id="taskStatus">
          <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="done">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</option>
          <option value="all">–í—Å–µ</option>
        </select>
        <select id="taskRange">
          <option value="all">–í—Å—ë</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="week">–ù–µ–¥–µ–ª—è</option>
          <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
        </select>
        <input class="input" id="taskQ" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–¥–∞—á–∞–º..." />
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="taskShowDone" />
          <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</span>
        </label>
      </div>
      <div style="margin-top:10px;" id="taskTags"></div>
    </div>

    <div class="list" id="taskList" style="margin-top:12px;"></div>
  `;
  $('#addTaskBtn').onclick=()=>openTaskModal();
  $('#taskStatus').value=filter.status;
  $('#taskRange').value=filter.range;
  $('#taskShowDone').checked = filter.status !== 'active';

  const tagWrap=$('#taskTags');
  tagWrap.innerHTML=tagPickerHtml([]);
  $('#addTagBtn', tagWrap).onclick=async ()=>{
    const name=$('#newTagName', tagWrap).value.trim(); if(!name) return;
    const r=await api.tags.create({ name }); if(!r.ok) return toast(r.error, 'error');
    await loadTags(); render();
  };
  $('#newTagName', tagWrap).onkeydown=(e)=>{ if(e.key==='Enter') $('#addTagBtn', tagWrap).click(); };

  async function refresh(){
    const tag_ids=readTagPicker(tagWrap);
    const q=$('#taskQ').value.trim();
    const status=$('#taskStatus').value;
    const range=$('#taskRange').value;

    const r=await api.tasks.list({ profile_id:state.profileId, status, range, tag_ids, q });
    const listEl=$('#taskList');
    if(!r.ok) return listEl.innerHTML=`<div class="muted">${escapeHtml(r.error)}</div>`;
    if(!r.data.length) return listEl.innerHTML=`<div class="muted">–ü—É—Å—Ç–æ.</div>`;
    listEl.innerHTML=r.data.map(itemTaskHtml).join('');
    bindTaskRowActions(listEl);
  }

  $('#taskStatus').onchange=()=>{
    $('#taskShowDone').checked = $('#taskStatus').value !== 'active';
    refresh();
  };
  $('#taskShowDone').onchange=()=>{
    $('#taskStatus').value = $('#taskShowDone').checked ? 'all' : 'active';
    refresh();
  };
  $('#taskRange').onchange=refresh;
  $('#taskQ').oninput=()=>{ clearTimeout(refresh._t); refresh._t=setTimeout(refresh, 200); };
  $$('input[type="checkbox"]', tagWrap).forEach(ch=>ch.onchange=refresh);

  await refresh();
}

async function openTaskModal(existing){
  const t = existing || { title:'', description:'', due_at:'', priority:'med', profile_id: state.profileId==='all'?null:state.profileId, tag_ids:[] };
  openModal(existing?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ª–æ':'–ù–æ–≤–æ–µ –¥–µ–ª–æ', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="tTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(t.title)}" />
        <select id="tPriority">
          <option value="low">–Ω–∏–∑–∫–∏–π</option>
          <option value="med">—Å—Ä–µ–¥–Ω–∏–π</option>
          <option value="high">–≤—ã—Å–æ–∫–∏–π</option>
        </select>
      </div>
      <textarea class="input" id="tDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">${escapeHtml(t.description||'')}</textarea>
      <div class="formRow">
        <input type="date" class="input" id="tDue" placeholder="–°—Ä–æ–∫" value="${escapeHtml(t.due_at||'')}" />
        <select id="tProfile"></select>
      </div>
      <div id="tTags"></div>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn" id="saveTask">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `, (root)=>{
    $('#tPriority', root).value=t.priority||'med';
    const pSel=$('#tProfile', root);
    pSel.innerHTML=[{id:'',name:'‚Äî'}, ...state.profiles.filter(p=>!p.is_archived)]
      .map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    pSel.value=t.profile_id||'';

    const tagsRoot=$('#tTags', root);
    tagsRoot.innerHTML=tagPickerHtml(t.tag_ids||[]);
    $('#addTagBtn', tagsRoot).onclick=async ()=>{
      const name=$('#newTagName', tagsRoot).value.trim(); if(!name) return;
      const r=await api.tags.create({ name }); if(!r.ok) return toast(r.error, 'error');
      await loadTags(); closeModal(); openTaskModal(existing);
    };
    $('#newTagName', tagsRoot).onkeydown=(e)=>{ if(e.key==='Enter') $('#addTagBtn', tagsRoot).click(); };

    $('#saveTask', root).onclick=async ()=>{
      const title=$('#tTitle', root).value.trim();
      const description=$('#tDesc', root).value.trim();
      const due_at=$('#tDue', root).value.trim() || null;
      const priority=$('#tPriority', root).value;
      const profile_id=pSel.value || null;
      const tag_ids=readTagPicker(tagsRoot);
      if(!title) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');

      if(existing){
        const r=await api.tasks.update({ id: existing.id, patch:{ title, description, due_at, priority, profile_id, tag_ids }});
        if(!r.ok) return toast(r.error, 'error');
      } else {
        const r=await api.tasks.create({ title, description, due_at, priority, profile_id, tag_ids });
        if(!r.ok) return toast(r.error, 'error');
      }
      closeModal(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); render();
    };
  });
}

function itemPlanMiniHtml(p){
  const today=todayISO();
  const overdue=p.next_due_at < today;
  const badgeClass=overdue?'danger':(daysDiff(today,p.next_due_at)<=7?'warn':'');
  return `
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(p.title)}</div>
        <div class="itemMeta"><span class="badge ${badgeClass}">${p.next_due_at}</span></div>
      </div>
      <div class="itemActions"><button class="iconBtn" data-plan-done="${p.id}">‚úì</button></div>
    </div>
  `;
}
function bindPlanMiniActions(root){
  $$('[data-plan-done]', root).forEach(b=>b.onclick=()=>openLogModal(b.dataset.planDone));
}
function planCardHtml(p){
  const today=todayISO();
  const overdue=p.next_due_at < today;
  const diff=daysDiff(today,p.next_due_at);
  const badgeClass=overdue?'danger':(diff<=7?'warn':'ok');
  const hint=overdue?`–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(diff)}–¥`:(diff===0?'—Å–µ–≥–æ–¥–Ω—è':`—á–µ—Ä–µ–∑ ${diff}–¥`);
  return `
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(p.title)}</div>
        <div class="itemMeta">
          <span class="badge ${badgeClass}">${p.next_due_at}</span>
          <span class="badge">${hint}</span>
        </div>
      </div>
      <div class="itemActions">
        <button class="iconBtn" data-plan-done="${p.id}">‚úì</button>
        <button class="iconBtn" data-plan-edit="${p.id}">‚úé</button>
        <button class="iconBtn" data-plan-del="${p.id}">üóë</button>
      </div>
    </div>
  `;
}
function bindPlanActions(root){
  $$('[data-plan-done]', root).forEach(b=>b.onclick=()=>openLogModal(b.dataset.planDone));
  $$('[data-plan-edit]', root).forEach(b=>b.onclick=async ()=>{
    const all=await api.maintenance.plans.list({ range:'all', daysSoon:14, is_active:true });
    const p=all.ok ? all.data.find(x=>x.id===b.dataset.planEdit) : null;
    if(p) openPlanModal(p);
  });
  $$('[data-plan-del]', root).forEach(b=>b.onclick=async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–ª–∞–Ω –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏?')) return;
    const r=await api.maintenance.plans.delete({ id:b.dataset.planDel });
    if(!r.ok) return toast(r.error, 'error');
    toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); render();
  });
}

function logRowHtml(l){
  const cost=(l.cost??null)!==null ? `<span class="badge">${l.cost} ‚ÇΩ</span>` : '';
  return `
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(l.done_at)}</div>
        <div class="itemMeta">
          ${cost}
          ${l.note ? `<span class="badge">${escapeHtml(l.note)}</span>`:''}
        </div>
      </div>
      <div class="itemActions"><button class="iconBtn" data-log-del="${l.id}">üóë</button></div>
    </div>
  `;
}
function bindLogActions(root){
  $$('[data-log-del]', root).forEach(b=>b.onclick=async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    const r=await api.maintenance.logs.delete({ id:b.dataset.logDel });
    if(!r.ok) return toast(r.error, 'error');
    toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); render();
  });
}

async function renderMaintenance(preset){
  $('#content').innerHTML=`
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="h1">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
        <div class="muted">–ü–ª–∞–Ω—ã –ø–æ –¥–∞—Ç–∞–º –∏ –∂—É—Ä–Ω–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π.</div>
      </div>
      <div class="row">
        <button class="btn" id="addAssetBtn">+ –û–±—ä–µ–∫—Ç</button>
        <button class="btn" id="addPlanBtn">+ –ü–ª–∞–Ω</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row">
        <select id="maintRange">
          <option value="all">–í—Å–µ</option>
          <option value="soon">–°–∫–æ—Ä–æ (14 –¥–Ω–µ–π)</option>
          <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</option>
        </select>
        <select id="maintAsset"></select>
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="maintShowInactive" />
          <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</span>
        </label>
        <button class="btn" id="refreshMaint">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ü–ª–∞–Ω—ã</div>
          <span class="badge" id="planCount">‚Äî</span>
        </div>
        <div class="cardBody"><div class="list" id="planList"></div></div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <div class="cardHeader">
          <div class="cardTitle">–ñ—É—Ä–Ω–∞–ª</div>
          <span class="badge" id="logCount">‚Äî</span>
        </div>
        <div class="cardBody"><div class="list" id="logList"></div></div>
      </div>
    </div>
  `;
  $('#addAssetBtn').onclick=()=>openAssetModal();
  $('#addPlanBtn').onclick=()=>openPlanModal();
  const assetsR=await api.assets.list();
  if(!assetsR.ok) return toast(assetsR.error);
  const assets=assetsR.data;
  const assetSel=$('#maintAsset');
  assetSel.innerHTML=`<option value="">–í—Å–µ –æ–±—ä–µ–∫—Ç—ã</option>` + assets.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
  const rangeSel=$('#maintRange');
  if(preset?.range) rangeSel.value=preset.range;
  const showInactive = $('#maintShowInactive');
  if(showInactive) showInactive.checked = !!state.maintenanceShowInactive;

  async function refresh(){
    const range=rangeSel.value;
    const asset_id=assetSel.value || null;
    const is_active = showInactive && showInactive.checked ? undefined : true;
    const plansR=await api.maintenance.plans.list({ range, daysSoon:14, asset_id, is_active });
    const logsR=await api.maintenance.logs.list({ asset_id });

    const planList=$('#planList');
    if(!plansR.ok) planList.innerHTML=`<div class="muted">${escapeHtml(plansR.error)}</div>`;
    else {
      $('#planCount').textContent=String(plansR.data.length);
      planList.innerHTML = plansR.data.length ? plansR.data.map(planCardHtml).join('') : `<div class="muted">–ü–ª–∞–Ω–æ–≤ –Ω–µ—Ç.</div>`;
      bindPlanActions(planList);
    }

    const logList=$('#logList');
    if(!logsR.ok) logList.innerHTML=`<div class="muted">${escapeHtml(logsR.error)}</div>`;
    else {
      $('#logCount').textContent=String(logsR.data.length);
      logList.innerHTML = logsR.data.length ? logsR.data.slice(0,30).map(logRowHtml).join('') : `<div class="muted">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>`;
      bindLogActions(logList);
    }
  }

  $('#refreshMaint').onclick=refresh;
  rangeSel.onchange=refresh;
  assetSel.onchange=refresh;
  if(showInactive) showInactive.onchange=()=>{
    state.maintenanceShowInactive = showInactive.checked;
    refresh();
  };
  await refresh();
}

async function openAssetModal(existing){
  const a=existing || { name:'', type:'home', note:'' };
  openModal(existing?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç':'–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="aName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–î–æ–º, –ê–≤—Ç–æ, –§–∏–ª—å—Ç—Ä...)" value="${escapeHtml(a.name)}" />
        <select id="aType">
          <option value="home">–î–æ–º</option>
          <option value="car">–ê–≤—Ç–æ</option>
          <option value="appliance">–¢–µ—Ö–Ω–∏–∫–∞</option>
          <option value="filter">–§–∏–ª—å—Ç—Ä</option>
          <option value="other">–î—Ä—É–≥–æ–µ</option>
        </select>
      </div>
      <textarea class="input" id="aNote" placeholder="–ó–∞–º–µ—Ç–∫–∞">${escapeHtml(a.note||'')}</textarea>
      <div class="row" style="justify-content:${existing ? 'space-between' : 'flex-end'};">
        ${existing ? '<button class="btn danger" id="delAsset">–£–¥–∞–ª–∏—Ç—å</button>' : ''}
        <button class="btn" id="saveAsset">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `, (root)=>{
    $('#aType', root).value=a.type||'home';
    $('#saveAsset', root).onclick=async ()=>{
      const name=$('#aName', root).value.trim();
      const type=$('#aType', root).value;
      const note=$('#aNote', root).value.trim();
      if(!name) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');
      if(existing){
        const r=await api.assets.update({ id:existing.id, patch:{ name, type, note }});
        if(!r.ok) return toast(r.error, 'error');
      } else {
        const r=await api.assets.create({ name, type, note });
        if(!r.ok) return toast(r.error, 'error');
      }
      closeModal(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      if(state.route === 'asset-detail') renderAssetDetail();
      else if(state.route === 'assets') renderAssets();
      else render();
    };
    if(existing){
      const delBtn = $('#delAsset', root);
      if(delBtn){
        delBtn.onclick=async ()=>{
          if(!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç? –í—Å–µ –ø–ª–∞–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ –∂—É—Ä–Ω–∞–ª—ã —Ç–æ–∂–µ —É–¥–∞–ª—è—Ç—Å—è.')) return;
          const r=await api.assets.delete({ id:existing.id });
          if(!r.ok) return toast(r.error, 'error');
          closeModal(); toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
          if(state.route === 'asset-detail') setRoute('assets');
          else if(state.route === 'assets') renderAssets();
          else render();
        };
      }
    }
  });
}

async function openPlanModal(existing){
  const assetsR=await api.assets.list();
  if(!assetsR.ok) return toast(assetsR.error);
  const assets=assetsR.data;
  const isEdit = Boolean(existing?.id);
  const p = isEdit
    ? existing
    : { asset_id: existing?.asset_id || assets[0]?.id, title:'', interval_days:90, last_done_at:'', expected_cost:'', note:'', next_due_at:'' };

  openModal(isEdit?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω':'–ù–æ–≤—ã–π –ø–ª–∞–Ω', `
    <div class="form">
      <div class="formRow">
        <select id="pAsset"></select>
        <input class="input" id="pTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ó–∞–º–µ–Ω–∞ –∫–∞—Ä—Ç—Ä–∏–¥–∂–∞...)" value="${escapeHtml(p.title)}" />
      </div>
      <div class="formRow">
        <input class="input" id="pInterval" placeholder="–ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–Ω–µ–π" value="${escapeHtml(String(p.interval_days||90))}" />
        <input type="date" class="input" id="pLast" placeholder="–ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ" value="${escapeHtml(p.last_done_at||'')}" />
      </div>
      <div class="formRow">
        <input class="input" id="pCost" placeholder="–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–æ–ø—Ü.)" value="${escapeHtml(p.expected_cost ?? '')}" />
        <input type="date" class="input" id="pNext" placeholder="–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ (–æ–ø—Ü.)" value="${escapeHtml(p.next_due_at||'')}" />
      </div>
      <textarea class="input" id="pNote" placeholder="–ó–∞–º–µ—Ç–∫–∞">${escapeHtml(p.note||'')}</textarea>
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="savePlan">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    const aSel=$('#pAsset', root);
    aSel.innerHTML = assets.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
    aSel.value = p.asset_id || assets[0]?.id;

    $('#savePlan', root).onclick=async ()=>{
      const asset_id=aSel.value;
      const title=$('#pTitle', root).value.trim();
      const interval_days=Number($('#pInterval', root).value.trim()||0);
      const last_done_at=$('#pLast', root).value.trim()||null;
      const expected_cost=$('#pCost', root).value.trim();
      const next_due_at=$('#pNext', root).value.trim()||null;
      const note=$('#pNote', root).value.trim();
      if(!asset_id) return toast('–ù—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç', 'warning');
      if(!title) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');
      if(!interval_days || interval_days<1) return toast('–ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 1', 'warning');

      const payload={ asset_id, title, interval_days, last_done_at, expected_cost: expected_cost?Number(expected_cost):null, next_due_at, note };
      if(isEdit){
        const r=await api.maintenance.plans.update({ id: p.id, patch: payload });
        if(!r.ok) return toast(r.error, 'error');
      } else {
        const r=await api.maintenance.plans.create(payload);
        if(!r.ok) return toast(r.error, 'error');
      }
      closeModal(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); render();
    };
  });
}

async function openLogModal(planId){
  const plansR=await api.maintenance.plans.list({ range:'all', daysSoon:14, is_active:true });
  if(!plansR.ok) return toast(plansR.error);
  const plan=plansR.data.find(p=>p.id===planId);
  if(!plan) return toast('–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');

  openModal('–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º', `
    <div class="form">
      <div class="card">
        <div class="cardTitle">${escapeHtml(plan.title)}</div>
        <div class="muted" style="margin-top:6px;">–°–ª–µ–¥—É—é—â–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      </div>
      <div class="formRow">
        <input type="date" class="input" id="lDate" placeholder="–î–∞—Ç–∞" value="${todayISO()}" />
        <input class="input" id="lCost" placeholder="–°—Ç–æ–∏–º–æ—Å—Ç—å (–æ–ø—Ü.)" />
      </div>
      <textarea class="input" id="lNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)"></textarea>
      <label class="row" style="gap:8px;">
        <input type="checkbox" id="lCreateExpense" checked />
        <span class="muted">–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å)</span>
      </label>
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveLog">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#saveLog', root).onclick=async ()=>{
      const done_at=$('#lDate', root).value.trim() || todayISO();
      const costRaw=$('#lCost', root).value.trim();
      const cost=costRaw ? Number(costRaw) : null;
      const note=$('#lNote', root).value.trim();
      const create_expense=$('#lCreateExpense', root).checked && cost!==null;
      const r=await api.maintenance.logs.create({ plan_id: plan.id, done_at, cost, note, create_expense });
      if(!r.ok) return toast(r.error, 'error');

      // Gamification for maintenance log
      await updateStreak();
      await awardXP(10, '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ');
      checkAchievementsDebounced();

      closeModal(); toast('–ó–∞–ø–∏—Å–∞–Ω–æ', 'success'); render();
    };
  });
}

function goalRowHtml(g){
  const pct=g.target_amount?Math.min(100,Math.round((g.saved_amount/g.target_amount)*100)):0;
  const badgeClass=g.status==='active'?'ok':'';
  return `
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(g.title)}</div>
        <div class="itemMeta">
          <span class="badge ${badgeClass}">${g.saved_amount} / ${g.target_amount}</span>
          <span class="badge">${pct}%</span>
          ${g.due_at ? `<span class="badge">${g.due_at}</span>`:''}
        </div>
      </div>
      <div class="itemActions">
        <button class="iconBtn" data-goal-add="${g.id}">+–≤–∑–Ω–æ—Å</button>
        <button class="iconBtn" data-goal-open="${g.id}">‚úé</button>
        <button class="iconBtn" data-goal-del="${g.id}">üóë</button>
      </div>
    </div>
  `;
}

// ========== ASSETS (–û–±—ä–µ–∫—Ç—ã) ==========

async function renderAssets(){
  const assetsR = await api.assets.list();
  if(!assetsR.ok) return toast(assetsR.error, 'error');
  const assets = assetsR.data;

  $('#content').innerHTML=`
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="h1">–û–±—ä–µ–∫—Ç—ã</div>
        <div class="muted">–î–æ–º/–ê–≤—Ç–æ/–§–∏–ª—å—Ç—Ä—ã/–¢–µ—Ö–Ω–∏–∫–∞ ‚Äî –≤—Å—è –∏–Ω—Ñ–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –æ–±—ä–µ–∫—Ç–∞.</div>
      </div>
      <button class="btn" id="addAssetBtn">+ –û–±—ä–µ–∫—Ç</button>
    </div>

    <div class="grid" style="margin-top:16px;" id="assetCards"></div>
  `;

  $('#addAssetBtn').onclick = () => openAssetModal();

  const assetCards = $('#assetCards');
  if (assets.length === 0) {
    assetCards.innerHTML = '<div class="card"><div class="cardBody muted">–û–±—ä–µ–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç.</div></div>';
    return;
  }

  assetCards.innerHTML = assets.map(asset => {
    const typeIcon = {
      'home': 'üè†',
      'car': 'üöó',
      'appliance': 'üîß',
      'filter': 'üíß',
      'other': 'üì¶'
    }[asset.type] || 'üì¶';

    return `
      <div class="card" style="cursor:pointer;" data-asset-id="${asset.id}">
        <div class="cardHeader">
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="font-size:24px;">${typeIcon}</span>
            <div class="cardTitle">${escapeHtml(asset.name)}</div>
          </div>
          <span class="badge ok">Ok</span>
        </div>
        <div class="cardBody">
          ${asset.note ? `<div class="muted" style="margin-bottom:10px;">${escapeHtml(asset.note)}</div>` : ''}
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="muted" id="assetPlansCount${asset.id}">–ü–ª–∞–Ω—ã: ‚Äî</div>
            <button class="btn" data-asset-open="${asset.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–ª–∞–Ω–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
  assets.forEach(async (asset) => {
    const plansR = await api.maintenance.plans.list({ asset_id: asset.id });
    if (plansR.ok) {
      const countEl = $('#assetPlansCount' + asset.id);
      if (countEl) {
        countEl.textContent = `–ü–ª–∞–Ω—ã: ${plansR.data.length}`;
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
  $$('[data-asset-open]').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const assetId = btn.dataset.assetOpen;
      state.selectedAssetId = assetId;
      setRoute('asset-detail');
    };
  });

  // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏
  $$('[data-asset-id]').forEach(card => {
    card.onclick = () => {
      const assetId = card.dataset.assetId;
      state.selectedAssetId = assetId;
      setRoute('asset-detail');
    };
  });
}

async function renderAssetDetail(){
  const assetId = state.selectedAssetId;
  if (!assetId) {
    setRoute('assets');
    return;
  }

  const assetR = await api.assets.get({ id: assetId });
  if (!assetR.ok) {
    toast(assetR.error, 'error');
    setRoute('assets');
    return;
  }

  const asset = assetR.data.asset || assetR.data;
  const typeIcon = {
    'home': 'üè†',
    'car': 'üöó',
    'appliance': 'üîß',
    'filter': 'üíß',
    'other': 'üì¶'
  }[asset.type] || 'üì¶';

  $('#content').innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <button class="btn" id="backToAssets">‚Üê –ö –æ–±—ä–µ–∫—Ç–∞–º</button>
      </div>
      <div class="row">
        <button class="btn" id="editAssetBtn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" id="addPlanBtn">+ –ü–ª–∞–Ω</button>
        <button class="btn" id="addDocumentBtn">+ –î–æ–∫—É–º–µ–Ω—Ç</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="cardHeader">
        <div style="display:flex; align-items:center; gap:12px;">
          <span style="font-size:32px;">${typeIcon}</span>
          <div>
            <div class="h1" style="margin:0;">${escapeHtml(asset.name)}</div>
            <div class="muted">${{home:'–î–æ–º',car:'–ê–≤—Ç–æ',appliance:'–¢–µ—Ö–Ω–∏–∫–∞',filter:'–§–∏–ª—å—Ç—Ä',other:'–î—Ä—É–≥–æ–µ'}[asset.type] || asset.type}</div>
          </div>
        </div>
      </div>
      ${asset.note ? `<div class="cardBody"><div>${escapeHtml(asset.note)}</div></div>` : ''}
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ü–ª–∞–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</div>
          <span class="badge" id="planCount">‚Äî</span>
        </div>
        <div class="cardBody"><div class="list" id="planList"></div></div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <div class="cardHeader">
          <div class="cardTitle">–ñ—É—Ä–Ω–∞–ª</div>
          <span class="badge" id="logCount">‚Äî</span>
        </div>
        <div class="cardBody"><div class="list" id="logList"></div></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="cardHeader">
        <div class="cardTitle">–î–æ–∫—É–º–µ–Ω—Ç—ã –æ–±—ä–µ–∫—Ç–∞</div>
        <span class="badge" id="docCount">‚Äî</span>
      </div>
      <div class="cardBody"><div class="list" id="docList"></div></div>
    </div>
  `;

  $('#backToAssets').onclick = () => setRoute('assets');
  $('#editAssetBtn').onclick = () => openAssetModal(asset);
  $('#addPlanBtn').onclick = () => openPlanModal({ asset_id: assetId });
  $('#addDocumentBtn').onclick = async () => {
    const fileR = await api.documents.pickFile();
    if (!fileR.ok) return;
    const attachR = await api.documents.attach({
      file_path: fileR.data.path,
      title: fileR.data.name,
      link: `asset:${assetId}`,
      tag_ids: []
    });
    if (!attachR.ok) return toast(attachR.error, 'error');
    toast('–î–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
    renderAssetDetail();
  };

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–æ–≤
  const plansR = await api.maintenance.plans.list({ asset_id: assetId });
  const planList = $('#planList');
  if (!plansR.ok) {
    planList.innerHTML = `<div class="muted">${escapeHtml(plansR.error)}</div>`;
  } else {
    $('#planCount').textContent = String(plansR.data.length);
    planList.innerHTML = plansR.data.length
      ? plansR.data.map(planCardHtml).join('')
      : `<div class="muted">–ü–ª–∞–Ω–æ–≤ –Ω–µ—Ç.</div>`;
    bindPlanActions(planList);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞
  const logsR = await api.maintenance.logs.list({ asset_id: assetId });
  const logList = $('#logList');
  if (!logsR.ok) {
    logList.innerHTML = `<div class="muted">${escapeHtml(logsR.error)}</div>`;
  } else {
    $('#logCount').textContent = String(logsR.data.length);
    logList.innerHTML = logsR.data.length
      ? logsR.data.slice(0, 20).map(logRowHtml).join('')
      : `<div class="muted">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</div>`;
    bindLogActions(logList);
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  const docsR = await api.documents.list({ link: `asset:${assetId}` });
  const docList = $('#docList');
  if (!docsR.ok) {
    docList.innerHTML = `<div class="muted">${escapeHtml(docsR.error)}</div>`;
  } else {
    $('#docCount').textContent = String(docsR.data.length);
    docList.innerHTML = docsR.data.length
      ? docsR.data.map(doc => `
          <div class="item">
            <div class="itemMain">
              <div class="itemTitle">${escapeHtml(doc.title)}</div>
              <div class="itemMeta">
                <span class="muted">${doc.created_at}</span>
              </div>
            </div>
            <div class="itemActions">
              <button class="iconBtn" data-doc-open="${doc.id}">üìÑ</button>
              <button class="iconBtn" data-doc-del="${doc.id}">üóë</button>
            </div>
          </div>
        `).join('')
      : `<div class="muted">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.</div>`;

    $$('[data-doc-open]', docList).forEach(b => {
      b.onclick = async () => {
        const r = await api.documents.open({ id: b.dataset.docOpen });
        if (!r.ok) toast(r.error, 'error');
      };
    });

    $$('[data-doc-del]', docList).forEach(b => {
      b.onclick = async () => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç? (—Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –ø–∞–ø–∫–µ –≤–ª–æ–∂–µ–Ω–∏–π)')) return;
        const r = await api.documents.delete({ id: b.dataset.docDel });
        if (!r.ok) return toast(r.error, 'error');
        toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
        renderAssetDetail();
      };
    });
  }
}

async function renderGoals(opts){
  const showArchived = !!state.goalsShowArchived;
  const r=await api.goals.list({ status: showArchived ? 'all' : 'active' });
  $('#content').innerHTML=`
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="h1">–¶–µ–ª–∏/–ø–æ–∫—É–ø–∫–∏</div>
        <div class="muted">–ü—Ä–æ—Å—Ç—ã–µ —Ü–µ–ª–∏: —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –∏ —Å–∫–æ–ª—å–∫–æ —É–∂–µ –≤–Ω–µ—Å–µ–Ω–æ.</div>
      </div>
      <div class="row" style="gap:8px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="goalsShowArchived" ${showArchived ? 'checked' : ''} />
          <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–µ</span>
        </label>
        <button class="btn" id="addGoalBtn">+ –¶–µ–ª—å</button>
      </div>
    </div>
    <div class="list" id="goalList" style="margin-top:12px;"></div>
  `;
  $('#addGoalBtn').onclick=()=>openGoalModal();
  $('#goalsShowArchived').onchange=()=>{
    state.goalsShowArchived = $('#goalsShowArchived').checked;
    renderGoals();
  };
  const list=$('#goalList');
  if(!r.ok) return list.innerHTML=`<div class="muted">${escapeHtml(r.error)}</div>`;
  if(!r.data.length) return list.innerHTML=`<div class="muted">–¶–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
  list.innerHTML=r.data.map(goalRowHtml).join('');
  $$('[data-goal-open]', list).forEach(b=>b.onclick=()=>openGoalModal(r.data.find(x=>x.id===b.dataset.goalOpen)));
  $$('[data-goal-add]', list).forEach(b=>b.onclick=()=>openContributionModal(b.dataset.goalAdd));
  $$('[data-goal-del]', list).forEach(b=>b.onclick=async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?')) return;
    const rr=await api.goals.update({ id:b.dataset.goalDel, patch:{ status:'archived' }});
    if(!rr.ok) return toast(rr.error);
    toast('–°–∫—Ä—ã—Ç–æ (archived)'); render();
  });
  if(opts?.openId){
    const g=r.data.find(x=>x.id===opts.openId);
    if(g) openGoalModal(g);
  }
}
function openGoalModal(existing){
  const g=existing || { title:'', target_amount:0, saved_amount:0, due_at:'', status:'active', note:'' };
  openModal(existing?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å':'–ù–æ–≤–∞—è —Ü–µ–ª—å', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="gTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(g.title)}" />
        <input class="input" id="gTarget" placeholder="–°—É–º–º–∞" value="${escapeHtml(String(g.target_amount||0))}" />
      </div>
      <div class="formRow">
        <input class="input" id="gSaved" placeholder="–£–∂–µ –≤–Ω–µ—Å–µ–Ω–æ" value="${escapeHtml(String(g.saved_amount||0))}" />
        <input type="date" class="input" id="gDue" placeholder="–°—Ä–æ–∫ (–æ–ø—Ü.)" value="${escapeHtml(g.due_at||'')}" />
      </div>
      <textarea class="input" id="gNote" placeholder="–ó–∞–º–µ—Ç–∫–∞">${escapeHtml(g.note||'')}</textarea>
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveGoal">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#saveGoal', root).onclick=async ()=>{
      const title=$('#gTitle', root).value.trim();
      const target_amount=Number($('#gTarget', root).value.trim()||0);
      const saved_amount=Number($('#gSaved', root).value.trim()||0);
      const due_at=$('#gDue', root).value.trim()||null;
      const note=$('#gNote', root).value.trim();
      if(!title) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');
      const payload={ title, target_amount, saved_amount, due_at, note, status:g.status||'active' };
      if(existing){
        const r=await api.goals.update({ id: existing.id, patch: payload });
        if(!r.ok) return toast(r.error, 'error');
      } else {
        const r=await api.goals.create(payload);
        if(!r.ok) return toast(r.error, 'error');
      }
      closeModal(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); render();
    };
  });
}
function openContributionModal(goalId){
  openModal('–í–Ω–µ—Å—Ç–∏ –≤ —Ü–µ–ª—å', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="cAmount" placeholder="–°—É–º–º–∞" />
        <input type="date" class="input" id="cDate" placeholder="–î–∞—Ç–∞" value="${todayISO()}" />
      </div>
      <input class="input" id="cNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü.)" />
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveContrib">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#saveContrib', root).onclick=async ()=>{
      const amount=Number($('#cAmount', root).value.trim()||0);
      const date=$('#cDate', root).value.trim()||todayISO();
      const note=$('#cNote', root).value.trim();
      if(!amount) return toast('–ù—É–∂–Ω–∞ —Å—É–º–º–∞', 'warning');
      const r=await api.goals.addContribution({ goal_id:goalId, amount, date, note });
      if(!r.ok) return toast(r.error, 'error');

      // Check if goal is achieved
      const updatedGoal = r.data;
      if (updatedGoal && updatedGoal.saved_amount >= updatedGoal.target_amount && updatedGoal.status === 'active') {
        // Mark goal as achieved
        await api.goals.setStatus({ id: goalId, status: 'achieved' });

        // Award XP
        await updateStreak();
        await awardXP(50, '–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!');

        // Check for first_goal achievement
        checkAchievementsDebounced();

        toast('üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!', 'success');
      } else {
        toast('–ó–∞–ø–∏—Å–∞–Ω–æ', 'success');
      }

      closeModal(); render();
    };
  });
}

function docRowHtml(d){
  const tags=(d.tag_ids||[]).map(id=>state.tags.find(t=>t.id===id)?.name).filter(Boolean).slice(0,3);
  return `
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(d.title || d.file_name)}</div>
        <div class="itemMeta">
          <span class="badge">${escapeHtml(d.file_ext || '')}</span>
          ${tags.map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('')}
        </div>
      </div>
      <div class="itemActions">
        <button class="iconBtn" data-doc-open="${d.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="iconBtn" data-doc-del="${d.id}">üóë</button>
      </div>
    </div>
  `;

}
async function renderDocuments(){
  $('#content').innerHTML=`
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="h1">–î–æ–∫—É–º–µ–Ω—Ç—ã</div>
        <div class="muted">–§–∞–π–ª—ã + —Ç–µ–≥–∏. –í—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ.</div>
      </div>
      <button class="btn" id="addDocBtn">+ –î–æ–∫—É–º–µ–Ω—Ç</button>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="row">
        <input class="input" id="docQ" placeholder="–ü–æ–∏—Å–∫..." />
        <button class="btn" id="docRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
    <div class="list" id="docList" style="margin-top:12px;"></div>
  `;
  $('#addDocBtn').onclick=()=>openDocModal();
  $('#docRefresh').onclick=()=>refreshDocs();
  $('#docQ').oninput=()=>{ clearTimeout(refreshDocs._t); refreshDocs._t=setTimeout(refreshDocs,200); };

  async function refreshDocs(){
    const q=$('#docQ').value.trim();
    const r=await api.documents.list({ q });
    const list=$('#docList');
    if(!r.ok) return list.innerHTML=`<div class="muted">${escapeHtml(r.error)}</div>`;
    if(!r.data.length) return list.innerHTML=`<div class="muted">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç.</div>`;
    list.innerHTML=r.data.slice(0,60).map(docRowHtml).join('');
    $$('[data-doc-open]', list).forEach(b=>b.onclick=async ()=>{
      const rr=await api.documents.open({ id:b.dataset.docOpen });
      if(!rr.ok) toast(rr.error);
    });
    $$('[data-doc-del]', list).forEach(b=>b.onclick=async ()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç? (—Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –ø–∞–ø–∫–µ –≤–ª–æ–∂–µ–Ω–∏–π)')) return;
      const rr=await api.documents.delete({ id:b.dataset.docDel });
      if(!rr.ok) return toast(rr.error);
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); refreshDocs();
    });
  }

  await refreshDocs();
}
async function openDocModal(){
  const picked=await api.documents.pickFile();
  if(!picked.ok) return toast(picked.error);
  if(!picked.data) return;
  const info=picked.data;

  openModal('–î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç', `
    <div class="form">
      <div class="card">
        <div class="cardTitle">${escapeHtml(info.fileName)}</div>
        <div class="muted" style="margin-top:6px;">–§–∞–π–ª –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</div>
      </div>
      <input class="input" id="dTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(info.fileName)}" />
      <div id="dTags"></div>
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveDoc">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    const tagsRoot=$('#dTags', root);
    tagsRoot.innerHTML=tagPickerHtml([]);
    $('#addTagBtn', tagsRoot).onclick=async ()=>{
      const name=$('#newTagName', tagsRoot).value.trim(); if(!name) return;
      const r=await api.tags.create({ name }); if(!r.ok) return toast(r.error, 'error');
      await loadTags(); closeModal(); openDocModal();
    };
    $('#newTagName', tagsRoot).onkeydown=(e)=>{ if(e.key==='Enter') $('#addTagBtn', tagsRoot).click(); };

    $('#saveDoc', root).onclick=async ()=>{
      const title=$('#dTitle', root).value.trim();
      const tag_ids=readTagPicker(tagsRoot);
      const r=await api.documents.attach({ tempPath: info.tempPath, fileName: info.fileName, title, tag_ids, linked:null });
      if(!r.ok) return toast(r.error, 'error');
      closeModal(); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ', 'success'); renderDocuments();
    };
  });
}

async function renderNotificationSettings() {
  const r = await api.notifications.getSettings();
  if (!r.ok) {
    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
    return '';
  }

  const s = r.data;

  return `
    <div class="cardHeader">
      <div class="cardTitle">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
    </div>
    <div class="cardBody">
      <div class="setting-row" style="margin-bottom:12px;">
        <label style="display:flex; align-items:center;">
          <input type="checkbox" id="notif-enabled" ${s.enabled ? 'checked' : ''} style="margin-right:8px;">
          –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </label>
      </div>

      <div class="setting-row" style="margin-bottom:12px;">
        <label style="margin-bottom:4px; display:block;">–¢–∏—Ö–∏–µ —á–∞—Å—ã:</label>
        <div style="display:flex; align-items:center; gap:8px;">
          <input type="number" id="notif-quiet-start" value="${s.quiet_start}" min="0" max="23" style="width:60px;" class="input">
          <span>:00 ‚Äî</span>
          <input type="number" id="notif-quiet-end" value="${s.quiet_end}" min="0" max="23" style="width:60px;" class="input">
          <span>:00</span>
        </div>
      </div>

      <h4 style="margin:16px 0 8px 0;">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h4>

      <div class="setting-row" style="margin-bottom:8px;">
        <label style="display:flex; align-items:center;">
          <input type="checkbox" id="notif-tasks" ${s.tasks ? 'checked' : ''} style="margin-right:8px;">
          –ó–∞–¥–∞—á–∏ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        </label>
      </div>

      <div class="setting-row" style="margin-bottom:8px;">
        <label style="display:flex; align-items:center;">
          <input type="checkbox" id="notif-meters" ${s.meters ? 'checked' : ''} style="margin-right:8px;">
          –ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤
        </label>
      </div>

      <div class="setting-row" style="margin-bottom:8px;">
        <label style="display:flex; align-items:center;">
          <input type="checkbox" id="notif-warranty" ${s.warranty ? 'checked' : ''} style="margin-right:8px;">
          –ò—Å—Ç–µ—á–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏
        </label>
      </div>

      <div class="setting-row" style="margin-bottom:16px;">
        <label style="display:flex; align-items:center;">
          <input type="checkbox" id="notif-maintenance" ${s.maintenance ? 'checked' : ''} style="margin-right:8px;">
          –ü–ª–∞–Ω–æ–≤–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
        </label>
      </div>

      <div class="setting-actions" style="display:flex; gap:8px;">
        <button data-action="save-notifications" class="btn">
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button data-action="test-notification" class="btn">
          –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        </button>
      </div>
    </div>
  `;
}

async function saveNotificationSettings() {
  const settings = {
    notifications_enabled: $('#notif-enabled').checked,
    notifications_quiet_start: parseInt($('#notif-quiet-start').value),
    notifications_quiet_end: parseInt($('#notif-quiet-end').value),
    notifications_tasks: $('#notif-tasks').checked,
    notifications_meters: $('#notif-meters').checked,
    notifications_warranty: $('#notif-warranty').checked,
    notifications_maintenance: $('#notif-maintenance').checked
  };

  const r = await api.notifications.updateSettings(settings);
  if (r.ok) {
    toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úì', 'success');
  } else {
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
  }
}

async function testNotification() {
  await api.notifications.test();
  toast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'info');
}

// ===== UTILITY CALCULATOR =====
function getMeterIcon(type) {
  const icons = {
    cold_water: 'üö∞',
    hot_water: '‚ô®Ô∏è',
    gas: 'üî•',
    electricity: '‚ö°',
    heating: 'üå°Ô∏è'
  };
  return icons[type] || 'üìä';
}

function formatMonth(month) {
  const [year, m] = month.split('-');
  const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                  '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  return `${months[parseInt(m) - 1]} ${year}`;
}

function formatMonthShort(month) {
  const [year, m] = month.split('-');
  const months = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω',
                  '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
  return months[parseInt(m) - 1];
}

async function saveTariff(type) {
  const input = document.getElementById(`tariff-${type}`);
  const price = parseFloat(input.value);

  if (isNaN(price) || price < 0) {
    toast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ü–µ–Ω–∞', 'error');
    return;
  }

  const r = await api.tariffs.update(type, price);
  if (r.ok) {
    toast('–¢–∞—Ä–∏—Ñ —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úì', 'success');
  } else {
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
  }
}

async function renderUtilityCalculator() {
  const currentMonth = new Date().toISOString().slice(0, 7);

  const [calcResult, historyResult, tariffsResult] = await Promise.all([
    api.utility.calculateMonth(currentMonth),
    api.utility.getHistory(6),
    api.tariffs.list()
  ]);

  const calc = calcResult.ok ? calcResult.data : { items: [], total: 0 };
  const history = historyResult.ok ? historyResult.data : [];
  const tariffs = tariffsResult.ok ? tariffsResult.data : [];

  $('#content').innerHTML = `
    <div class="utility-calculator">
      <div class="h1">üí∞ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–º–º—É–Ω–∞–ª–∫–∏</div>

      <!-- –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü -->
      <section class="calc-section card">
        <div class="cardTitle">–†–∞—Å—á—ë—Ç –∑–∞ ${formatMonth(currentMonth)}</div>

        ${calc.items.length === 0 ? `
          <div class="cardBody">
            <p class="muted">–ù–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∏–π –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.</p>
            <button class="btn" id="goToMetersBtn">–í–Ω–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω–∏—è ‚Üí</button>
          </div>
        ` : `
          <div class="cardBody">
            <table class="utility-table">
              <thead>
                <tr>
                  <th>–£—Å–ª—É–≥–∞</th>
                  <th>–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ</th>
                  <th>–¢–∞—Ä–∏—Ñ</th>
                  <th style="text-align:right;">–°—É–º–º–∞</th>
                </tr>
              </thead>
              <tbody>
                ${calc.items.map(item => `
                  <tr>
                    <td>${getMeterIcon(item.meter_type)} ${escapeHtml(item.meter_name)}</td>
                    <td>${item.consumption} ${item.unit}</td>
                    <td>${item.price_per_unit} ‚ÇΩ/${item.unit}</td>
                    <td style="text-align:right; font-family:monospace;">${formatMoneyRUB(item.total_cost)}</td>
                  </tr>
                `).join('')}
              </tbody>
              <tfoot>
                <tr style="font-weight:700;">
                  <td colspan="3">–ò—Ç–æ–≥–æ:</td>
                  <td style="text-align:right; font-family:monospace; color:var(--accent); font-size:18px;">
                    ${formatMoneyRUB(calc.total)}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        `}
      </section>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
      <section class="calc-section card">
        <div class="cardTitle">üìä –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
        <div class="cardBody">
          ${history.length === 0 ? `
            <p class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã</p>
          ` : `
            <div class="history-chart">
              ${history.map(h => `
                <div class="history-bar">
                  <div class="bar-value">${formatMoneyRUB(h.total)}</div>
                  <div class="bar-fill" style="--height: ${(h.total / Math.max(...history.map(x => x.total))) * 100}%"></div>
                  <div class="bar-label">${formatMonthShort(h.month)}</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </section>

      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ -->
      <section class="calc-section card">
        <div class="cardTitle">‚öôÔ∏è –¢–∞—Ä–∏—Ñ—ã</div>
        <div class="cardBody">
          <p class="muted" style="margin-bottom:16px;">–£–∫–∞–∂–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞</p>

          <div class="tariffs-grid">
            ${tariffs.map(t => `
              <div class="tariff-item">
                <label>${getMeterIcon(t.type)} ${escapeHtml(t.name)}</label>
                <div class="tariff-input">
                  <input type="number"
                         id="tariff-${t.type}"
                         value="${t.price}"
                         step="0.01"
                         min="0"
                         class="input">
                  <span>‚ÇΩ / ${t.unit}</span>
                </div>
                <button class="btn saveTariffBtn" data-tariff-type="${t.type}">
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      </section>
    </div>
  `;

  // Attach event listeners
  const goToMetersBtn = $('#goToMetersBtn');
  if (goToMetersBtn) {
    goToMetersBtn.onclick = () => setRoute('meters');
  }

  $$('.saveTariffBtn').forEach(btn => {
    btn.onclick = () => saveTariff(btn.dataset.tariffType);
  });
}

// ===== ANALYTICS =====
let productivityChart = null;
let costsChart = null;

async function renderAnalytics() {
  const [productivityRes, costsRes, goalsRes, summaryRes] = await Promise.all([
    api.analytics.productivity(30),
    api.analytics.maintenanceCosts(6),
    api.analytics.goals(),
    api.analytics.summary()
  ]);

  const productivity = productivityRes.ok ? productivityRes.data : [];
  const costs = costsRes.ok ? costsRes.data : [];
  const goals = goalsRes.ok ? goalsRes.data : {};
  const summary = summaryRes.ok ? summaryRes.data : {};

  $('#content').innerHTML = `
    <div class="analytics-page">
      <div class="h1">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>

      <!-- –°–≤–æ–¥–∫–∞ -->
      <section class="analytics-section summary-cards card">
        <div class="summary-card">
          <div class="summary-icon">üìã</div>
          <div class="summary-value">${summary.tasks?.completed || 0}</div>
          <div class="summary-label">–∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">üì¶</div>
          <div class="summary-value">${formatMoneyRUB(summary.inventory?.totalValue || 0)}</div>
          <div class="summary-label">—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">üèÜ</div>
          <div class="summary-value">${summary.gamification?.level || 1}</div>
          <div class="summary-label">—É—Ä–æ–≤–µ–Ω—å</div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">üî•</div>
          <div class="summary-value">${summary.gamification?.streak || 0}</div>
          <div class="summary-label">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
        </div>
      </section>

      <!-- –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
      <section class="analytics-section card">
        <div class="cardTitle">üìä –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ 30 –¥–Ω–µ–π</div>
        <div class="cardBody">
          <div class="chart-container">
            <canvas id="productivityChart"></canvas>
          </div>
        </div>
      </section>

      <!-- –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ -->
      <section class="analytics-section card">
        <div class="cardTitle">üí∞ –†–∞—Å—Ö–æ–¥—ã –Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div>
        <div class="cardBody">
          ${costs.length === 0 ? `
            <p class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö</p>
          ` : `
            <div class="chart-container chart-small">
              <canvas id="costsChart"></canvas>
            </div>
          `}
        </div>
      </section>

      <!-- –¶–µ–ª–∏ -->
      <section class="analytics-section card">
        <div class="cardTitle">üéØ –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ü–µ–ª—è–º</div>
        <div class="cardBody">
          ${(goals.goals?.length || 0) === 0 ? `
            <p class="muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</p>
          ` : `
            <div class="goals-summary" style="margin-bottom:16px;">
              <p>–ù–∞–∫–æ–ø–ª–µ–Ω–æ <strong>${formatMoneyRUB(goals.totalSaved || 0)}</strong> –∏–∑ <strong>${formatMoneyRUB(goals.totalTarget || 0)}</strong></p>
            </div>
            <div class="goals-list">
              ${(goals.goals || []).map(g => `
                <div class="goal-analytics-item">
                  <div class="goal-info">
                    <span class="goal-title">${escapeHtml(g.title)}</span>
                    <span class="goal-remaining">–û—Å—Ç–∞–ª–æ—Å—å: ${formatMoneyRUB(g.remaining)}</span>
                  </div>
                  <div class="goal-bar">
                    <div class="goal-progress" style="width: ${g.progress}%"></div>
                  </div>
                  <span class="goal-percent">${g.progress}%</span>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </section>
    </div>
  `;

  // Initialize charts after rendering
  setTimeout(initAnalyticsCharts, 100);
}

async function initAnalyticsCharts() {
  const productivityRes = await api.analytics.productivity(30);
  const costsRes = await api.analytics.maintenanceCosts(6);

  if (productivityRes.ok) {
    const ctx = document.getElementById('productivityChart');
    if (ctx) {
      if (productivityChart) productivityChart.destroy();

      productivityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: productivityRes.data.map(d => d.date.slice(5)), // MM-DD
          datasets: [{
            label: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
            data: productivityRes.data.map(d => d.completed),
            borderColor: '#48bb78',
            backgroundColor: 'rgba(72, 187, 120, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  }

  if (costsRes.ok && costsRes.data.length > 0) {
    const ctx = document.getElementById('costsChart');
    if (ctx) {
      if (costsChart) costsChart.destroy();

      const categoryNames = {
        home: '–î–æ–º',
        car: '–ê–≤—Ç–æ',
        appliance: '–¢–µ—Ö–Ω–∏–∫–∞',
        garden: '–°–∞–¥',
        other: '–î—Ä—É–≥–æ–µ'
      };

      costsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: costsRes.data.map(d => categoryNames[d.category] || d.category),
          datasets: [{
            data: costsRes.data.map(d => d.total),
            backgroundColor: ['#4299e1', '#48bb78', '#ed8936', '#9f7aea', '#718096']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
  }
}

async function renderSettings(){
  const [profilesR, tagsR] = await Promise.all([api.profiles.list(), api.tags.list()]);

  const notifSettingsHTML = await renderNotificationSettings();

  $('#content').innerHTML=`
    <div class="h1">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="muted">–ü—Ä–æ—Ñ–∏–ª–∏, —Ç–µ–≥–∏, –ø–∞–ø–∫–∞ –¥–∞–Ω–Ω—ã—Ö, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</div>
    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ü—Ä–æ—Ñ–∏–ª–∏</div>
          <button class="btn" id="addProfile">+ –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
        <div class="cardBody" id="profileList"></div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <div class="cardHeader">
          <div class="cardTitle">–¢–µ–≥–∏</div>
          <button class="btn" id="addTag">+ —Ç–µ–≥</button>
        </div>
        <div class="cardBody" id="tagList"></div>
      </div>

      <div class="card" style="grid-column: span 3;">
        ${notifSettingsHTML}
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é</div>
        </div>
        <div class="cardBody">
          <p class="muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–∏–¥–∏–º–æ—Å—Ç—å –º–æ–¥—É–ª–µ–π –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é.</p>
          <button class="btn" id="openMenuSettingsBtn" style="margin-top:12px;">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–µ–Ω—é</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</div>
        </div>
        <div class="cardBody">
          <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</p>
          <div class="formRow" style="margin-top:12px; flex-direction:column; gap:8px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="radio" name="theme" value="light"
                     ${(state.userStats?.theme || 'dark') === 'light' ? 'checked' : ''}
                     onchange="setTheme('light')">
              <span>‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="radio" name="theme" value="dark"
                     ${(state.userStats?.theme || 'dark') === 'dark' ? 'checked' : ''}
                     onchange="setTheme('dark')">
              <span>üåô –¢—ë–º–Ω–∞—è</span>
            </label>
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="radio" name="theme" value="auto"
                     ${(state.userStats?.theme || 'dark') === 'auto' ? 'checked' : ''}
                     onchange="setTheme('auto')">
              <span>üîÑ –ö–∞–∫ –≤ —Å–∏—Å—Ç–µ–º–µ</span>
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üì± Telegram</div>
        </div>
        <div class="cardBody">
          <p class="muted">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</p>

          <div class="formRow" style="margin-top:12px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="tg-enabled"
                     ${state.userStats?.telegram_enabled ? 'checked' : ''}
                     onchange="toggleTelegram(this.checked)">
              <span>–í–∫–ª—é—á–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            </label>
          </div>

          <div id="telegram-config" style="display: ${state.userStats?.telegram_enabled ? 'block' : 'none'}; margin-top:12px;">
            <div class="formRow">
              <label>Bot Token:</label>
              <input type="text" id="tg-token"
                     value="${state.userStats?.telegram_bot_token || ''}"
                     placeholder="123456:ABC-DEF...">
              <small class="muted">–ü–æ–ª—É—á–∏—Ç–µ —É @BotFather</small>
            </div>

            <div class="formRow" style="margin-top:8px;">
              <label>Chat ID:</label>
              <input type="text" id="tg-chat-id"
                     value="${state.userStats?.telegram_chat_id || ''}"
                     placeholder="123456789">
              <small class="muted">–ü–æ–ª—É—á–∏—Ç–µ —É @userinfobot</small>
            </div>

            <div class="formRow" style="margin-top:12px; gap:8px;">
              <button class="btn btn-primary" id="saveTelegramBtn">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
              <button class="btn" id="testTelegramBtn">
                –¢–µ—Å—Ç
              </button>
              <button class="btn" id="sendTelegramSummaryBtn">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–¥–∫—É
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">üèÜ –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</div>
        </div>
        <div class="cardBody">
          <p class="muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π XP, —É—Ä–æ–≤–Ω–µ–π –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</p>

          <div class="formRow" style="margin-top:12px; flex-direction:column; gap:8px;">
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="gamification-enabled"
                     ${state.userStats?.gamification_enabled ? 'checked' : ''}
                     onchange="toggleGamification(this.checked)">
              <span>–í–∫–ª—é—á–∏—Ç—å XP, —É—Ä–æ–≤–Ω–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span>
            </label>

            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="animations-enabled"
                     ${state.userStats?.animations_enabled ? 'checked' : ''}
                     onchange="toggleAnimations(this.checked)">
              <span>–ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ XP</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  `;
  $('#addProfile').onclick=()=>openProfileModal();
  $('#openMenuSettingsBtn').onclick=()=>openMenuSettings();
  $('#addTag').onclick=()=>openTagModal();

  const pList=$('#profileList');
  if(profilesR.ok){
    pList.innerHTML=profilesR.data.map(p=>`
      <div class="item">
        <div class="itemMain">
          <div class="itemTitle">${escapeHtml(p.icon||'üë§')} ${escapeHtml(p.name)}</div>
          <div class="itemMeta"><span class="badge">${p.is_archived?'–∞—Ä—Ö–∏–≤':''}</span></div>
        </div>
        <div class="itemActions">
          <button class="iconBtn" data-prof-edit="${p.id}">‚úé</button>
          <button class="iconBtn" data-prof-arch="${p.id}">${p.is_archived?'‚Ü©':'üóÑ'}</button>
        </div>
      </div>
    `).join('');
    $$('[data-prof-edit]', pList).forEach(b=>b.onclick=()=>openProfileModal(profilesR.data.find(x=>x.id===b.dataset.profEdit)));
    $$('[data-prof-arch]', pList).forEach(b=>b.onclick=async ()=>{
      const p=profilesR.data.find(x=>x.id===b.dataset.profArch);
      const r=await api.profiles.archive({ id:p.id, is_archived: !p.is_archived });
      if(!r.ok) return toast(r.error, 'error');
      await loadProfiles(); toast('–û–∫', 'success'); renderSettings();
    });
  }

  const tList=$('#tagList');
  if(tagsR.ok){
    tList.innerHTML = tagsR.data.length ? tagsR.data.map(t=>`
      <div class="item">
        <div class="itemMain">
          <span class="badge" style="border-color:${t.color};">${escapeHtml(t.name)}</span>
        </div>
        <div class="itemActions">
          <button class="iconBtn" data-tag-del="${t.id}">üóë</button>
        </div>
      </div>
    `).join('') : `<div class="muted">–¢–µ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`;
    $$('[data-tag-del]', tList).forEach(b=>b.onclick=async ()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥? –û–Ω –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π.')) return;
      const r=await api.tags.delete({ id:b.dataset.tagDel });
      if(!r.ok) return toast(r.error, 'error');
      await loadTags(); toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); renderSettings();
    });
  }

  // Telegram button handlers
  const saveTelegramBtn = $('#saveTelegramBtn');
  if (saveTelegramBtn) {
    saveTelegramBtn.onclick = async () => {
      const enabled = $('#tg-enabled').checked;
      const token = $('#tg-token').value.trim();
      const chatId = $('#tg-chat-id').value.trim();

      // Validate if enabled
      if (enabled) {
        if (!token) {
          return toast('–í–≤–µ–¥–∏—Ç–µ Bot Token', 'warning');
        }
        if (!chatId) {
          return toast('–í–≤–µ–¥–∏—Ç–µ Chat ID', 'warning');
        }
        // Basic token format validation
        if (!token.includes(':')) {
          return toast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Bot Token (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å ":")', 'warning');
        }
        // Basic chat ID validation (should be numeric or start with -)
        if (!/^-?\d+$/.test(chatId)) {
          return toast('Chat ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º', 'warning');
        }
      }

      const settings = {
        telegram_enabled: enabled,
        telegram_bot_token: token,
        telegram_chat_id: chatId
      };
      const r = await api.telegram.updateSettings(settings);
      if (r.ok) {
        state.userStats.telegram_enabled = settings.telegram_enabled;
        state.userStats.telegram_bot_token = settings.telegram_bot_token;
        state.userStats.telegram_chat_id = settings.telegram_chat_id;
        toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úì', 'success');
      } else {
        toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (r.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
      }
    };
  }

  const testTelegramBtn = $('#testTelegramBtn');
  if (testTelegramBtn) {
    testTelegramBtn.onclick = async () => {
      const r = await api.telegram.test();
      if (r.ok) {
        toast('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram', 'success');
      } else {
        toast('–û—à–∏–±–∫–∞: ' + (r.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å'), 'error');
      }
    };
  }

  const sendTelegramSummaryBtn = $('#sendTelegramSummaryBtn');
  if (sendTelegramSummaryBtn) {
    sendTelegramSummaryBtn.onclick = async () => {
      const r = await api.telegram.sendSummary();
      if (r.ok) {
        toast('–°–≤–æ–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚úì', 'success');
      } else {
        toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (r.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
      }
    };
  }
}
function openProfileModal(existing){
  const p=existing || { name:'', color:'#93c5fd', icon:'üë§' };
  openModal(existing?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å':'–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="pName" placeholder="–ò–º—è" value="${escapeHtml(p.name)}" />
        <input class="input" id="pIcon" placeholder="–ò–∫–æ–Ω–∫–∞ (emoji)" value="${escapeHtml(p.icon||'üë§')}" />
      </div>
      <input class="input" id="pColor" placeholder="–¶–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä #93c5fd)" value="${escapeHtml(p.color||'#93c5fd')}" />
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveProf">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#saveProf', root).onclick=async ()=>{
      const name=$('#pName', root).value.trim();
      const icon=$('#pIcon', root).value.trim() || 'üë§';
      const color=$('#pColor', root).value.trim() || '#93c5fd';
      if(!name) return toast('–ù—É–∂–Ω–æ –∏–º—è', 'warning');
      if(existing){
        const r=await api.profiles.update({ id: existing.id, patch:{ name, icon, color }});
        if(!r.ok) return toast(r.error, 'error');
      } else {
        const r=await api.profiles.create({ name, icon, color });
        if(!r.ok) return toast(r.error, 'error');
      }
      closeModal(); await loadProfiles(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); renderSettings();
    };
  });
}
function openTagModal(){
  openModal('–ù–æ–≤—ã–π —Ç–µ–≥', `
    <div class="form">
      <input class="input" id="tName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞" />
      <input class="input" id="tColor" placeholder="–¶–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä #fca5a5)" value="#fca5a5" />
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveTag">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#saveTag', root).onclick=async ()=>{
      const name=$('#tName', root).value.trim();
      const color=$('#tColor', root).value.trim();
      if(!name) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');
      const r=await api.tags.create({ name, color });
      if(!r.ok) return toast(r.error, 'error');
      closeModal(); await loadTags(); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ', 'success'); renderSettings();
    };
  });
}

async function renderBackup(){
  $('#content').innerHTML=`
    <div class="h1">–ë—ç–∫–∞–ø</div>
    <div class="muted">–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –≤ zip. –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—Å –∞–≤—Ç–æ-–±—ç–∫–∞–ø–æ–º).</div>
    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <div class="cardHeader"><div class="cardTitle">–≠–∫—Å–ø–æ—Ä—Ç</div></div>
        <div class="cardBody"><button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å‚Ä¶</button></div>
      </div>
      <div class="card">
        <div class="cardHeader"><div class="cardTitle">–ò–º–ø–æ—Ä—Ç</div></div>
        <div class="cardBody"><button class="btn danger" id="importBtn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å‚Ä¶</button></div>
      </div>
    </div>
  `;
  $('#exportBtn').onclick=async ()=>{
    const pick=await api.backup.exportPickPath();
    if(!pick.ok) return toast(pick.error);
    if(!pick.data) return;
    const r=await api.backup.exportTo({ targetPath: pick.data.targetPath });
    if(!r.ok) return toast(r.error, 'error');
    toast('–≠–∫—Å–ø–æ—Ä—Ç –≥–æ—Ç–æ–≤');
  };
  $('#importBtn').onclick=async ()=>{
    if(!confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    const pick=await api.backup.importPickFile();
    if(!pick.ok) return toast(pick.error);
    if(!pick.data) return;
    const r=await api.backup.importFrom({ sourcePath: pick.data.sourcePath });
    if(!r.ok) return toast(r.error, 'error');

    // Reload all state after import
    await loadProfiles();
    await loadTags();
    await loadVisibleModules();

    // Reset profile selection to trigger full reload
    state.profileId = null;

    // Navigate to dashboard to show imported data
    setRoute('dashboard');
    render();

    toast('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
  };
}

async function renderSearchResults(q){
  const r=await api.search.query({ q, options:{ profile_id: state.profileId, limit: 15 } });
  $('#content').innerHTML=`
    <div class="h1">–ü–æ–∏—Å–∫</div>
    <div class="muted">–ó–∞–ø—Ä–æ—Å: <b>${escapeHtml(q)}</b></div>
    <div class="grid" style="margin-top:12px;">
      <div class="card"><div class="cardHeader"><div class="cardTitle">–î–µ–ª–∞</div></div><div class="cardBody" id="sTasks"></div></div>
      <div class="card"><div class="cardHeader"><div class="cardTitle">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</div></div><div class="cardBody" id="sPlans"></div></div>
      <div class="card"><div class="cardHeader"><div class="cardTitle">–î–æ–∫—É–º–µ–Ω—Ç—ã</div></div><div class="cardBody" id="sDocs"></div></div>
    </div>
  `;
  if(!r.ok) return toast(r.error, 'error');
  $('#sTasks').innerHTML = r.data.tasks.length ? r.data.tasks.map(itemTaskHtml).join('') : `<div class="muted">–ù–µ—Ç</div>`;
  bindTaskRowActions($('#sTasks'));
  $('#sPlans').innerHTML = r.data.plans.length ? r.data.plans.map(planCardHtml).join('') : `<div class="muted">–ù–µ—Ç</div>`;
  bindPlanActions($('#sPlans'));
  $('#sDocs').innerHTML = r.data.docs.length ? r.data.docs.map(docRowHtml).join('') : `<div class="muted">–ù–µ—Ç</div>`;
  $$('[data-doc-open]', $('#sDocs')).forEach(b=>b.onclick=async ()=>{
    const rr=await api.documents.open({ id:b.dataset.docOpen });
    if(!rr.ok) toast(rr.error);
  });
}

async function renderRoutines(){
  $('#content').innerHTML=`
    <div class="h1">–†—É—Ç–∏–Ω—ã</div>
    <div class="muted">–†—É—Ç–∏–Ω—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –∑–∞–¥–∞—á–∏ (–∫–∞–∫ "–∫–∞–∂–¥—ã–µ 2 –¥–Ω—è").</div>
    <div class="card" style="margin-top:12px;">
      <div class="cardHeader"><div class="cardTitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div></div>
      <div class="cardBody">
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="genRoutines">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 14 –¥–Ω–µ–π</button>
          <button class="btn" id="addRoutine">+ –†—É—Ç–∏–Ω–∞</button>
        </div>
        <div id="routineList" style="margin-top:12px;"></div>
      </div>
    </div>
  `;
  $('#genRoutines').onclick=async ()=>{
    const r=await api.routines.generate({ daysAhead:14 });
    if(!r.ok) return toast(r.error, 'error');
    toast(`–°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: ${r.data.generatedTasks}`);
    setRoute('dashboard');
  };
  $('#addRoutine').onclick=()=>openRoutineModal();

  const listEl=$('#routineList');
  const rr=await api.routines.list({ profile_id: state.profileId });
  if(!rr.ok) return listEl.innerHTML=`<div class="muted">${escapeHtml(rr.error)}</div>`;
  listEl.innerHTML = rr.data.length ? rr.data.map(r=>`
    <div class="item">
      <div class="itemMain">
        <div class="itemTitle">${escapeHtml(r.title)}</div>
        <div class="itemMeta">
          <span class="badge">${escapeHtml(r.rule?.freq||'daily')} / ${escapeHtml(String(r.rule?.interval||1))}</span>
          ${r.profile_id ? `<span class="badge">${escapeHtml(profileName(r.profile_id))}</span>`:''}
          <span class="badge">${r.is_active ? 'active':'paused'}</span>
        </div>
      </div>
      <div class="itemActions">
        <button class="iconBtn" data-r-edit="${r.id}">‚úé</button>
        <button class="iconBtn" data-r-toggle="${r.id}">${r.is_active?'‚è∏':'‚ñ∂'}</button>
        <button class="iconBtn" data-r-del="${r.id}">üóë</button>
      </div>
    </div>
  `).join('') : `<div class="muted">–†—É—Ç–∏–Ω –Ω–µ—Ç.</div>`;

  $$('[data-r-edit]', listEl).forEach(b=>b.onclick=async ()=>{
    const one=await api.routines.get({ id:b.dataset.rEdit });
    if(!one.ok) return toast(one.error);
    openRoutineModal(one.data.routine);
  });
  $$('[data-r-toggle]', listEl).forEach(b=>b.onclick=async ()=>{
    const one=await api.routines.get({ id:b.dataset.rToggle });
    if(!one.ok) return toast(one.error);
    const r=one.data.routine;
    const upd=await api.routines.setActive({ id:r.id, is_active: !r.is_active });
    if(!upd.ok) return toast(upd.error);
    toast('–û–∫', 'success'); renderRoutines();
  });
  $$('[data-r-del]', listEl).forEach(b=>b.onclick=async ()=>{
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ä—É—Ç–∏–Ω—É?')) return;
    const r=await api.routines.delete({ id:b.dataset.rDel });
    if(!r.ok) return toast(r.error, 'error');
    toast('–£–¥–∞–ª–µ–Ω–æ', 'success'); renderRoutines();
  });
}
function openRoutineModal(existing){
  const r=existing || { title:'', description:'', is_active:true, profile_id: state.profileId==='all'?null:state.profileId, rule:{freq:'daily', interval:2}, start_date: todayISO() };
  openModal(existing?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä—É—Ç–∏–Ω—É':'–ù–æ–≤–∞—è —Ä—É—Ç–∏–Ω–∞', `
    <div class="form">
      <input class="input" id="rTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(r.title)}" />
      <textarea class="input" id="rDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ">${escapeHtml(r.description||'')}</textarea>
      <div class="formRow">
        <select id="rFreq">
          <option value="daily">daily</option>
          <option value="weekly">weekly</option>
          <option value="monthly">monthly</option>
        </select>
        <input class="input" id="rInterval" placeholder="–ò–Ω—Ç–µ—Ä–≤–∞–ª" value="${escapeHtml(String(r.rule?.interval||1))}" />
      </div>
      <div class="formRow">
        <input type="date" class="input" id="rStart" placeholder="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞" value="${escapeHtml(r.start_date||todayISO())}" />
        <select id="rProfile"></select>
      </div>
      <label class="row" style="gap:8px;">
        <input type="checkbox" id="rActive" ${r.is_active?'checked':''} />
        <span class="muted">–ê–∫—Ç–∏–≤–Ω–∞</span>
      </label>
      <div class="row" style="justify-content:flex-end;"><button class="btn" id="saveRoutine">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  `, (root)=>{
    $('#rFreq', root).value=r.rule?.freq||'daily';
    const pSel=$('#rProfile', root);
    pSel.innerHTML=[{id:'',name:'‚Äî'}, ...state.profiles.filter(p=>!p.is_archived)]
      .map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
    pSel.value=r.profile_id||'';

    $('#saveRoutine', root).onclick=async ()=>{
      const title=$('#rTitle', root).value.trim();
      const description=$('#rDesc', root).value.trim();
      const freq=$('#rFreq', root).value;
      const interval=Math.max(1, Number($('#rInterval', root).value.trim()||1));
      const start_date=$('#rStart', root).value.trim()||todayISO();
      const profile_id=pSel.value||null;
      const is_active=$('#rActive', root).checked;
      if(!title) return toast('–ù—É–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'warning');

      const payload={ title, description, rule:{freq, interval}, start_date, profile_id, is_active };
      let res;
      if(existing) res=await api.routines.update({ id: existing.id, patch: payload });
      else res=await api.routines.create(payload);
      if(!res.ok) return toast(res.error);

      closeModal(); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success'); renderRoutines();
    };
  });
}

// ============================================
// NEW MODULES FOR v2.0: PROPERTY & ROOMS
// ============================================

async function renderProperty(){
  const r = await api.properties.list();
  if(!r.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(r.error)}</div>`;

  const properties = r.data;

  const html = `
    <div class="h1">üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
    <div class="row" style="margin-bottom:20px;">
      <button class="btn" id="addPropertyBtn">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</button>
    </div>

    ${properties.length === 0 ? `
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üè†</div>
        <div class="h1" style="margin-bottom:10px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Home Manager!</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          –ù–∞—á–Ω–∏—Ç–µ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∞—à–µ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.<br/>
          –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä–∞, –¥–æ–º, –¥–∞—á–∞ –∏–ª–∏ –≥–∞—Ä–∞–∂.
        </p>
        <button class="btn" id="welcomeAddBtn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç</button>
      </div>
    ` : `
      <div class="grid">
        ${properties.map(p=>`
          <div class="card">
            <div class="row" style="justify-content:space-between; margin-bottom:10px;">
              <div style="font-size:18px; font-weight:600;">
                ${p.is_primary ? '‚≠ê ' : ''}${escapeHtml(p.name)}
              </div>
              <div class="row" style="gap:4px;">
                <button class="iconBtn editPropertyBtn" data-id="${p.id}">‚úé</button>
                <button class="iconBtn danger deletePropertyBtn" data-id="${p.id}">üóë</button>
              </div>
            </div>

            <div class="muted" style="margin-bottom:12px;">
              ${['apartment','house','dacha','garage','other'][['apartment','house','dacha','garage','other'].indexOf(p.type)] || '–î—Ä—É–≥–æ–µ'}
            </div>

            ${p.address ? `<div style="margin-bottom:8px;">üìç ${escapeHtml(p.address)}</div>` : ''}

            <div class="row" style="gap:20px; margin-top:12px;">
              ${p.area ? `<div><div class="muted">–ü–ª–æ—â–∞–¥—å</div><div>${p.area} –º¬≤</div></div>` : ''}
              ${p.rooms_count ? `<div><div class="muted">–ö–æ–º–Ω–∞—Ç</div><div>${p.rooms_count}</div></div>` : ''}
              ${p.floor ? `<div><div class="muted">–≠—Ç–∞–∂</div><div>${p.floor}</div></div>` : ''}
            </div>

            ${p.management_company ? `
              <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                <div class="muted">–£–ö</div>
                <div>${escapeHtml(p.management_company)}</div>
                ${p.management_phone ? `<div class="muted">${escapeHtml(p.management_phone)}</div>` : ''}
              </div>
            ` : ''}

            <div class="row" style="gap:8px; margin-top:12px;">
              <button class="btn" data-id="${p.id}" data-property-id="${p.id}" data-route="rooms">üõãÔ∏è –ö–æ–º–Ω–∞—Ç—ã</button>
            </div>
          </div>
        `).join('')}
      </div>
    `}
  `;

  $('#content').innerHTML = html;

  $$('.editPropertyBtn').forEach(btn=>{
    btn.onclick=async ()=>{
      const propertyId=btn.dataset.id;
      const property = properties.find(p=>p.id===propertyId);
      openPropertyModal(property);
    };
  });

  $$('.deletePropertyBtn').forEach(btn=>{
    btn.onclick=async ()=>{
      const propertyId=btn.dataset.id;
      const property = properties.find(p=>p.id===propertyId);
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å "${property.name}"? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã, –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ —Å—á—ë—Ç—á–∏–∫–∏!`)) return;
      const r = await api.properties.delete({ id: propertyId });
      if(!r.ok) return toast(r.error, 'error');
      if(getCurrentPropertyId() === propertyId) clearCurrentPropertyId();
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
      renderProperty();
    };
  });

  const addBtn = $('#addPropertyBtn');
  if(addBtn) addBtn.onclick = ()=>openPropertyModal();

  const welcomeBtn = $('#welcomeAddBtn');
  if(welcomeBtn) welcomeBtn.onclick = ()=>openPropertyModal();
}

function openPropertyModal(existing=null){
  const title = existing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å';

  const html = `
    <div class="list">
      <div>
        <label class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input class="input" id="propName" value="${escapeHtml(existing?.name||'')}" placeholder="–ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞ –õ–µ–Ω–∏–Ω–∞" />
      </div>

      <div>
        <label class="muted">–¢–∏–ø</label>
        <select class="input" id="propType">
          <option value="apartment" ${existing?.type==='apartment'?'selected':''}>–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
          <option value="house" ${existing?.type==='house'?'selected':''}>–î–æ–º</option>
          <option value="dacha" ${existing?.type==='dacha'?'selected':''}>–î–∞—á–∞</option>
          <option value="garage" ${existing?.type==='garage'?'selected':''}>–ì–∞—Ä–∞–∂</option>
          <option value="other" ${existing?.type==='other'?'selected':''}>–î—Ä—É–≥–æ–µ</option>
        </select>
      </div>

      <div>
        <label class="muted">–ê–¥—Ä–µ—Å</label>
        <input class="input" id="propAddress" value="${escapeHtml(existing?.address||'')}" placeholder="–≥. –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 15, –∫–≤. 42" />
      </div>

      <div class="row" style="gap:12px;">
        <div style="flex:1;">
          <label class="muted">–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
          <input type="number" class="input" id="propArea" value="${existing?.area||''}" placeholder="46" />
        </div>
        <div style="flex:1;">
          <label class="muted">–ö–æ–º–Ω–∞—Ç</label>
          <input type="number" class="input" id="propRooms" value="${existing?.rooms_count||''}" placeholder="2" />
        </div>
        <div style="flex:1;">
          <label class="muted">–≠—Ç–∞–∂</label>
          <input type="number" class="input" id="propFloor" value="${existing?.floor||''}" placeholder="5" />
        </div>
      </div>

      <div>
        <label class="muted">–£–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è</label>
        <input class="input" id="propMC" value="${escapeHtml(existing?.management_company||'')}" placeholder="–û–û–û '–ñ–∏–ª–∫–æ–º—Å–µ—Ä–≤–∏—Å'" />
      </div>

      <div>
        <label class="muted">–¢–µ–ª–µ—Ñ–æ–Ω –£–ö</label>
        <input class="input" id="propMCPhone" value="${escapeHtml(existing?.management_phone||'')}" placeholder="+7 (812) 555-12-34" />
      </div>

      <div>
        <label class="muted">–õ–∏—Ü–µ–≤–æ–π —Å—á—ë—Ç</label>
        <input class="input" id="propAccount" value="${escapeHtml(existing?.management_account||'')}" placeholder="1234567890" />
      </div>

      <div>
        <label class="muted">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea class="input" id="propNotes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">${escapeHtml(existing?.notes||'')}</textarea>
      </div>

      <div>
        <label>
          <input type="checkbox" id="propPrimary" ${existing?.is_primary?'checked':''} />
          <span class="muted">–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</span>
        </label>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="savePropertyBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="closeModal();">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal(title, html, (root)=>{
    $('#savePropertyBtn', root).onclick = async ()=>{
      const name = $('#propName', root).value.trim();
      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const payload = {
        name,
        type: $('#propType', root).value,
        address: $('#propAddress', root).value.trim(),
        area: parseFloat($('#propArea', root).value) || null,
        rooms_count: parseInt($('#propRooms', root).value) || null,
        floor: parseInt($('#propFloor', root).value) || null,
        management_company: $('#propMC', root).value.trim(),
        management_phone: $('#propMCPhone', root).value.trim(),
        management_account: $('#propAccount', root).value.trim(),
        notes: $('#propNotes', root).value.trim(),
        is_primary: $('#propPrimary', root).checked
      };

      let res;
      if(existing) res = await api.properties.update({ id: existing.id, patch: payload });
      else res = await api.properties.create(payload);

      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderProperty();
    };
  });
}

async function renderRooms(){
  // Get current property (for now, just use first one or show selector later)
  const propRes = await api.properties.list();
  if(!propRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(propRes.error)}</div>`;

  const properties = propRes.data;
  if(properties.length === 0){
    $('#content').innerHTML = `
      <div class="h1">üõãÔ∏è –ö–æ–º–Ω–∞—Ç—ã</div>
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üè†</div>
        <div class="h1" style="margin-bottom:10px;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–º–Ω–∞—Ç—ã, —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.
        </p>
        <button class="btn" onclick="setRoute('property');">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</button>
      </div>
    `;
    return;
  }

  const currentProperty = resolveCurrentProperty(properties);
  if(!currentProperty) return;

  const roomsRes = await api.rooms.list({ property_id: currentProperty.id });
  if(!roomsRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(roomsRes.error)}</div>`;

  const rooms = roomsRes.data;

  const roomTypes = {
    kitchen: { name: '–ö—É—Ö–Ω—è', icon: 'üç≥' },
    bedroom: { name: '–°–ø–∞–ª—å–Ω—è', icon: 'üõèÔ∏è' },
    living: { name: '–ì–æ—Å—Ç–∏–Ω–∞—è', icon: 'üõãÔ∏è' },
    bathroom: { name: '–í–∞–Ω–Ω–∞—è', icon: 'üöø' },
    toilet: { name: '–¢—É–∞–ª–µ—Ç', icon: 'üöΩ' },
    corridor: { name: '–ö–æ—Ä–∏–¥–æ—Ä', icon: 'üö™' },
    balcony: { name: '–ë–∞–ª–∫–æ–Ω', icon: 'üåÖ' },
    children: { name: '–î–µ—Ç—Å–∫–∞—è', icon: 'üß∏' },
    office: { name: '–ö–∞–±–∏–Ω–µ—Ç', icon: 'üíº' },
    storage: { name: '–ö–ª–∞–¥–æ–≤–∞—è', icon: 'üì¶' },
    garage: { name: '–ì–∞—Ä–∞–∂', icon: 'üöó' },
    other: { name: '–î—Ä—É–≥–æ–µ', icon: 'üìç' }
  };

  const html = `
    <div class="h1">üõãÔ∏è –ö–æ–º–Ω–∞—Ç—ã: ${escapeHtml(currentProperty.name)}</div>
    <div class="row" style="margin-bottom:20px; gap:12px; flex-wrap:wrap;">
      <button class="btn" onclick="setRoute('property');">‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</button>
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:4px;">–û–±—ä–µ–∫—Ç</div>
        ${propertySelectHtml(properties, currentProperty.id)}
      </div>
      <button class="btn" id="addRoomBtn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    </div>

    ${rooms.length === 0 ? `
      <div class="card" style="padding:40px; text-align:center;">
        <div style="font-size:36px; margin-bottom:12px;">üõãÔ∏è</div>
        <div class="h1" style="margin-bottom:8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É</div>
        <p style="color:var(--muted); margin-bottom:20px;">
          –û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤–∞—à–µ–≥–æ –¥–æ–º–∞
        </p>
        <button class="btn" id="welcomeRoomBtn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      </div>
    ` : `
      <div class="grid">
        ${rooms.map(room=>{
          const type = roomTypes[room.type] || roomTypes.other;
          return `
            <div class="card">
              <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <div style="font-size:18px; font-weight:600;">
                  ${type.icon} ${escapeHtml(room.name)}
                </div>
                <div class="row" style="gap:4px;">
                  <button class="iconBtn editRoomBtn" data-id="${room.id}">‚úé</button>
                  <button class="iconBtn danger deleteRoomBtn" data-id="${room.id}">üóë</button>
                </div>
              </div>

              <div class="muted">${type.name}</div>

              ${room.area ? `
                <div style="margin-top:12px;">
                  <div class="muted">–ü–ª–æ—â–∞–¥—å</div>
                  <div>${room.area} –º¬≤</div>
                </div>
              ` : ''}

              ${room.notes ? `
                <div style="margin-top:12px;">
                  <div class="muted">–ó–∞–º–µ—Ç–∫–∏</div>
                  <div style="font-size:13px;">${escapeHtml(room.notes)}</div>
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;

  $('#content').innerHTML = html;

  const propertyPicker = $('#propertyPicker');
  if(propertyPicker){
    propertyPicker.onchange = () => {
      setCurrentPropertyId(propertyPicker.value);
      renderRooms();
    };
  }

  $$('.editRoomBtn').forEach(btn=>{
    btn.onclick=()=>{
      const room = rooms.find(r=>r.id===btn.dataset.id);
      openRoomModal(currentProperty.id, room);
    };
  });

  $$('.deleteRoomBtn').forEach(btn=>{
    btn.onclick=async ()=>{
      const room = rooms.find(r=>r.id===btn.dataset.id);
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É "${room.name}"?`)) return;
      const r = await api.rooms.delete({ id: room.id });
      if(!r.ok) return toast(r.error, 'error');
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
      renderRooms();
    };
  });

  const addBtn = $('#addRoomBtn');
  if(addBtn) addBtn.onclick = ()=>openRoomModal(currentProperty.id);

  const welcomeBtn = $('#welcomeRoomBtn');
  if(welcomeBtn) welcomeBtn.onclick = ()=>openRoomModal(currentProperty.id);
}

function openRoomModal(propertyId, existing=null){
  const title = existing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É' : '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É';

  const roomTypes = [
    { value: 'kitchen', label: '–ö—É—Ö–Ω—è' },
    { value: 'bedroom', label: '–°–ø–∞–ª—å–Ω—è' },
    { value: 'living', label: '–ì–æ—Å—Ç–∏–Ω–∞—è' },
    { value: 'bathroom', label: '–í–∞–Ω–Ω–∞—è' },
    { value: 'toilet', label: '–¢—É–∞–ª–µ—Ç' },
    { value: 'corridor', label: '–ö–æ—Ä–∏–¥–æ—Ä' },
    { value: 'balcony', label: '–ë–∞–ª–∫–æ–Ω' },
    { value: 'children', label: '–î–µ—Ç—Å–∫–∞—è' },
    { value: 'office', label: '–ö–∞–±–∏–Ω–µ—Ç' },
    { value: 'storage', label: '–ö–ª–∞–¥–æ–≤–∞—è' },
    { value: 'garage', label: '–ì–∞—Ä–∞–∂' },
    { value: 'other', label: '–î—Ä—É–≥–æ–µ' }
  ];

  const html = `
    <div class="list">
      <div>
        <label class="muted">–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã *</label>
        <select class="input" id="roomType">
          ${roomTypes.map(t=>`<option value="${t.value}" ${existing?.type===t.value?'selected':''}>${t.label}</option>`).join('')}
        </select>
      </div>

      <div>
        <label class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input class="input" id="roomName" value="${escapeHtml(existing?.name||'')}" placeholder="–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ —Ç–∏–ø—É" />
      </div>

      <div>
        <label class="muted">–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
        <input type="number" class="input" id="roomArea" value="${existing?.area||''}" placeholder="12" />
      </div>

      <div>
        <label class="muted">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea class="input" id="roomNotes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">${escapeHtml(existing?.notes||'')}</textarea>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="saveRoomBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="closeModal();">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal(title, html, (root)=>{
    const typeSelect = $('#roomType', root);
    const nameInput = $('#roomName', root);

    // Auto-fill name when type changes
    typeSelect.onchange = ()=>{
      if(!existing && !nameInput.value.trim()){
        const selectedType = roomTypes.find(t=>t.value===typeSelect.value);
        if(selectedType) nameInput.value = selectedType.label;
      }
    };

    // Trigger initial auto-fill for new rooms
    if(!existing) typeSelect.onchange();

    $('#saveRoomBtn', root).onclick = async ()=>{
      const name = nameInput.value.trim();
      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const payload = {
        property_id: propertyId,
        type: typeSelect.value,
        name,
        area: parseFloat($('#roomArea', root).value) || null,
        notes: $('#roomNotes', root).value.trim()
      };

      let res;
      if(existing) res = await api.rooms.update({ id: existing.id, patch: payload });
      else res = await api.rooms.create(payload);

      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderRooms();
    };
  });
}

// ============================================
// NEW MODULE: METERS (v2.0)
// ============================================

async function renderMeters(){
  const propRes = await api.properties.list();
  if(!propRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(propRes.error)}</div>`;

  const properties = propRes.data;
  if(properties.length === 0){
    $('#content').innerHTML = `
      <div class="h1">üíß –°—á—ë—Ç—á–∏–∫–∏</div>
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üè†</div>
        <div class="h1" style="margin-bottom:10px;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          –°—á—ë—Ç—á–∏–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –æ–±—ä–µ–∫—Ç–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.
        </p>
        <button class="btn" onclick="setRoute('property');">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</button>
      </div>
    `;
    return;
  }

  const currentProperty = resolveCurrentProperty(properties);
  if(!currentProperty) return;

  if(!state.metersFilter) state.metersFilter = { showInactive:false };
  const metersRes = await api.meters.list({ property_id: currentProperty.id, is_active: state.metersFilter.showInactive ? undefined : true });
  if(!metersRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(metersRes.error)}</div>`;

  const meters = metersRes.data;

  const meterTypes = {
    cold_water: { name: '–•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞', icon: 'üíß', color: '#3b82f6', unit: '–º¬≥' },
    hot_water: { name: '–ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞', icon: 'üî•', color: '#ef4444', unit: '–º¬≥' },
    electricity: { name: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ', icon: '‚ö°', color: '#eab308', unit: '–∫–í—Ç¬∑—á' },
    gas: { name: '–ì–∞–∑', icon: 'üîµ', color: '#8b5cf6', unit: '–º¬≥' },
    heating: { name: '–û—Ç–æ–ø–ª–µ–Ω–∏–µ', icon: 'üå°Ô∏è', color: '#f97316', unit: '–ì–∫–∞–ª' }
  };

  // Check if need to submit readings (15-25 of month)
  const today = new Date();
  const dayOfMonth = today.getDate();
  const needSubmit = dayOfMonth >= 15 && dayOfMonth <= 25;

  const html = `
    <div class="h1">üíß –°—á—ë—Ç—á–∏–∫–∏: ${escapeHtml(currentProperty.name)}</div>
    <div class="row" style="margin-bottom:20px; gap:12px; flex-wrap:wrap;">
      <div>
        <div class="muted" style="font-size:12px; margin-bottom:4px;">–û–±—ä–µ–∫—Ç</div>
        ${propertySelectHtml(properties, currentProperty.id)}
      </div>
      <label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="metersShowInactive" ${state.metersFilter.showInactive ? 'checked' : ''} />
        <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</span>
      </label>
      <button class="btn" id="addMeterBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫</button>
    </div>

    ${needSubmit ? `
      <div class="card" style="border-color:var(--warn); background:rgba(245,158,11,.08); margin-bottom:20px;">
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="font-size:24px;">‚ö†Ô∏è</div>
          <div>
            <div style="font-weight:700;">–°–¥–∞—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–æ 25 —á–∏—Å–ª–∞</div>
            <div class="muted">–û—Å—Ç–∞–ª–æ—Å—å ${25 - dayOfMonth} –¥–Ω–µ–π</div>
          </div>
        </div>
      </div>
    ` : ''}

    ${meters.length === 0 ? `
      <div class="card" style="padding:40px; text-align:center;">
        <div style="font-size:36px; margin-bottom:12px;">üíß</div>
        <div class="h1" style="margin-bottom:8px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å—á—ë—Ç—á–∏–∫</div>
        <p style="color:var(--muted); margin-bottom:20px;">
          –í–µ–¥–∏—Ç–µ —É—á—ë—Ç –≤–æ–¥—ã, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞ –∏ –≥–∞–∑–∞
        </p>
        <button class="btn" id="welcomeMeterBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫</button>
      </div>
    ` : `
      <div class="list">
        ${meters.map(meter=>{
          const type = meterTypes[meter.type] || { name: '–î—Ä—É–≥–æ–µ', icon: 'üìä', color: '#6b7280', unit: '' };

          // Check verification warning
          const verificationWarning = meter.next_verification &&
            new Date(meter.next_verification) < new Date(Date.now() + 90*24*3600*1000);

          return `
            <div class="card" style="border-left:3px solid ${type.color};">
              <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <div>
                  <div style="font-size:18px; font-weight:600;">
                    ${type.icon} ${escapeHtml(meter.name)}
                  </div>
                  <div class="muted">${type.name}</div>
                </div>
                <div class="row" style="gap:4px;">
                  <button class="btn addReadingBtn" style="padding:8px 12px;" data-meter-id="${meter.id}">–í–Ω–µ—Å—Ç–∏</button>
                  <button class="iconBtn editMeterBtn" data-id="${meter.id}">‚úé</button>
                  <button class="iconBtn danger deleteMeterBtn" data-id="${meter.id}">üóë</button>
                </div>
              </div>

              <div class="row" style="gap:30px; margin-top:12px;">
                ${meter.last_reading !== null ? `
                  <div>
                    <div class="muted">–¢–µ–∫—É—â–µ–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ</div>
                    <div style="font-size:20px; font-weight:700;">${meter.last_reading} <span class="muted" style="font-size:14px;">${type.unit}</span></div>
                    ${meter.last_reading_date ? `<div class="muted" style="font-size:11px;">${meter.last_reading_date}</div>` : ''}
                  </div>
                ` : `
                  <div>
                    <div class="muted">–ü–æ–∫–∞–∑–∞–Ω–∏—è</div>
                    <div style="color:var(--warn);">–ù–µ –≤–Ω–µ—Å–µ–Ω—ã</div>
                  </div>
                `}

                ${meter.serial_number ? `
                  <div>
                    <div class="muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</div>
                    <div style="font-size:13px;">${escapeHtml(meter.serial_number)}</div>
                  </div>
                ` : ''}
              </div>

              ${verificationWarning ? `
                <div style="margin-top:12px; padding:8px; background:rgba(245,158,11,.08); border-radius:8px; border:1px solid rgba(245,158,11,.3);">
                  <div style="font-size:13px;">‚ö†Ô∏è –ü–æ–≤–µ—Ä–∫–∞ –¥–æ: ${meter.next_verification}</div>
                </div>
              ` : ''}

              <div class="row" style="gap:8px; margin-top:12px;">
                <button class="btn showHistoryBtn" data-meter-id="${meter.id}" style="font-size:13px; padding:6px 10px;">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;

  $('#content').innerHTML = html;

  const propertyPicker = $('#propertyPicker');
  if(propertyPicker){
    propertyPicker.onchange = () => {
      setCurrentPropertyId(propertyPicker.value);
      renderMeters();
    };
  }

  $$('.editMeterBtn').forEach(btn=>{
    btn.onclick=()=>{
      const meter = meters.find(m=>m.id===btn.dataset.id);
      openMeterModal(currentProperty.id, meter);
    };
  });

  $$('.deleteMeterBtn').forEach(btn=>{
    btn.onclick=async ()=>{
      const meter = meters.find(m=>m.id===btn.dataset.id);
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ "${meter.name}"? –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∫–∞–∑–∞–Ω–∏–π!`)) return;
      const r = await api.meters.delete({ id: meter.id });
      if(!r.ok) return toast(r.error, 'error');
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
      renderMeters();
    };
  });

  $$('.addReadingBtn').forEach(btn=>{
    btn.onclick = () => openAddReadingModal(btn.dataset.meterId);
  });

  $$('.showHistoryBtn').forEach(btn=>{
    btn.onclick = () => showMeterHistory(btn.dataset.meterId);
  });

  const addBtn = $('#addMeterBtn');
  if(addBtn) addBtn.onclick = ()=>openMeterModal(currentProperty.id);

  const welcomeBtn = $('#welcomeMeterBtn');
  if(welcomeBtn) welcomeBtn.onclick = ()=>openMeterModal(currentProperty.id);

  const showInactive = $('#metersShowInactive');
  if(showInactive){
    showInactive.onchange = ()=>{
      state.metersFilter.showInactive = showInactive.checked;
      renderMeters();
    };
  }
}

function openMeterModal(propertyId, existing=null){
  const title = existing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á—ë—Ç—á–∏–∫' : '–î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫';

  const meterTypes = [
    { value: 'cold_water', label: 'üíß –•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞' },
    { value: 'hot_water', label: 'üî• –ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞' },
    { value: 'electricity', label: '‚ö° –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ' },
    { value: 'gas', label: 'üîµ –ì–∞–∑' },
    { value: 'heating', label: 'üå°Ô∏è –û—Ç–æ–ø–ª–µ–Ω–∏–µ' }
  ];

  const html = `
    <div class="list">
      <div>
        <label class="muted">–¢–∏–ø —Å—á—ë—Ç—á–∏–∫–∞ *</label>
        <select class="input" id="meterType">
          ${meterTypes.map(t=>`<option value="${t.value}" ${existing?.type===t.value?'selected':''}>${t.label}</option>`).join('')}
        </select>
      </div>

      <div>
        <label class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input class="input" id="meterName" value="${escapeHtml(existing?.name||'')}" placeholder="–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –ø–æ —Ç–∏–ø—É" />
      </div>

      <div>
        <label class="muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
        <input class="input" id="meterSerial" value="${escapeHtml(existing?.serial_number||'')}" placeholder="123456789" />
      </div>

      <div class="row" style="gap:12px;">
        <div style="flex:1;">
          <label class="muted">–î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
          <input type="date" class="input" id="meterInstall" value="${existing?.installation_date||''}" />
        </div>
        <div style="flex:1;">
          <label class="muted">–°–ª–µ–¥—É—é—â–∞—è –ø–æ–≤–µ—Ä–∫–∞</label>
          <input type="date" class="input" id="meterVerify" value="${existing?.next_verification||''}" />
        </div>
      </div>

      <div>
        <label class="muted">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
        <input class="input" id="meterLocation" value="${escapeHtml(existing?.location||'')}" placeholder="–ü–æ–¥ —Ä–∞–∫–æ–≤–∏–Ω–æ–π –Ω–∞ –∫—É—Ö–Ω–µ" />
      </div>

      <div class="row" style="gap:12px;">
        <div style="flex:1;">
          <label class="muted">–°–¥–∞–≤–∞—Ç—å —Å (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label>
          <input type="number" class="input" id="meterDayStart" value="${existing?.submission_day_start||15}" min="1" max="31" />
        </div>
        <div style="flex:1;">
          <label class="muted">–°–¥–∞–≤–∞—Ç—å –¥–æ (—á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞)</label>
          <input type="number" class="input" id="meterDayEnd" value="${existing?.submission_day_end||25}" min="1" max="31" />
        </div>
      </div>

      <div>
        <label>
          <input type="checkbox" id="meterActive" ${existing?.is_active !== false ? 'checked' : ''} />
          <span class="muted">–°—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω</span>
        </label>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="saveMeterBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" id="cancelMeterBtn">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal(title, html, (root)=>{
    const typeSelect = $('#meterType', root);
    const nameInput = $('#meterName', root);

    typeSelect.onchange = ()=>{
      if(!existing && !nameInput.value.trim()){
        const selectedType = meterTypes.find(t=>t.value===typeSelect.value);
        if(selectedType) nameInput.value = selectedType.label.split(' ')[1];
      }
    };

    if(!existing) typeSelect.onchange();

    $('#saveMeterBtn', root).onclick = async ()=>{
      const name = nameInput.value.trim();
      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const payload = {
        property_id: propertyId,
        type: typeSelect.value,
        name,
        serial_number: $('#meterSerial', root).value.trim(),
        installation_date: $('#meterInstall', root).value || null,
        next_verification: $('#meterVerify', root).value || null,
        location: $('#meterLocation', root).value.trim(),
        submission_day_start: parseInt($('#meterDayStart', root).value) || 15,
        submission_day_end: parseInt($('#meterDayEnd', root).value) || 25,
        is_active: $('#meterActive', root).checked
      };

      let res;
      if(existing) res = await api.meters.update({ id: existing.id, patch: payload });
      else res = await api.meters.create(payload);

      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderMeters();
    };

    $('#cancelMeterBtn', root).onclick = () => closeModal();
  });
}

async function openAddReadingModal(meterId){
  const meterRes = await api.meters.get({ id: meterId });
  if(!meterRes.ok) return toast(meterRes.error);

  const meter = meterRes.data;

  const html = `
    <div class="list">
      <div>
        <div style="font-size:18px; font-weight:600; margin-bottom:8px;">${escapeHtml(meter.name)}</div>
        ${meter.last_reading !== null ? `
          <div class="muted">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ: ${meter.last_reading}</div>
        ` : ''}
      </div>

      <div>
        <label class="muted">–ü–æ–∫–∞–∑–∞–Ω–∏–µ *</label>
        <input type="number" step="0.01" class="input" id="readingValue" placeholder="${meter.last_reading || '0'}" autofocus />
      </div>

      <div>
        <label class="muted">–î–∞—Ç–∞ –ø–æ–∫–∞–∑–∞–Ω–∏—è</label>
        <input type="date" class="input" id="readingDate" value="${todayISO()}" />
      </div>

      <div>
        <label class="muted">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea class="input" id="readingNotes" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></textarea>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="saveReadingBtn">–í–Ω–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–µ</button>
        <button class="btn" onclick="closeModal();">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal('–í–Ω–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω–∏–µ', html, (root)=>{
    $('#saveReadingBtn', root).onclick = async ()=>{
      const value = parseFloat($('#readingValue', root).value);
      if(isNaN(value)) return toast('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∫–∞–∑–∞–Ω–∏–µ');

      const payload = {
        meter_id: meterId,
        value,
        reading_date: $('#readingDate', root).value || todayISO(),
        notes: $('#readingNotes', root).value.trim()
      };

      const res = await api.meters.addReading(payload);
      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–ü–æ–∫–∞–∑–∞–Ω–∏–µ –≤–Ω–µ—Å–µ–Ω–æ');
      renderMeters();
    };
  });
}

async function showMeterHistory(meterId){
  const meterRes = await api.meters.get({ id: meterId });
  if(!meterRes.ok) return toast(meterRes.error);

  const meter = meterRes.data;

  const readingsRes = await api.meters.getReadings({ meter_id: meterId, limit: 30 });
  if(!readingsRes.ok) return toast(readingsRes.error);

  const readings = readingsRes.data;

  const html = `
    <div>
      <div style="font-size:18px; font-weight:600; margin-bottom:16px;">${escapeHtml(meter.name)}</div>

      ${readings.length === 0 ? `
        <div class="card" style="padding:40px; text-align:center;">
          <div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π –ø—É—Å—Ç–∞</div>
        </div>
      ` : `
        <div class="list" style="max-height:60vh; overflow:auto;">
          ${readings.map(r=>`
            <div class="card">
              <div class="row" style="justify-content:space-between;">
                <div>
                  <div style="font-size:16px; font-weight:600;">${r.value}</div>
                  <div class="muted" style="font-size:12px;">${r.reading_date}</div>
                </div>
                <div style="text-align:right;">
                  ${r.consumption !== null ? `
                    <div style="font-size:14px; color:var(--muted);">–†–∞—Å—Ö–æ–¥: ${r.consumption}</div>
                  ` : ''}
                </div>
              </div>
              ${r.notes ? `<div class="muted" style="font-size:12px; margin-top:6px;">${escapeHtml(r.notes)}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `}

      <div class="row" style="gap:12px; margin-top:16px;">
        <button class="btn" onclick="closeModal();">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  `;

  openModal(`–ò—Å—Ç–æ—Ä–∏—è: ${meter.name}`, html);
}

// ============================================
// NEW MODULE: INVENTORY (v2.0)
// ============================================

async function renderInventory(){
  const propRes = await api.properties.list();
  if(!propRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(propRes.error)}</div>`;

  const properties = propRes.data;
  if(properties.length === 0){
    $('#content').innerHTML = `
      <div class="h1">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üè†</div>
        <div class="h1" style="margin-bottom:10px;">–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –æ–±—ä–µ–∫—Ç–∞–º –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.
        </p>
        <button class="btn" id="goToPropertyFromInventory">‚Üê –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</button>
      </div>
    `;
    const goBtn = $('#goToPropertyFromInventory');
    if(goBtn) goBtn.onclick = () => setRoute('property');
    return;
  }

  const currentProperty = resolveCurrentProperty(properties);
  if(!currentProperty) return;

  const roomsRes = await api.rooms.list({ property_id: currentProperty.id });
  const rooms = roomsRes.ok ? roomsRes.data : [];

  const inventoryRes = await api.inventory.list({ property_id: currentProperty.id });
  if(!inventoryRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(inventoryRes.error)}</div>`;

  const items = inventoryRes.data;

  const categories = {
    electronics: { name: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', icon: 'üì±', color: '#3b82f6' },
    appliances: { name: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞', icon: 'üîå', color: '#8b5cf6' },
    furniture: { name: '–ú–µ–±–µ–ª—å', icon: 'üõãÔ∏è', color: '#f59e0b' },
    tools: { name: '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', icon: 'üîß', color: '#ef4444' },
    kitchen: { name: '–ö—É—Ö–æ–Ω–Ω–∞—è —É—Ç–≤–∞—Ä—å', icon: 'üç≥', color: '#10b981' },
    decor: { name: '–î–µ–∫–æ—Ä', icon: 'üñºÔ∏è', color: '#ec4899' },
    other: { name: '–ü—Ä–æ—á–µ–µ', icon: 'üì¶', color: '#6b7280' }
  };

  const today = new Date();
  const filterCategory = state.inventoryFilter?.category || 'all';
  const filterRoom = state.inventoryFilter?.room || 'all';
  const filterStatus = state.inventoryFilter?.status || 'all';

  let filteredItems = items;
  if(filterCategory !== 'all') filteredItems = filteredItems.filter(i => i.category === filterCategory);
  if(filterRoom !== 'all') filteredItems = filteredItems.filter(i => i.room_id === filterRoom);
  if(filterStatus !== 'all') filteredItems = filteredItems.filter(i => i.status === filterStatus);

  const totalValue = items.reduce((sum, item) => sum + (item.purchase_price || 0), 0);

  $('#content').innerHTML = `
    <div class="h1">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å: ${escapeHtml(currentProperty.name)}</div>

    <div class="card" style="margin-bottom:16px;">
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–û–±—ä–µ–∫—Ç</label>
          ${propertySelectHtml(properties, currentProperty.id)}
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="muted" style="margin-bottom:6px;">–í—Å–µ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
          <div style="font-size:24px; font-weight:700;">${items.length}</div>
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="muted" style="margin-bottom:6px;">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
          <div style="font-size:24px; font-weight:700;">${totalValue.toLocaleString('ru-RU')} ‚ÇΩ</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px;">
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select class="input" id="filterCategory">
            <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            ${Object.entries(categories).map(([k,v])=>`
              <option value="${k}" ${filterCategory===k?'selected':''}>${v.icon} ${v.name}</option>
            `).join('')}
          </select>
        </div>
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–ö–æ–º–Ω–∞—Ç–∞</label>
          <select class="input" id="filterRoom">
            <option value="all">–í—Å–µ –∫–æ–º–Ω–∞—Ç—ã</option>
            ${rooms.map(r=>`
              <option value="${r.id}" ${filterRoom===r.id?'selected':''}>${escapeHtml(r.name)}</option>
            `).join('')}
          </select>
        </div>
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–°—Ç–∞—Ç—É—Å</label>
          <select class="input" id="filterStatus">
            <option value="all">–í—Å–µ</option>
            <option value="active" ${filterStatus==='active'?'selected':''}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
            <option value="repair" ${filterStatus==='repair'?'selected':''}>–ù–∞ —Ä–µ–º–æ–Ω—Ç–µ</option>
            <option value="disposed" ${filterStatus==='disposed'?'selected':''}>–£—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" onclick="openInventoryModal('${currentProperty.id}');">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
        </div>
      </div>
    </div>

    ${filteredItems.length === 0 ? `
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üì¶</div>
        <div class="h1" style="margin-bottom:10px;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–∞—à–µ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞.
        </p>
        <button class="btn" onclick="openInventoryModal('${currentProperty.id}');">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
      </div>
    ` : `
      <div class="grid">
        ${filteredItems.map(item=>{
          const cat = categories[item.category] || categories.other;
          const room = rooms.find(r=>r.id===item.room_id);

          let warrantyStatus = null;
          if(item.warranty_until){
            const warrantyDate = new Date(item.warranty_until);
            const daysLeft = Math.floor((warrantyDate - today) / (1000*60*60*24));
            if(daysLeft < 0) warrantyStatus = { text: '–ò—Å—Ç–µ–∫–ª–∞', color: 'var(--muted)' };
            else if(daysLeft <= 30) warrantyStatus = { text: `${daysLeft} –¥–Ω.`, color: 'var(--warn)' };
            else warrantyStatus = { text: `${daysLeft} –¥–Ω.`, color: 'var(--ok)' };
          }

          return `
            <div class="card" style="border-left:4px solid ${cat.color};">
              <div class="cardHeader">
                <div>
                  <div style="font-size:24px; margin-bottom:4px;">${cat.icon}</div>
                  <div class="cardTitle">${escapeHtml(item.name)}</div>
                  <div class="muted" style="font-size:12px; margin-top:2px;">${cat.name}</div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" onclick="openInventoryModal('${currentProperty.id}', '${item.id}');" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                  <button class="iconBtn" onclick="deleteInventoryItem('${item.id}');" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
              </div>
              <div class="cardBody">
                ${item.brand ? `<div class="muted" style="margin-bottom:4px;">–ë—Ä–µ–Ω–¥: ${escapeHtml(item.brand)}</div>` : ''}
                ${item.model ? `<div class="muted" style="margin-bottom:4px;">–ú–æ–¥–µ–ª—å: ${escapeHtml(item.model)}</div>` : ''}
                ${room ? `<div class="muted" style="margin-bottom:4px;">üìç ${escapeHtml(room.name)}</div>` : ''}
                ${item.purchase_price ? `<div style="font-size:18px; font-weight:600; margin-top:8px;">${item.purchase_price.toLocaleString('ru-RU')} ‚ÇΩ</div>` : ''}
                ${item.purchase_date ? `<div class="muted" style="font-size:11px; margin-top:2px;">–ö—É–ø–ª–µ–Ω–æ: ${item.purchase_date}</div>` : ''}
                ${warrantyStatus ? `
                  <div class="badge" style="margin-top:8px; border-color:${warrantyStatus.color}; background:${warrantyStatus.color}22;">
                    üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏—è: ${warrantyStatus.text}
                  </div>
                ` : ''}
                ${item.serial_number ? `<div class="muted" style="margin-top:8px; font-size:11px;">S/N: ${escapeHtml(item.serial_number)}</div>` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;

  $('#filterCategory').onchange = (e)=>{
    if(!state.inventoryFilter) state.inventoryFilter = {};
    state.inventoryFilter.category = e.target.value;
    renderInventory();
  };

  const propertyPicker = $('#propertyPicker');
  if(propertyPicker){
    propertyPicker.onchange = () => {
      setCurrentPropertyId(propertyPicker.value);
      if(!state.inventoryFilter) state.inventoryFilter = {};
      state.inventoryFilter.room = 'all';
      renderInventory();
    };
  }

  $('#filterRoom').onchange = (e)=>{
    if(!state.inventoryFilter) state.inventoryFilter = {};
    state.inventoryFilter.room = e.target.value;
    renderInventory();
  };
  $('#filterStatus').onchange = (e)=>{
    if(!state.inventoryFilter) state.inventoryFilter = {};
    state.inventoryFilter.status = e.target.value;
    renderInventory();
  };
}

async function deleteInventoryItem(itemId){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è?')) return;
  const res = await api.inventory.delete({ id: itemId });
  if(!res.ok) return toast(res.error);
  toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
  renderInventory();
}

async function openInventoryModal(propertyId, itemId = null){
  const roomsRes = await api.rooms.list({ property_id: propertyId });
  const rooms = roomsRes.ok ? roomsRes.data : [];

  let existing = null;
  if(itemId){
    const res = await api.inventory.get({ id: itemId });
    if(!res.ok) return toast(res.error);
    existing = res.data;
  }

  const categories = [
    { value: 'electronics', label: 'üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞' },
    { value: 'appliances', label: 'üîå –ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞' },
    { value: 'furniture', label: 'üõãÔ∏è –ú–µ–±–µ–ª—å' },
    { value: 'tools', label: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' },
    { value: 'kitchen', label: 'üç≥ –ö—É—Ö–æ–Ω–Ω–∞—è —É—Ç–≤–∞—Ä—å' },
    { value: 'decor', label: 'üñºÔ∏è –î–µ–∫–æ—Ä' },
    { value: 'other', label: 'üì¶ –ü—Ä–æ—á–µ–µ' }
  ];

  const title = existing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç' : '–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç';

  const html = `
    <div class="form">
      <div>
        <label class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
        <select class="input" id="itemCategory">
          ${categories.map(c=>`<option value="${c.value}" ${existing?.category===c.value?'selected':''}>${c.label}</option>`).join('')}
        </select>
      </div>

      <div>
        <label class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input class="input" id="itemName" value="${escapeHtml(existing?.name||'')}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ Samsung" />
      </div>

      <div class="formRow">
        <div>
          <label class="muted">–ë—Ä–µ–Ω–¥</label>
          <input class="input" id="itemBrand" value="${escapeHtml(existing?.brand||'')}" placeholder="Samsung" />
        </div>
        <div>
          <label class="muted">–ú–æ–¥–µ–ª—å</label>
          <input class="input" id="itemModel" value="${escapeHtml(existing?.model||'')}" placeholder="RB37J5000SA" />
        </div>
      </div>

      <div>
        <label class="muted">–ö–æ–º–Ω–∞—Ç–∞</label>
        <select class="input" id="itemRoom">
          <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
          ${rooms.map(r=>`<option value="${r.id}" ${existing?.room_id===r.id?'selected':''}>${escapeHtml(r.name)}</option>`).join('')}
        </select>
      </div>

      <div class="formRow">
        <div>
          <label class="muted">–°—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
          <input type="number" class="input" id="itemPrice" value="${existing?.purchase_price||''}" placeholder="50000" />
        </div>
        <div>
          <label class="muted">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label>
          <input type="date" class="input" id="itemPurchaseDate" value="${existing?.purchase_date||''}" />
        </div>
      </div>

      <div class="formRow">
        <div>
          <label class="muted">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label>
          <input class="input" id="itemSerial" value="${escapeHtml(existing?.serial_number||'')}" placeholder="ABC123456789" />
        </div>
        <div>
          <label class="muted">–ì–∞—Ä–∞–Ω—Ç–∏—è –¥–æ</label>
          <input type="date" class="input" id="itemWarranty" value="${existing?.warranty_until||''}" />
        </div>
      </div>

      <div>
        <label class="muted">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea class="input" id="itemNotes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">${escapeHtml(existing?.notes||'')}</textarea>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="saveItemBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="closeModal();">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal(title, html, (root)=>{
    $('#saveItemBtn', root).onclick = async ()=>{
      const name = $('#itemName', root).value.trim();
      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');

      const payload = {
        property_id: propertyId,
        category: $('#itemCategory', root).value,
        name,
        brand: $('#itemBrand', root).value.trim(),
        model: $('#itemModel', root).value.trim(),
        room_id: $('#itemRoom', root).value || null,
        purchase_price: parseFloat($('#itemPrice', root).value) || null,
        purchase_date: $('#itemPurchaseDate', root).value || null,
        serial_number: $('#itemSerial', root).value.trim(),
        warranty_until: $('#itemWarranty', root).value || null,
        notes: $('#itemNotes', root).value.trim()
      };

      let res;
      if(existing) res = await api.inventory.update({ id: existing.id, patch: payload });
      else res = await api.inventory.create(payload);

      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderInventory();
    };
  });
}

// ============================================
// NEW MODULE: CONTACTS (v2.0)
// ============================================

async function renderContacts(){
  const contactsRes = await api.contacts.list({});
  if(!contactsRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(contactsRes.error)}</div>`;

  const contacts = contactsRes.data;

  const contactTypes = {
    property_manager: { name: '–£–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è', icon: 'üè¢', color: '#3b82f6' },
    repair_service: { name: '–°–ª—É–∂–±–∞ —Ä–µ–º–æ–Ω—Ç–∞', icon: 'üîß', color: '#ef4444' },
    utility_company: { name: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏', icon: 'üí°', color: '#f59e0b' },
    emergency: { name: '–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã', icon: 'üö®', color: '#dc2626' },
    other: { name: '–ü—Ä–æ—á–µ–µ', icon: 'üìû', color: '#6b7280' }
  };

  const filterType = state.contactsFilter?.type || 'all';

  let filteredContacts = contacts;
  if(filterType !== 'all') filteredContacts = filteredContacts.filter(c => c.type === filterType);

  // Sort favorites first
  filteredContacts.sort((a, b) => {
    if(a.is_favorite && !b.is_favorite) return -1;
    if(!a.is_favorite && b.is_favorite) return 1;
    return 0;
  });

  $('#content').innerHTML = `
    <div class="h1">üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>

    <div class="card" style="margin-bottom:16px;">
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–¢–∏–ø –∫–æ–Ω—Ç–∞–∫—Ç–∞</label>
          <select class="input" id="filterType">
            <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
            ${Object.entries(contactTypes).map(([k,v])=>`
              <option value="${k}" ${filterType===k?'selected':''}>${v.icon} ${v.name}</option>
            `).join('')}
          </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" id="btnAddContact">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
        </div>
      </div>
    </div>

    ${filteredContacts.length === 0 ? `
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">üìû</div>
        <div class="h1" style="margin-bottom:10px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <p style="color:var(--muted); margin-bottom:24px;">
          ${filterType === 'all' ? '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞–∂–Ω—ã–º –Ω–æ–º–µ—Ä–∞–º.' : '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞.'}
        </p>
        ${filterType === 'all' ? `<button class="btn" id="btnAddContactEmpty">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>` : ''}
      </div>
    ` : `
      <div class="grid">
        ${filteredContacts.map(contact=>{
          const type = contactTypes[contact.type] || contactTypes.other;

          return `
            <div class="card" style="border-left:4px solid ${type.color};">
              <div class="cardHeader">
                <div>
                  <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                    <div style="font-size:20px;">${type.icon}</div>
                    ${contact.is_favorite ? `<div style="font-size:16px;">‚≠ê</div>` : ''}
                  </div>
                  <div class="cardTitle">${escapeHtml(contact.name)}</div>
                  <div class="muted" style="font-size:12px; margin-top:2px;">${type.name}</div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" data-contact-edit="${contact.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                  <button class="iconBtn" data-contact-delete="${contact.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                </div>
              </div>
              <div class="cardBody">
                ${contact.company ? `<div style="font-weight:600; margin-bottom:8px;">${escapeHtml(contact.company)}</div>` : ''}
                ${contact.phone ? `
                  <div style="margin-bottom:6px;">
                    <a href="tel:${escapeHtml(contact.phone)}" style="color:var(--accent); text-decoration:none;">
                      üì± ${escapeHtml(contact.phone)}
                    </a>
                  </div>
                ` : ''}
                ${contact.email ? `
                  <div style="margin-bottom:6px;">
                    <a href="mailto:${escapeHtml(contact.email)}" style="color:var(--accent); text-decoration:none; font-size:12px;">
                      ‚úâÔ∏è ${escapeHtml(contact.email)}
                    </a>
                  </div>
                ` : ''}
                ${contact.address ? `<div class="muted" style="font-size:12px; margin-top:8px;">üìç ${escapeHtml(contact.address)}</div>` : ''}
                ${contact.notes ? `<div class="muted" style="font-size:12px; margin-top:8px; font-style:italic;">${escapeHtml(contact.notes)}</div>` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;

  $('#filterType').onchange = (e)=>{
    if(!state.contactsFilter) state.contactsFilter = {};
    state.contactsFilter.type = e.target.value;
    renderContacts();
  };

  // Attach event listeners (CSP-compliant)
  const btnAdd = $('#btnAddContact');
  if(btnAdd) btnAdd.onclick = () => openContactModal();

  const btnAddEmpty = $('#btnAddContactEmpty');
  if(btnAddEmpty) btnAddEmpty.onclick = () => openContactModal();

  $$('[data-contact-edit]').forEach(btn => {
    btn.onclick = () => openContactModal(btn.dataset.contactEdit);
  });

  $$('[data-contact-delete]').forEach(btn => {
    btn.onclick = () => deleteContact(btn.dataset.contactDelete);
  });
}

async function deleteContact(contactId){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç?')) return;
  const res = await api.contacts.delete({ id: contactId });
  if(!res.ok) return toast(res.error);
  toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
  renderContacts();
}

async function openContactModal(contactId = null){
  let existing = null;
  if(contactId){
    const res = await api.contacts.get({ id: contactId });
    if(!res.ok) return toast(res.error);
    existing = res.data;
  }

  const contactTypes = [
    { value: 'property_manager', label: 'üè¢ –£–ø—Ä–∞–≤–ª—è—é—â–∞—è –∫–æ–º–ø–∞–Ω–∏—è' },
    { value: 'repair_service', label: 'üîß –°–ª—É–∂–±–∞ —Ä–µ–º–æ–Ω—Ç–∞' },
    { value: 'utility_company', label: 'üí° –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏' },
    { value: 'emergency', label: 'üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã' },
    { value: 'other', label: 'üìû –ü—Ä–æ—á–µ–µ' }
  ];

  const title = existing ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç' : '–ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç';

  const html = `
    <div class="form">
      <div>
        <label class="muted">–¢–∏–ø *</label>
        <select class="input" id="contactType">
          ${contactTypes.map(c=>`<option value="${c.value}" ${existing?.type===c.value?'selected':''}>${c.label}</option>`).join('')}
        </select>
      </div>

      <div>
        <label class="muted">–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ *</label>
        <input class="input" id="contactName" value="${escapeHtml(existing?.name||'')}" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
      </div>

      <div>
        <label class="muted">–ö–æ–º–ø–∞–Ω–∏—è/–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
        <input class="input" id="contactCompany" value="${escapeHtml(existing?.company||'')}" placeholder="–û–û–û '–ñ–∏–ª—Å–µ—Ä–≤–∏—Å'" />
      </div>

      <div class="formRow">
        <div>
          <label class="muted">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input type="tel" class="input" id="contactPhone" value="${escapeHtml(existing?.phone||'')}" placeholder="+7 (999) 123-45-67" />
        </div>
        <div>
          <label class="muted">Email</label>
          <input type="email" class="input" id="contactEmail" value="${escapeHtml(existing?.email||'')}" placeholder="info@example.com" />
        </div>
      </div>

      <div>
        <label class="muted">–ê–¥—Ä–µ—Å</label>
        <input class="input" id="contactAddress" value="${escapeHtml(existing?.address||'')}" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, 10" />
      </div>

      <div>
        <label class="muted">–ó–∞–º–µ—Ç–∫–∏</label>
        <textarea class="input" id="contactNotes" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...">${escapeHtml(existing?.notes||'')}</textarea>
      </div>

      <div>
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="contactFavorite" ${existing?.is_favorite?'checked':''} />
          <span>‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </label>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <button class="btn" id="saveContactBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" onclick="closeModal();">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  `;

  openModal(title, html, (root)=>{
    $('#saveContactBtn', root).onclick = async ()=>{
      const name = $('#contactName', root).value.trim();
      const phone = $('#contactPhone', root).value.trim();
      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞');
      if(!phone) return toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');

      const payload = {
        type: $('#contactType', root).value,
        name,
        company: $('#contactCompany', root).value.trim(),
        phone,
        email: $('#contactEmail', root).value.trim(),
        address: $('#contactAddress', root).value.trim(),
        notes: $('#contactNotes', root).value.trim(),
        is_favorite: $('#contactFavorite', root).checked
      };

      let res;
      if(existing) res = await api.contacts.update({ id: existing.id, patch: payload });
      else res = await api.contacts.create(payload);

      if(!res.ok) return toast(res.error);

      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderContacts();
    };
  });
}

// ============================================
// NEW MODULE: CHECKLISTS (v2.0)
// ============================================

async function renderChecklists(){
  const checklistsRes = await api.checklists.list();
  if(!checklistsRes.ok) return $('#content').innerHTML=`<div class="h1">–û—à–∏–±–∫–∞: ${escapeHtml(checklistsRes.error)}</div>`;

  const checklists = checklistsRes.data;
  if(!state.checklistsFilter) state.checklistsFilter = { status: 'all' };
  const checklistStatus = state.checklistsFilter.status || 'all';

  // Get progress for all checklists
  const checklistsWithProgress = await Promise.all(checklists.map(async (cl)=>{
    const progRes = await api.checklists.getProgress({ id: cl.id });
    const progress = progRes.ok ? normalizeChecklistProgress(progRes.data, cl) : { completed: [], total: cl.items.length };
    return { ...cl, progress };
  }));

  const checklistCategories = {
    moving: { name: '–ü–µ—Ä–µ–µ–∑–¥', icon: 'üì¶', color: '#3b82f6' },
    seasonal: { name: '–°–µ–∑–æ–Ω–Ω—ã–π', icon: 'üçÇ', color: '#f59e0b' },
    safety: { name: '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', icon: 'üõ°Ô∏è', color: '#ef4444' },
    maintenance: { name: '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', icon: 'üîß', color: '#8b5cf6' },
    other: { name: '–ü—Ä–æ—á–µ–µ', icon: '‚úÖ', color: '#6b7280' }
  };

  const filteredChecklists = checklistsWithProgress.filter(cl=>{
    if(checklistStatus === 'all') return true;
    const completed = cl.progress.completed.length;
    const total = cl.progress.total;
    if(checklistStatus === 'done') return total > 0 && completed === total;
    if(checklistStatus === 'active') return total > 0 && completed < total;
    return true;
  });

  $('#content').innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="h1">‚úÖ –ß–µ–∫-–ª–∏—Å—Ç—ã</div>
      <button class="btn" id="addChecklistBtn">+ –ß–µ–∫-–ª–∏—Å—Ç</button>
    </div>
    <div class="row" style="margin-top:8px; gap:8px;">
      <button class="btn ${checklistStatus==='all'?'warn':''}" data-checklist-filter="all">–í—Å–µ</button>
      <button class="btn ${checklistStatus==='done'?'warn':''}" data-checklist-filter="done">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
      <button class="btn ${checklistStatus==='active'?'warn':''}" data-checklist-filter="active">–í —Ä–∞–±–æ—Ç–µ</button>
    </div>

    <div class="card" style="margin-bottom:16px; padding:20px;">
      <div class="muted" style="margin-bottom:8px;">–ß–µ–∫-–ª–∏—Å—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç –Ω–µ –∑–∞–±—ã—Ç—å –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>
      <div style="font-size:14px;">
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —á–µ–∫-–ª–∏—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ–µ–∑–¥–∞, —Å–µ–∑–æ–Ω–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–æ–º–∞.
      </div>
    </div>

    ${filteredChecklists.length === 0 ? `
      <div class="card" style="padding:60px; text-align:center;">
        <div style="font-size:48px; margin-bottom:16px;">‚úÖ</div>
        <div class="h1" style="margin-bottom:10px;">–ß–µ–∫-–ª–∏—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        <p style="color:var(--muted);">
          –ß–µ–∫-–ª–∏—Å—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.
        </p>
      </div>
    ` : `
      <div class="grid">
        ${filteredChecklists.map(checklist=>{
          const cat = checklistCategories[checklist.category] || checklistCategories.other;
          const completedCount = checklist.progress.completed.length;
          const totalCount = checklist.progress.total;
          const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

          return `
            <div class="card" style="border-left:4px solid ${cat.color};">
              <div class="cardHeader" style="justify-content:space-between;">
                <div>
                  <div style="font-size:24px; margin-bottom:4px;">${cat.icon}</div>
                  <div class="cardTitle">${escapeHtml(checklist.name)}</div>
                  <div class="muted" style="font-size:12px; margin-top:2px;">${cat.name}</div>
                </div>
                <div class="itemActions">
                  <label style="display:flex; align-items:center; gap:6px; cursor:pointer; margin-right:8px;" title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ">
                    <input type="checkbox" ${checklist.is_active ? 'checked' : ''} data-checklist-toggle="${checklist.id}" style="cursor:pointer;">
                    <span style="font-size:12px; color:var(--muted);">–ê–∫—Ç–∏–≤–µ–Ω</span>
                  </label>
                  <button class="iconBtn" data-checklist-edit="${checklist.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
                  <button class="iconBtn danger" data-checklist-del="${checklist.id}" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
                </div>
              </div>
              <div class="cardBody">
                ${checklist.description ? `<div class="muted" style="margin-bottom:12px; font-size:13px;">${escapeHtml(checklist.description)}</div>` : ''}

                <div style="margin-bottom:12px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <div class="muted" style="font-size:12px;">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                    <div style="font-size:14px; font-weight:600;">${completedCount} / ${totalCount}</div>
                  </div>
                  <div style="background:var(--border); height:8px; border-radius:999px; overflow:hidden;">
                    <div style="background:var(--ok); height:100%; width:${percentage}%; transition:width 0.3s;"></div>
                  </div>
                  <div class="muted" style="font-size:11px; margin-top:4px; text-align:right;">${percentage}%</div>
                </div>

                <div class="row" style="gap:8px;">
                  <button class="btn" data-checklist-open="${checklist.id}" style="flex:1;">–û—Ç–∫—Ä—ã—Ç—å</button>
                  ${completedCount > 0 ? `
                    <button class="iconBtn" data-checklist-reset="${checklist.id}" title="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">üîÑ</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `}
  `;

  const addBtn = $('#addChecklistBtn');
  if(addBtn) addBtn.onclick = ()=>openChecklistModal();
  $$('[data-checklist-filter]').forEach(btn=>{
    btn.onclick=()=>{
      state.checklistsFilter.status = btn.dataset.checklistFilter;
      renderChecklists();
    };
  });

  $$('[data-checklist-open]').forEach(btn=>{
    btn.onclick=()=>viewChecklist(btn.dataset.checklistOpen);
  });
  $$('[data-checklist-reset]').forEach(btn=>{
    btn.onclick=()=>resetChecklistProgress(btn.dataset.checklistReset);
  });
  $$('[data-checklist-edit]').forEach(btn=>{
    const cl = checklistsWithProgress.find(c=>c.id===btn.dataset.checklistEdit);
    if(cl) btn.onclick=()=>openChecklistModal(cl);
  });
  $$('[data-checklist-del]').forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —á–µ–∫-–ª–∏—Å—Ç?')) return;
      const r = await api.checklists.delete({ id: btn.dataset.checklistDel });
      if(!r.ok) return toast(r.error, 'error');
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
      renderChecklists();
    };
  });
  $$('[data-checklist-toggle]').forEach(checkbox=>{
    checkbox.onchange=async ()=>{
      const id = checkbox.dataset.checklistToggle;
      const is_active = checkbox.checked;
      const r = await api.checklists.update({ id, patch: { is_active } });
      if(!r.ok) return toast(r.error, 'error');
      toast(is_active ? '–ß–µ–∫-–ª–∏—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–ß–µ–∫-–ª–∏—Å—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
    };
  });
}

function openChecklistModal(existing=null){
  const isEdit = Boolean(existing?.id);
  const categories = [
    { value: 'moving', label: 'üì¶ –ü–µ—Ä–µ–µ–∑–¥' },
    { value: 'seasonal', label: 'üçÇ –°–µ–∑–æ–Ω–Ω—ã–π' },
    { value: 'safety', label: 'üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å' },
    { value: 'maintenance', label: 'üîß –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' },
    { value: 'other', label: '‚úÖ –ü—Ä–æ—á–µ–µ' }
  ];

  const itemsText = (existing?.items || [])
    .map(item => (typeof item === 'string' ? item : (item?.text || '')).trim())
    .filter(Boolean)
    .join('\n');

  const html = `
    <div class="form">
      <div class="formRow">
        <input class="input" id="checklistName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(existing?.name||'')}" />
        <select id="checklistCategory">
          ${categories.map(c=>`<option value="${c.value}" ${existing?.category===c.value?'selected':''}>${c.label}</option>`).join('')}
        </select>
      </div>
      <textarea class="input" id="checklistDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">${escapeHtml(existing?.description||'')}</textarea>
      <textarea class="input" id="checklistItems" rows="8" placeholder="–ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏">${escapeHtml(itemsText)}</textarea>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn" id="saveChecklistBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `;

  openModal(isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ–∫-–ª–∏—Å—Ç' : '–ù–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç', html, (root)=>{
    $('#saveChecklistBtn', root).onclick = async ()=>{
      const name = $('#checklistName', root).value.trim();
      const category = $('#checklistCategory', root).value;
      const description = $('#checklistDesc', root).value.trim();
      const items = $('#checklistItems', root).value
        .split('\n')
        .map(s=>s.trim())
        .filter(Boolean);

      if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
      if(items.length === 0) return toast('–î–æ–±–∞–≤—å—Ç–µ –ø—É–Ω–∫—Ç—ã');

      const payload = { name, category, description, items };
      let res;
      if(isEdit) res = await api.checklists.update({ id: existing.id, patch: payload });
      else res = await api.checklists.create(payload);

      if(!res.ok) return toast(res.error);
      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderChecklists();
    };
  });
}

function openExpenseModal(existing){
  if(!existing) return;
  openModal('–†–∞—Å—Ö–æ–¥ / –≤–∑–Ω–æ—Å', `
    <div class="form">
      <div class="formRow">
        <input class="input" id="expenseAmount" placeholder="–°—É–º–º–∞ (–º–æ–∂–Ω–æ —Å–æ –∑–Ω–∞–∫–æ–º)" value="${escapeHtml(String(existing.amount ?? 0))}" />
        <input type="date" class="input" id="expenseDate" value="${escapeHtml(existing.spent_at||todayISO())}" />
      </div>
      <textarea class="input" id="expenseNote" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">${escapeHtml(existing.note||'')}</textarea>
      <div class="muted" style="font-size:12px;">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞ = –≤–∑–Ω–æ—Å (—Å–æ–±—Ä–∞–Ω–æ)</div>
      <div class="row" style="justify-content:space-between;">
        <button class="btn danger" id="expenseDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn" id="expenseSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  `, (root)=>{
    $('#expenseSaveBtn', root).onclick = async ()=>{
      const amount = Number($('#expenseAmount', root).value.trim());
      const spent_at = $('#expenseDate', root).value.trim() || todayISO();
      const note = $('#expenseNote', root).value.trim();
      if(Number.isNaN(amount)) return toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É');
      const r = await api.expenses.update({ id: existing.id, patch: { amount, spent_at, note } });
      if(!r.ok) return toast(r.error, 'error');
      closeModal();
      toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
      renderCalendar();
    };
    $('#expenseDeleteBtn', root).onclick = async ()=>{
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
      const r = await api.expenses.delete({ id: existing.id });
      if(!r.ok) return toast(r.error, 'error');
      closeModal();
      toast('–£–¥–∞–ª–µ–Ω–æ', 'success');
      renderCalendar();
    };
  });
}

async function viewChecklist(checklistId){
  const clRes = await api.checklists.get({ id: checklistId });
  if(!clRes.ok) return toast(clRes.error);

  const checklist = clRes.data;

  const progRes = await api.checklists.getProgress({ id: checklistId });
  const progress = progRes.ok ? normalizeChecklistProgress(progRes.data, checklist) : { completed: [], total: checklist.items.length };

  const html = `
    <div>
      <div style="font-size:20px; font-weight:700; margin-bottom:8px;">${escapeHtml(checklist.name)}</div>
      ${checklist.description ? `<div class="muted" style="margin-bottom:16px;">${escapeHtml(checklist.description)}</div>` : ''}

      <div style="margin-bottom:16px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
          <div style="font-weight:600;">${progress.completed.length} / ${progress.total}</div>
        </div>
        <div style="background:var(--border); height:10px; border-radius:999px; overflow:hidden;">
          <div style="background:var(--ok); height:100%; width:${Math.round((progress.completed.length / progress.total) * 100)}%; transition:width 0.3s;"></div>
        </div>
      </div>

      <div class="list" style="max-height:60vh; overflow:auto;">
        ${checklist.items.map((item, idx)=>{
          const text = typeof item === 'string' ? item : (item?.text || '');
          const isCompleted = progress.completed.includes(idx);
          return `
            <label class="item" style="cursor:pointer; ${isCompleted ? 'opacity:0.6;' : ''}">
              <div class="row" style="align-items:flex-start; gap:12px;">
                <input
                  type="checkbox"
                  ${isCompleted ? 'checked' : ''}
                  data-checklist-toggle="${checklistId}"
                  data-item-index="${idx}"
                  style="margin-top:4px; cursor:pointer;"
                />
                <div style="flex:1; ${isCompleted ? 'text-decoration:line-through;' : ''}">${escapeHtml(text)}</div>
              </div>
            </label>
          `;
        }).join('')}
      </div>

      <div class="row" style="gap:12px; margin-top:16px;">
        <button class="btn" id="closeChecklistModal">–ó–∞–∫—Ä—ã—Ç—å</button>
        ${progress.completed.length > 0 ? `
          <button class="btn" id="resetChecklistProgressBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        ` : ''}
      </div>
    </div>
  `;

  openModal(`–ß–µ–∫-–ª–∏—Å—Ç: ${checklist.name}`, html, (root)=>{
    const closeBtn = $('#closeChecklistModal', root);
    if(closeBtn) closeBtn.onclick = closeModal;
    const resetBtn = $('#resetChecklistProgressBtn', root);
    if(resetBtn){
      resetBtn.onclick = async ()=>{
        await resetChecklistProgress(checklistId);
        closeModal();
      };
    }
    $$('[data-checklist-toggle]', root).forEach(input=>{
      input.onchange = () => toggleChecklistItem(
        input.dataset.checklistToggle,
        Number(input.dataset.itemIndex)
      );
    });
  });
}

async function toggleChecklistItem(checklistId, itemIndex){
  const res = await api.checklists.toggleItem({ checklistId, itemIndex });
  if(!res.ok) return toast(res.error);

  // Refresh the modal view
  viewChecklist(checklistId);
}

async function resetChecklistProgress(checklistId){
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ–∫-–ª–∏—Å—Ç–∞?')) return;
  const res = await api.checklists.resetProgress({ id: checklistId });
  if(!res.ok) return toast(res.error);
  toast('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω');
  renderChecklists();
}

async function computeStatsData(filter){
  const now = new Date();
  const range = filter.range || 'month';
  let from = null;
  let to = startOfDayLocal(now);

  if(range === 'today') from = startOfDayLocal(now);
  if(range === 'week') from = startOfWeek(now);
  if(range === 'month') from = startOfMonth(now);
  if(range === 'quarter') from = startOfQuarter(now);
  if(range === 'year') from = startOfYear(now);
  if(range === 'custom'){
    from = filter.from ? parseISODate(filter.from) : startOfMonth(now);
    to = filter.to ? parseISODate(filter.to) : startOfDayLocal(now);
  }
  if(range === 'all'){
    from = null;
    to = null;
  }

  const [
    tasksRes, expensesRes, logsRes,
    inventoryRes, roomsRes, metersRes, propertiesRes,
    contactsRes, documentsRes, checklistsRes, assetsRes, goalsRes
  ] = await Promise.all([
    api.tasks.list({ profile_id: state.profileId, status:'all', range:'all' }),
    api.expenses.list({}),
    api.maintenance.logs.list({}),
    api.inventory.list({}),
    api.rooms.list({}),
    api.meters.list({}),
    api.properties.list(),
    api.contacts.list({}),
    api.documents.list({}),
    api.checklists.list(),
    api.assets.list(),
    api.goals.list({ status:'all' })
  ]);

  const tasks = tasksRes.ok ? tasksRes.data : [];
  const expenses = expensesRes.ok ? expensesRes.data : [];
  const logs = logsRes.ok ? logsRes.data : [];
  const inventory = inventoryRes.ok ? inventoryRes.data : [];
  const rooms = roomsRes.ok ? roomsRes.data : [];
  const meters = metersRes.ok ? metersRes.data : [];
  const properties = propertiesRes.ok ? propertiesRes.data : [];
  const contacts = contactsRes.ok ? contactsRes.data : [];
  const documents = documentsRes.ok ? documentsRes.data : [];
  const checklists = checklistsRes.ok ? checklistsRes.data : [];
  const assets = assetsRes.ok ? assetsRes.data : [];
  const goals = goalsRes.ok ? goalsRes.data : [];

  const propertyId = filter.propertyId && filter.propertyId !== 'all' ? filter.propertyId : null;
  const assetId = filter.assetId && filter.assetId !== 'all' ? filter.assetId : null;
  const onlyCurrent = filter.onlyCurrent !== false;
  const filteredInventory = propertyId ? inventory.filter(i=>i.property_id===propertyId) : inventory;
  const filteredRooms = propertyId ? rooms.filter(r=>r.property_id===propertyId) : rooms;
  const filteredMeters = propertyId ? meters.filter(m=>m.property_id===propertyId) : meters;

  const tasksDone = tasks.filter(t => t.status === 'done' && inRange(t.done_at, from, to));
  const routinesDone = tasksDone.filter(t => t.linked?.type === 'routine').length;
  const tasksDonePlain = tasksDone.filter(t => t.linked?.type !== 'routine').length;

  const checklistProgress = await Promise.all(checklists.map(async (cl)=>{
    const progRes = await api.checklists.getProgress({ id: cl.id });
    return { checklist: cl, progress: progRes.ok ? progRes.data : null };
  }));

  const checklistsCompleted = checklistProgress.filter(({ checklist, progress })=>{
    if(!progress) return false;
    const completed = progress.completed_items || [];
    const total = Array.isArray(checklist.items) ? checklist.items.length : 0;
    if(total === 0 || completed.length !== total) return false;
    return inRange(progress.last_updated, from, to);
  }).length;

  const existingAssetIds = new Set(assets.map(a=>a.id));
  const existingGoalIds = new Set(
    goals.filter(g=>!onlyCurrent || g.status !== 'archived').map(g=>g.id)
  );
  const expenseLogIds = new Set(expenses.map(e=>e.log_id).filter(Boolean));
  const expenseFilter = (e) => {
    if(assetId && e.asset_id !== assetId) return false;
    if(onlyCurrent){
      if(e.asset_id && !existingAssetIds.has(e.asset_id)) return false;
      if(e.goal_id && !existingGoalIds.has(e.goal_id)) return false;
      if(e.amount < 0 && !e.goal_id) return false;
    }
    return true;
  };
  const logFilter = (l) => {
    if(assetId && l.asset_id !== assetId) return false;
    if(onlyCurrent && l.asset_id && !existingAssetIds.has(l.asset_id)) return false;
    return true;
  };

  const spentFromExpenses = expenses
    .filter(expenseFilter)
    .filter(e => e.amount > 0 && inRange(e.spent_at, from, to))
    .reduce((sum, e)=>sum + clampNumber(Number(e.amount)), 0);
  const collected = expenses
    .filter(expenseFilter)
    .filter(e => e.amount < 0 && inRange(e.spent_at, from, to))
    .reduce((sum, e)=>sum + Math.abs(clampNumber(Number(e.amount))), 0);
  const spentFromLogs = logs
    .filter(logFilter)
    .filter(l => l.cost != null && Number(l.cost) > 0 && inRange(l.done_at, from, to) && !expenseLogIds.has(l.id))
    .reduce((sum, l)=>sum + clampNumber(Number(l.cost)), 0);
  const spent = spentFromExpenses + spentFromLogs;

  const totalDoneCombined = tasksDonePlain + routinesDone + checklistsCompleted;

  const inventoryValue = filteredInventory.reduce((sum, item)=>sum + (Number(item.purchase_price) || 0), 0);

  let chartFrom = from;
  let chartTo = to;
  if(!chartFrom || !chartTo){
    chartTo = startOfDayLocal(now);
    chartFrom = new Date(chartTo.getFullYear(), chartTo.getMonth()-5, 1);
  }
  const unit = (chartTo - chartFrom) / (24*3600*1000) <= 62 ? 'day' : 'month';
  const buckets = makeBuckets(chartFrom, chartTo, unit);
  const bucketMap = new Map(buckets.map(b=>[b.label, b]));

  const addToBucket = (iso, field, value) => {
    if(!iso) return;
    const label = unit === 'day' ? iso : iso.slice(0,7);
    const bucket = bucketMap.get(label);
    if(bucket) bucket[field] += value;
  };

  expenses.filter(expenseFilter).forEach(e=>{
    if(!inRange(e.spent_at, chartFrom, chartTo)) return;
    if(e.amount > 0) addToBucket(e.spent_at, 'spent', clampNumber(Number(e.amount)));
    if(e.amount < 0) addToBucket(e.spent_at, 'collected', Math.abs(clampNumber(Number(e.amount))));
  });
  logs.filter(logFilter).forEach(l=>{
    if(l.cost == null || Number(l.cost) <= 0) return;
    if(expenseLogIds.has(l.id)) return;
    if(!inRange(l.done_at, chartFrom, chartTo)) return;
    addToBucket(l.done_at, 'spent', clampNumber(Number(l.cost)));
  });
  tasks.forEach(t=>{
    if(t.status !== 'done') return;
    if(!inRange(t.done_at, chartFrom, chartTo)) return;
    addToBucket(t.done_at, 'done', 1);
  });
  checklistProgress.forEach(({ checklist, progress })=>{
    if(!progress) return;
    const completed = progress.completed_items || [];
    const total = Array.isArray(checklist.items) ? checklist.items.length : 0;
    if(total === 0 || completed.length !== total) return;
    if(!inRange(progress.last_updated, chartFrom, chartTo)) return;
    addToBucket(progress.last_updated, 'done', 1);
  });

  return {
    range,
    from: from ? toISODate(from) : '',
    to: to ? toISODate(to) : '',
    propertyId: propertyId || 'all',
    properties,
    assets,
    totals: {
      spent,
      collected,
      done: totalDoneCombined,
      tasksDone: tasksDonePlain,
      routinesDone,
      checklistsDone: checklistsCompleted,
      inventoryValue,
      inventoryCount: filteredInventory.length,
      roomsCount: filteredRooms.length,
      metersCount: filteredMeters.length,
      propertiesCount: propertyId ? 1 : properties.length,
      contactsCount: contacts.length,
      documentsCount: documents.length
    },
    series: buckets
  };
}

// ============================================
// STATS & ACHIEVEMENTS UI
// ============================================

async function renderStats(){
  if (!state.userStats) {
    await loadUserStats();
  }

  const stats = state.userStats;
  if (!stats) {
    $('#content').innerHTML = `
      <div class="h1">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
      <div class="card" style="padding:60px; text-align:center;">
        <div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
      </div>
    `;
    return;
  }

  const level = getLevelForXP(stats.xp);
  const { progressXP, requiredXP, percentage } = getXPProgressForCurrentLevel(stats.xp);

  const unlockedSet = new Set(stats.unlocked_achievements || []);
  const unlockedAchievements = ACHIEVEMENTS.filter(a => unlockedSet.has(a.id));
  const lockedAchievements = ACHIEVEMENTS.filter(a => !unlockedSet.has(a.id));

  if(!state.statsFilter){
    state.statsFilter = { range:'month', from:'', to: todayISO(), propertyId:'all', assetId:'all', segmented:false, onlyCurrent:true };
  }
  const statsFilter = state.statsFilter;
  if(!statsFilter.to) statsFilter.to = todayISO();
  const statsData = await computeStatsData(statsFilter);
  const formatMoney = (n) => `${Math.round(n).toLocaleString('ru-RU')} ‚ÇΩ`;
  const propertyOptions = ['<option value="all">–í—Å–µ</option>']
    .concat(statsData.properties.map(p=>`<option value="${p.id}" ${statsFilter.propertyId===p.id?'selected':''}>${escapeHtml(p.name)}</option>`))
    .join('');
  const assetOptions = ['<option value="all">–í—Å–µ</option>']
    .concat(statsData.assets.map(a=>`<option value="${a.id}" ${statsFilter.assetId===a.id?'selected':''}>${escapeHtml(a.name)}</option>`))
    .join('');

  const statsSection = `
    <div class="h1">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>

    <div class="card" style="margin-bottom:16px;">
      <div class="row" style="flex-wrap:wrap; gap:12px;">
        <div style="flex:1; min-width:180px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–ü–µ—Ä–∏–æ–¥</label>
          <select class="input" id="statsRange">
            <option value="today" ${statsFilter.range==='today'?'selected':''}>–°–µ–≥–æ–¥–Ω—è</option>
            <option value="week" ${statsFilter.range==='week'?'selected':''}>–ù–µ–¥–µ–ª—è</option>
            <option value="month" ${statsFilter.range==='month'?'selected':''}>–ú–µ—Å—è—Ü</option>
            <option value="quarter" ${statsFilter.range==='quarter'?'selected':''}>–ö–≤–∞—Ä—Ç–∞–ª</option>
            <option value="year" ${statsFilter.range==='year'?'selected':''}>–ì–æ–¥</option>
            <option value="custom" ${statsFilter.range==='custom'?'selected':''}>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ</option>
            <option value="all" ${statsFilter.range==='all'?'selected':''}>–í—Å–µ –≤—Ä–µ–º—è</option>
          </select>
        </div>
        <div style="flex:1; min-width:160px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–û—Ç</label>
          <input type="date" class="input" id="statsFrom" value="${escapeHtml(statsFilter.from||'')}" />
        </div>
        <div style="flex:1; min-width:160px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–î–æ</label>
          <input type="date" class="input" id="statsTo" value="${escapeHtml(statsFilter.to||'')}" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</label>
          <select class="input" id="statsProperty">
            ${propertyOptions}
          </select>
        </div>
        <div style="flex:1; min-width:200px;">
          <label class="muted" style="display:block; margin-bottom:6px;">–û–±—ä–µ–∫—Ç –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</label>
          <select class="input" id="statsAsset">
            ${assetOptions}
          </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" id="statsRefreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <label style="display:flex; align-items:center; gap:8px; margin-top:12px;">
        <input type="checkbox" id="statsSegmented" ${statsFilter.segmented ? 'checked' : ''} />
        <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</span>
      </label>
      <label style="display:flex; align-items:center; gap:8px; margin-top:8px;">
        <input type="checkbox" id="statsOnlyCurrent" ${statsFilter.onlyCurrent ? 'checked' : ''} />
        <span class="muted">–¢–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö/–∞—Ä—Ö–∏–≤–∞)</span>
      </label>
    </div>

    <div class="grid" style="margin-bottom:16px;">
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
        </div>
        <div class="cardBody" style="font-size:22px; font-weight:700;">${formatMoney(statsData.totals.spent)}</div>
      </div>
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–°–æ–±—Ä–∞–Ω–æ</div>
        </div>
        <div class="cardBody" style="font-size:22px; font-weight:700;">${formatMoney(statsData.totals.collected)}</div>
      </div>
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–°–¥–µ–ª–∞–Ω–æ –≤—Å–µ–≥–æ</div>
        </div>
        <div class="cardBody" style="font-size:22px; font-weight:700;">${statsData.totals.done}</div>
      </div>
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        </div>
        <div class="cardBody">
          <div style="font-size:18px; font-weight:700;">${statsData.totals.inventoryCount}</div>
          <div class="muted">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${formatMoney(statsData.totals.inventoryValue)}</div>
        </div>
      </div>
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–ö–æ–º–Ω–∞—Ç—ã/–°—á—ë—Ç—á–∏–∫–∏</div>
        </div>
        <div class="cardBody">
          <div class="muted">–ö–æ–º–Ω–∞—Ç: ${statsData.totals.roomsCount}</div>
          <div class="muted">–°—á—ë—Ç—á–∏–∫–æ–≤: ${statsData.totals.metersCount}</div>
        </div>
      </div>
      <div class="card">
        <div class="cardHeader">
          <div class="cardTitle">–î–æ–∫—É–º–µ–Ω—Ç—ã/–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        </div>
        <div class="cardBody">
          <div class="muted">–î–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${statsData.totals.documentsCount}</div>
          <div class="muted">–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤: ${statsData.totals.contactsCount}</div>
        </div>
      </div>
    </div>

    ${statsFilter.segmented ? `
      <div class="card" style="margin-bottom:16px;">
        <div class="cardHeader"><div class="cardTitle">–°–¥–µ–ª–∞–Ω–æ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</div></div>
        <div class="cardBody">
          <div class="row" style="flex-wrap:wrap; gap:16px;">
            <div>–î–µ–ª–∞: <strong>${statsData.totals.tasksDone}</strong></div>
            <div>–†—É—Ç–∏–Ω—ã: <strong>${statsData.totals.routinesDone}</strong></div>
            <div>–ß–µ–∫-–ª–∏—Å—Ç—ã: <strong>${statsData.totals.checklistsDone}</strong></div>
          </div>
        </div>
      </div>
    ` : ''}

    <div class="card" style="margin-bottom:24px;">
      <div class="cardHeader">
        <div class="cardTitle">–î–∏–Ω–∞–º–∏–∫–∞</div>
      </div>
      <div class="cardBody">
        ${statsData.series.length === 0 ? '<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥.</div>' : `
          <div class="list">
            ${statsData.series.map(row=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${row.label}</div>
                  <div class="itemMeta">
                    <span class="badge">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatMoney(row.spent)}</span>
                    <span class="badge">–°–æ–±—Ä–∞–Ω–æ: ${formatMoney(row.collected)}</span>
                    <span class="badge ok">–°–¥–µ–ª–∞–Ω–æ: ${row.done}</span>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    </div>
  `;

  $('#content').innerHTML = `
    ${statsSection}
    <div class="h1">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</div>

    <!-- Level & XP Card -->
    <div class="card" style="margin-bottom:16px; background: linear-gradient(135deg, rgba(96,165,250,0.1) 0%, rgba(139,92,246,0.1) 100%);">
      <div class="row" style="align-items:center; flex-wrap:wrap; gap:20px;">
        <div style="flex:1; min-width:250px;">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
            <div style="font-size:48px;">‚≠ê</div>
            <div>
              <div style="font-size:28px; font-weight:700;">–£—Ä–æ–≤–µ–Ω—å ${level}</div>
              <div class="muted">${stats.xp.toLocaleString('ru-RU')} XP</div>
            </div>
          </div>

          <div style="margin-bottom:8px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <div class="muted" style="font-size:12px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —É—Ä–æ–≤–Ω—è ${level + 1}</div>
              <div style="font-size:14px; font-weight:600;">${progressXP} / ${requiredXP} XP</div>
            </div>
            <div style="background:var(--border); height:12px; border-radius:999px; overflow:hidden;">
              <div style="background:linear-gradient(90deg, var(--accent) 0%, var(--ok) 100%); height:100%; width:${percentage}%; transition:width 0.5s;"></div>
            </div>
            <div class="muted" style="font-size:11px; margin-top:4px; text-align:right;">${percentage}%</div>
          </div>
        </div>

        <div style="flex:1; min-width:250px;">
          <div class="row" style="gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:100px;">
              <div class="muted" style="margin-bottom:6px;">–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è</div>
              <div style="font-size:32px; font-weight:700; color:var(--warn);">${stats.current_streak || 0} üî•</div>
            </div>
            <div style="flex:1; min-width:100px;">
              <div class="muted" style="margin-bottom:6px;">–†–µ–∫–æ—Ä–¥ —Å–µ—Ä–∏–∏</div>
              <div style="font-size:32px; font-weight:700; color:var(--ok);">${stats.longest_streak || 0} üèÜ</div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
              <input type="checkbox" id="gamificationToggle" ${stats.gamification_enabled ? 'checked' : ''} />
              <span class="muted" style="font-size:13px;">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Achievements Section -->
    <div style="margin-bottom:16px;">
      <div style="font-size:20px; font-weight:700; margin-bottom:12px;">
        –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (${unlockedAchievements.length} / ${ACHIEVEMENTS.length})
      </div>
    </div>

    ${unlockedAchievements.length === 0 && lockedAchievements.length === 0 ? `
      <div class="card" style="padding:60px; text-align:center;">
        <div class="muted">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
      </div>
    ` : `
      ${unlockedAchievements.length > 0 ? `
        <div style="margin-bottom:24px;">
          <div class="muted" style="margin-bottom:8px; font-size:12px; text-transform:uppercase; letter-spacing:0.8px;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
          <div class="grid">
            ${unlockedAchievements.map(achievement => `
              <div class="card" style="border-left:4px solid var(--ok);">
                <div class="cardHeader">
                  <div>
                    <div style="font-size:32px; margin-bottom:4px;">${achievement.icon}</div>
                    <div class="cardTitle">${escapeHtml(achievement.name)}</div>
                  </div>
                  ${achievement.xp > 0 ? `<div class="badge ok">+${achievement.xp} XP</div>` : ''}
                </div>
                <div class="cardBody">
                  <div class="muted" style="font-size:13px;">${escapeHtml(achievement.description)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}

      ${lockedAchievements.length > 0 ? `
        <div>
          <div class="muted" style="margin-bottom:8px; font-size:12px; text-transform:uppercase; letter-spacing:0.8px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
          <div class="grid">
            ${lockedAchievements.map(achievement => `
              <div class="card" style="opacity:0.5; border-left:4px solid var(--border);">
                <div class="cardHeader">
                  <div>
                    <div style="font-size:32px; margin-bottom:4px; filter:grayscale(100%);">${achievement.icon}</div>
                    <div class="cardTitle">${escapeHtml(achievement.name)}</div>
                  </div>
                  ${achievement.xp > 0 ? `<div class="badge">+${achievement.xp} XP</div>` : ''}
                </div>
                <div class="cardBody">
                  <div class="muted" style="font-size:13px;">${escapeHtml(achievement.description)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    `}
  `;

  // Bind stats filters
  $('#statsRange').onchange = (e)=>{
    statsFilter.range = e.target.value;
    renderStats();
  };
  $('#statsFrom').onchange = (e)=>{
    statsFilter.from = e.target.value;
  };
  $('#statsTo').onchange = (e)=>{
    statsFilter.to = e.target.value;
  };
  $('#statsProperty').onchange = (e)=>{
    statsFilter.propertyId = e.target.value;
    renderStats();
  };
  $('#statsAsset').onchange = (e)=>{
    statsFilter.assetId = e.target.value;
    renderStats();
  };
  $('#statsSegmented').onchange = (e)=>{
    statsFilter.segmented = e.target.checked;
    renderStats();
  };
  $('#statsOnlyCurrent').onchange = (e)=>{
    statsFilter.onlyCurrent = e.target.checked;
    renderStats();
  };
  $('#statsRefreshBtn').onclick = ()=>renderStats();

  // Bind gamification toggle
  $('#gamificationToggle').onchange = async (e) => {
    const enabled = e.target.checked;
    await api.stats.update({ gamification_enabled: enabled });
    state.userStats.gamification_enabled = enabled;
    toast(enabled ? '–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞');
  };
}

async function renderCalendar(){
  if(!state.calendar) state.calendar = { month: todayISO().slice(0,7), selected: todayISO(), view:'month', showCompleted:false };
  const [y, m] = state.calendar.month.split('-').map(Number);
  const year = y;
  const monthIndex = m - 1;
  const selectedDate = state.calendar.selected || todayISO();
  const selectedDateObj = parseISODate(selectedDate) || new Date();
  const monthStart = new Date(year, monthIndex, 1);
  const monthEnd = new Date(year, monthIndex + 1, 0);

  const [
    tasksRes, plansRes, logsRes, expensesRes,
    goalsRes, metersRes, readingsRes, checklistsRes
  ] = await Promise.all([
    api.tasks.list({ profile_id: state.profileId, status:'all', range:'all' }),
    api.maintenance.plans.list({ range:'all', daysSoon:14, is_active:true }),
    api.maintenance.logs.list({}),
    api.expenses.list({}),
    api.goals.list({ status:'all' }),
    api.meters.list({}),
    api.meters.getReadings({}),
    api.checklists.list()
  ]);

  const tasks = tasksRes.ok ? tasksRes.data : [];
  const plans = plansRes.ok ? plansRes.data : [];
  const logs = logsRes.ok ? logsRes.data : [];
  const expenses = expensesRes.ok ? expensesRes.data : [];
  const goals = goalsRes.ok ? goalsRes.data : [];
  const meters = metersRes.ok ? metersRes.data : [];
  const readings = readingsRes.ok ? readingsRes.data : [];
  const checklists = checklistsRes.ok ? checklistsRes.data : [];

  const dayCounts = new Map();
  const addCount = (iso) => {
    if(!iso) return;
    const d = parseISODate(iso);
    if(!d || d < monthStart || d > monthEnd) return;
    const key = toISODate(d);
    dayCounts.set(key, (dayCounts.get(key) || 0) + 1);
  };

  tasks.forEach(t=>addCount(t.due_at));
  plans.forEach(p=>addCount(p.next_due_at));
  logs.forEach(l=>addCount(l.done_at));
  expenses.forEach(e=>addCount(e.spent_at));
  goals.forEach(g=>addCount(g.due_at));
  readings.forEach(r=>addCount(r.reading_date));

  const view = state.calendar.view || 'month';
  const grid = view === 'week' ? buildWeekGrid(selectedDateObj) : buildMonthGrid(year, monthIndex);

  $('#content').innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="h1">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
      <div class="row" style="gap:8px;">
        <button class="btn" data-cal-nav="prev">‚Üê</button>
        <div style="font-weight:700;">${view === 'month' ? monthLabel(year, monthIndex) : selectedDateObj.toLocaleDateString('ru-RU')}</div>
        <button class="btn" data-cal-nav="next">‚Üí</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ–ª–∞, –ø–ª–∞–Ω—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã</div>
        <div class="row" style="gap:8px;">
          <button class="btn ${view==='day'?'warn':''}" data-cal-view="day">–î–µ–Ω—å</button>
          <button class="btn ${view==='week'?'warn':''}" data-cal-view="week">–ù–µ–¥–µ–ª—è</button>
          <button class="btn ${view==='month'?'warn':''}" data-cal-view="month">–ú–µ—Å—è—Ü</button>
          <button class="btn" data-cal-today>–°–µ–≥–æ–¥–Ω—è</button>
        </div>
      </div>
      <label style="display:flex; align-items:center; gap:8px; margin-top:8px;">
        <input type="checkbox" id="calendarShowCompleted" ${state.calendar.showCompleted ? 'checked' : ''} />
        <span class="muted">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</span>
      </label>
    </div>

    ${view === 'day' ? '' : `
      <div class="card" style="margin-top:12px;">
        <div class="calendarHeader">
          ${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].map(d=>`<div class="calendarDayHeader">${d}</div>`).join('')}
        </div>
        <div class="calendar">
          ${grid.map(cell=>{
            const iso = toISODate(cell.date);
            const count = dayCounts.get(iso) || 0;
            const dots = Math.min(4, count);
            return `
              <div class="calendarDay ${cell.inMonth ? '' : 'mutedDay'} ${iso===selectedDate ? 'selected' : ''}" data-cal-day="${iso}">
                <div class="calendarDayNumber">${cell.date.getDate()}</div>
                ${count > 0 ? `
                  <div class="calendarDots">
                    ${Array.from({ length: dots }).map(()=>'<span class="calendarDot"></span>').join('')}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `}

    <div class="card" style="margin-top:12px;">
      <div class="cardHeader">
        <div class="cardTitle">–°–æ–±—ã—Ç–∏—è –Ω–∞ ${selectedDate}</div>
      </div>
      <div class="cardBody" id="calendarDetails"></div>
    </div>
  `;

  $$('[data-cal-nav]').forEach(btn=>{
    btn.onclick = ()=>{
      const dir = btn.dataset.calNav === 'prev' ? -1 : 1;
      if(view === 'month'){
        const next = new Date(year, monthIndex + dir, 1);
        state.calendar.month = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}`;
      } else if(view === 'week') {
        const next = new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), selectedDateObj.getDate() + (dir * 7));
        state.calendar.selected = toISODate(next);
        state.calendar.month = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}`;
      } else {
        const next = new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), selectedDateObj.getDate() + dir);
        state.calendar.selected = toISODate(next);
        state.calendar.month = `${next.getFullYear()}-${String(next.getMonth()+1).padStart(2,'0')}`;
      }
      renderCalendar();
    };
  });
  $$('[data-cal-day]').forEach(cell=>{
    cell.onclick = ()=>{
      state.calendar.selected = cell.dataset.calDay;
      renderCalendar();
    };
  });
  const todayBtn = $('[data-cal-today]');
  if(todayBtn){
    todayBtn.onclick = ()=>{
      state.calendar.month = todayISO().slice(0,7);
      state.calendar.selected = todayISO();
      renderCalendar();
    };
  }
  const completedToggle = $('#calendarShowCompleted');
  if(completedToggle){
    completedToggle.onchange = ()=>{
      state.calendar.showCompleted = completedToggle.checked;
      renderCalendar();
    };
  }
  $$('[data-cal-view]').forEach(btn=>{
    btn.onclick = ()=>{
      state.calendar.view = btn.dataset.calView;
      renderCalendar();
    };
  });

  const details = $('#calendarDetails');
  const filterDate = selectedDate;

  const tasksOnDay = tasks.filter(t=>t.due_at === filterDate);
  const doneTasksOnDay = state.calendar.showCompleted
    ? tasks.filter(t=>t.status === 'done' && t.done_at === filterDate)
    : [];
  const plansOnDay = plans.filter(p=>p.next_due_at === filterDate);
  const logsOnDay = logs.filter(l=>l.done_at === filterDate);
  const expensesOnDay = expenses.filter(e=>e.spent_at === filterDate);
  const goalsOnDay = goals.filter(g=>g.due_at === filterDate);
  const readingsOnDay = readings.filter(r=>r.reading_date === filterDate);

  const meterById = new Map(meters.map(m=>[m.id, m]));

  details.innerHTML = `
    ${tasksOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–î–µ–ª–∞ (${tasksOnDay.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${tasksOnDay.map(t=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${escapeHtml(t.title)}</div>
                  <div class="itemMeta">
                    ${t.due_at ? `<span class="badge">${t.due_at}</span>` : ''}
                  </div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" data-cal-task-open="${t.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    ${doneTasksOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–í—ã–ø–æ–ª–Ω–µ–Ω–æ (${doneTasksOnDay.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${doneTasksOnDay.map(t=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${escapeHtml(t.title)}</div>
                  <div class="itemMeta">
                    <span class="badge ok">–≥–æ—Ç–æ–≤–æ</span>
                    ${t.done_at ? `<span class="badge">${t.done_at}</span>` : ''}
                  </div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" data-cal-task-open="${t.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    ${plansOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–ü–ª–∞–Ω—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (${plansOnDay.length})</div></div>
        <div class="cardBody">${plansOnDay.map(planCardHtml).join('')}</div>
      </div>
    ` : ''}
    ${logsOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–ñ—É—Ä–Ω–∞–ª –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (${logsOnDay.length})</div></div>
        <div class="cardBody">${logsOnDay.map(logRowHtml).join('')}</div>
      </div>
    ` : ''}
    ${expensesOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–†–∞—Å—Ö–æ–¥—ã/–í–∑–Ω–æ—Å—ã (${expensesOnDay.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${expensesOnDay.map(e=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${escapeHtml(e.note || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è')}</div>
                  <div class="itemMeta">
                    <span class="badge">${e.amount < 0 ? `–°–æ–±—Ä–∞–Ω–æ: ${formatMoneyRUB(Math.abs(e.amount))}` : `–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${formatMoneyRUB(e.amount)}`}</span>
                  </div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" data-cal-expense-open="${e.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    ${goalsOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–¶–µ–ª–∏ (${goalsOnDay.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${goalsOnDay.map(g=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${escapeHtml(g.title)}</div>
                  <div class="itemMeta"><span class="badge">${g.target_amount} ‚ÇΩ</span></div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    ${readingsOnDay.length ? `
      <div class="card" style="margin-bottom:8px;">
        <div class="cardHeader"><div class="cardTitle">–ü–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ (${readingsOnDay.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${readingsOnDay.map(r=>{
              const meter = meterById.get(r.meter_id);
              return `
                <div class="item">
                  <div class="itemMain">
                    <div class="itemTitle">${escapeHtml(meter?.name || '–°—á—ë—Ç—á–∏–∫')}</div>
                    <div class="itemMeta"><span class="badge">${r.value}</span></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      </div>
    ` : ''}
    ${checklists.length ? `
      <div class="card">
        <div class="cardHeader"><div class="cardTitle">–ß–µ–∫-–ª–∏—Å—Ç—ã (${checklists.length})</div></div>
        <div class="cardBody">
          <div class="list">
            ${checklists.map(cl=>`
              <div class="item">
                <div class="itemMain">
                  <div class="itemTitle">${escapeHtml(cl.name)}</div>
                  <div class="itemMeta"><span class="badge">${(cl.items || []).length} –ø—É–Ω–∫—Ç–æ–≤</span></div>
                </div>
                <div class="itemActions">
                  <button class="iconBtn" data-cal-checklist-open="${cl.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    ` : '<div class="muted">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>'}
  `;

  $$('[data-cal-task-open]').forEach(btn=>{
    btn.onclick = async ()=>{
      const taskId = btn.dataset.calTaskOpen;
      const all = await api.tasks.list({ profile_id: state.profileId, status:'all', range:'all' });
      const task = all.ok ? all.data.find(t=>t.id===taskId) : null;
      setRoute('tasks');
      await renderTasks({ status:'all', range:'all' });
      if(task) openTaskModal(task);
    };
  });
  $$('[data-cal-checklist-open]').forEach(btn=>{
    btn.onclick = ()=>{
      setRoute('checklists');
      renderChecklists();
      viewChecklist(btn.dataset.calChecklistOpen);
    };
  });
  $$('[data-cal-expense-open]').forEach(btn=>{
    btn.onclick = ()=>{
      const expense = expensesOnDay.find(e=>e.id===btn.dataset.calExpenseOpen);
      openExpenseModal(expense);
    };
  });
  const planLists = $$('.cardBody', details).filter(el=>el.querySelector('[data-plan-del]'));
  planLists.forEach(list=>bindPlanActions(list));
  const logLists = $$('.cardBody', details).filter(el=>el.querySelector('[data-log-del]'));
  logLists.forEach(list=>bindLogActions(list));
}

// ============================================
// ROUTER
// ============================================

async function render(){
  if(state.route==='dashboard') return renderDashboard();
  if(state.route==='tasks') return renderTasks();
  if(state.route==='calendar') return renderCalendar();
  if(state.route==='routines') return renderRoutines();
  if(state.route==='assets') return renderAssets();
  if(state.route==='asset-detail') return renderAssetDetail();
  if(state.route==='maintenance') return renderMaintenance();
  if(state.route==='goals') return renderGoals();
  if(state.route==='documents') return renderDocuments();
  if(state.route==='utility') return renderUtilityCalculator();
  if(state.route==='analytics') return renderAnalytics();
  if(state.route==='settings') return renderSettings();
  if(state.route==='backup') return renderBackup();

  // New routes v2.0
  if(state.route==='property') return renderProperty();
  if(state.route==='rooms') return renderRooms();
  if(state.route==='inventory') return renderInventory();
  if(state.route==='meters') return renderMeters();
  if(state.route==='contacts') return renderContacts();
  if(state.route==='checklists') return renderChecklists();
  if(state.route==='stats') return renderStats();
}

// ===== ONBOARDING =====
let onboardingStep = 1;
let onboardingData = { templateKey: null, userName: '' };

async function showOnboarding() {
  onboardingStep = 1;
  onboardingData = { templateKey: null, userName: '' };
  window.onboardingData = onboardingData; // Re-expose after reassignment
  renderOnboarding();
}

function renderOnboarding() {
  const container = document.getElementById('app');

  container.innerHTML = `
    <div class="onboarding">
      <div class="onboarding-card">
        ${onboardingStep === 1 ? renderOnboardingStep1() : ''}
        ${onboardingStep === 2 ? renderOnboardingStep2() : ''}
        ${onboardingStep === 3 ? renderOnboardingStep3() : ''}
      </div>
    </div>
  `;

  // Attach event listeners after rendering (CSP prevents inline onclick)
  const nextBtn = container.querySelector('#onboarding-next-btn');
  const prevBtn = container.querySelector('#onboarding-prev-btn');
  const finishBtn = container.querySelector('#onboarding-finish-btn');
  const nameInput = container.querySelector('#onboarding-name');
  const templateOptions = container.querySelectorAll('.template-option');

  if (nextBtn) nextBtn.onclick = () => nextOnboardingStep();
  if (prevBtn) prevBtn.onclick = () => prevOnboardingStep();
  if (finishBtn) finishBtn.onclick = () => finishOnboarding();
  if (nameInput) nameInput.oninput = (e) => { onboardingData.userName = e.target.value; };

  templateOptions.forEach(opt => {
    opt.onclick = () => {
      const key = opt.dataset.template;
      selectTemplate(key);
    };
  });
}

function renderOnboardingStep1() {
  return `
    <div class="onboarding-step">
      <div class="onboarding-emoji">üè†</div>
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Home Manager!</h1>
      <p>–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–º–æ–º, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∑–∞–¥–∞—á–∏, –≤–Ω–æ—Å–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.</p>
      <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.</p>
      <button id="onboarding-next-btn" class="btn btn-large" style="margin-top:20px; background:#667eea; color:white; font-size:16px; padding:12px 24px;">
        –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É ‚Üí
      </button>
    </div>
  `;
}

function renderOnboardingStep2() {
  return `
    <div class="onboarding-step">
      <h2>–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?</h2>
      <input
        type="text"
        id="onboarding-name"
        class="input"
        style="width:100%; font-size:16px; padding:12px;"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"
        value="${escapeHtml(onboardingData.userName)}"
      >

      <h2 style="margin-top: 24px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∂–∏–ª—å—è</h2>
      <p>–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –≤–∞—Å</p>

      <div class="template-options">
        <div class="template-option ${onboardingData.templateKey === 'apartment' ? 'selected' : ''}" data-template="apartment">
          <div class="template-icon">üè¢</div>
          <div class="template-name">–ö–≤–∞—Ä—Ç–∏—Ä–∞</div>
        </div>
        <div class="template-option ${onboardingData.templateKey === 'house' ? 'selected' : ''}" data-template="house">
          <div class="template-icon">üè°</div>
          <div class="template-name">–ß–∞—Å—Ç–Ω—ã–π –¥–æ–º</div>
        </div>
        <div class="template-option ${onboardingData.templateKey === 'dacha' ? 'selected' : ''}" data-template="dacha">
          <div class="template-icon">üå≥</div>
          <div class="template-name">–î–∞—á–∞</div>
        </div>
      </div>

      <div class="onboarding-actions" style="margin-top:24px;">
        <button id="onboarding-prev-btn" class="btn">
          ‚Üê –ù–∞–∑–∞–¥
        </button>
        <button id="onboarding-next-btn" class="btn" style="background:#667eea; color:white;">
          –î–∞–ª–µ–µ ‚Üí
        </button>
      </div>
    </div>
  `;
}

function renderOnboardingStep3() {
  const templateName = onboardingData.templateKey ?
    { apartment: '–ö–≤–∞—Ä—Ç–∏—Ä–∞', house: '–ß–∞—Å—Ç–Ω—ã–π –¥–æ–º', dacha: '–î–∞—á–∞' }[onboardingData.templateKey] :
    '–ë–µ–∑ —à–∞–±–ª–æ–Ω–∞';

  return `
    <div class="onboarding-step">
      <div class="onboarding-emoji">‚úÖ</div>
      <h2>–í—Å—ë –≥–æ—Ç–æ–≤–æ!</h2>

      <div class="onboarding-summary" style="background:#f7fafc; padding:16px; border-radius:8px; margin:16px 0;">
        <p><strong>–ò–º—è:</strong> ${escapeHtml(onboardingData.userName) || '–Ø'}</p>
        <p style="margin-top:8px;"><strong>–®–∞–±–ª–æ–Ω:</strong> ${templateName}</p>
      </div>

      <p>–ú—ã —Å–æ–∑–¥–∞–¥–∏–º –¥–ª—è –≤–∞—Å:</p>
      <ul style="text-align:left; margin:16px 0;">
        <li>–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</li>
        <li>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</li>
        <li>–°—á—ë—Ç—á–∏–∫–∏ –ñ–ö–•</li>
        <li>–ü–æ–ª–µ–∑–Ω—ã–µ —á–µ–∫-–ª–∏—Å—Ç—ã</li>
      </ul>

      <div class="onboarding-actions" style="margin-top:24px;">
        <button id="onboarding-prev-btn" class="btn">
          ‚Üê –ù–∞–∑–∞–¥
        </button>
        <button id="onboarding-finish-btn" class="btn btn-large" style="background:#667eea; color:white; font-size:16px; padding:12px 24px;">
          üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É
        </button>
      </div>
    </div>
  `;
}

function selectTemplate(key) {
  onboardingData.templateKey = key;
  renderOnboarding();
}

function nextOnboardingStep() {
  if (onboardingStep === 2) {
    onboardingData.userName = document.getElementById('onboarding-name')?.value || '';
  }
  onboardingStep++;
  renderOnboarding();
}

function prevOnboardingStep() {
  onboardingStep--;
  renderOnboarding();
}

function restoreMainAppUI() {
  const appContainer = document.getElementById('app');
  appContainer.innerHTML = `
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">üè†</div>
        <div class="brandText">
          <div class="brandTitle">Home Manager</div>
          <div class="brandSub">–ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ desktop</div>
        </div>
      </div>
      <nav class="nav" id="nav"></nav>
      <div class="sidebarFooter">
        <div class="muted" id="appInfo">‚Äî</div>
        <button class="linkBtn" id="openDataFolder">–û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É –¥–∞–Ω–Ω—ã—Ö</button>
      </div>
    </aside>
    <main class="main">
      <header class="header">
        <div class="profileRow">
          <label class="muted">–ü—Ä–æ—Ñ–∏–ª—å:</label>
          <select id="profileSelect"></select>
        </div>
        <div class="searchRow">
          <input id="globalSearch" class="input" placeholder="–ü–æ–∏—Å–∫ (–¥–µ–ª–∞, –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, —Ü–µ–ª–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã)‚Ä¶" />
        </div>
        <div class="actionsRow">
          <div id="statsDisplay" style="display:none; margin-right:12px;"></div>
          <button class="btn" id="quickAddBtn">Ôºã</button>
        </div>
      </header>
      <section class="content" id="content"></section>
    </main>
  `;
}

async function finishOnboarding() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º...';

  const result = await api.onboarding.complete(onboardingData);

  if (result.ok) {
    // Restore main app UI
    restoreMainAppUI();

    // Re-attach event handlers after restoring UI
    $('#profileSelect').onchange=(e)=>{ state.profileId=e.target.value; render(); };
    $('#openDataFolder').onclick=async ()=>{ const r=await api.meta.openDataFolder(); if(!r.ok) toast(r.error); };
    $('#quickAddBtn').onclick=()=>openModal('–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ', `
      <div class="list">
        <button class="btn" id="qaTask">+ –î–µ–ª–æ</button>
        <button class="btn" id="qaRoutine">+ –†—É—Ç–∏–Ω–∞</button>
        <button class="btn" id="qaPlan">+ –ü–ª–∞–Ω –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</button>
        <button class="btn" id="qaDoc">+ –î–æ–∫—É–º–µ–Ω—Ç</button>
      </div>
    `, (root)=>{
      $('#qaTask', root).onclick=()=>{ closeModal(); openTaskModal(); };
      $('#qaRoutine', root).onclick=()=>{ closeModal(); setRoute('routines'); openRoutineModal(); };
      $('#qaPlan', root).onclick=()=>{ closeModal(); openPlanModal(); };
      $('#qaDoc', root).onclick=()=>{ closeModal(); openDocModal(); };
    });
    $('#globalSearch').onkeydown=(e)=>{ if(e.key==='Enter'){ const q=e.target.value.trim(); if(q) renderSearchResults(q); } };
    $('#nav').onclick=(e)=>{ const btn=e.target.closest('.navItem'); if(btn) setRoute(btn.dataset.route); };
    api.events.onDataChanged(async ()=>{ await loadProfiles(); await loadTags(); });

    toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üéâ', 'success');

    // Reload data and render
    await loadMeta();
    await loadProfiles();
    await loadTags();
    await loadUserStats();
    await loadVisibleModules();

    // Apply theme
    if (state.userStats && state.userStats.theme) {
      applyTheme(state.userStats.theme);
    }

    renderNav();
    setRoute('dashboard');
  } else {
    toast('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'error');
    btn.disabled = false;
    btn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É';
  }
}

// Expose onboarding functions and data globally for inline onclick handlers
window.nextOnboardingStep = nextOnboardingStep;
window.prevOnboardingStep = prevOnboardingStep;
window.finishOnboarding = finishOnboarding;
window.selectTemplate = selectTemplate;
window.onboardingData = onboardingData;

async function init(){
  await loadMeta(); await loadProfiles(); await loadTags(); await loadUserStats();
  await loadVisibleModules();
  renderNav();

  // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
  if (state.userStats && state.userStats.theme) {
    applyTheme(state.userStats.theme);
  }

  // Set up event handlers BEFORE onboarding check
  $('#profileSelect').onchange=(e)=>{ state.profileId=e.target.value; render(); };
  $('#openDataFolder').onclick=async ()=>{ const r=await api.meta.openDataFolder(); if(!r.ok) toast(r.error); };

  $('#quickAddBtn').onclick=()=>openModal('–ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ', `
      <div class="list">
        <button class="btn" id="qaTask">+ –î–µ–ª–æ</button>
        <button class="btn" id="qaRoutine">+ –†—É—Ç–∏–Ω–∞</button>
        <button class="btn" id="qaPlan">+ –ü–ª–∞–Ω –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</button>
        <button class="btn" id="qaDoc">+ –î–æ–∫—É–º–µ–Ω—Ç</button>
      </div>
    `, (root)=>{
      $('#qaTask', root).onclick=()=>{ closeModal(); openTaskModal(); };
      $('#qaRoutine', root).onclick=()=>{ closeModal(); setRoute('routines'); openRoutineModal(); };
      $('#qaPlan', root).onclick=()=>{ closeModal(); openPlanModal(); };
      $('#qaDoc', root).onclick=()=>{ closeModal(); openDocModal(); };
    });

  $('#globalSearch').onkeydown=(e)=>{ if(e.key==='Enter'){ const q=e.target.value.trim(); if(q) renderSearchResults(q); } };

  $('#nav').onclick=(e)=>{ const btn=e.target.closest('.navItem'); if(btn) setRoute(btn.dataset.route); };

  api.events.onDataChanged(async ()=>{ await loadProfiles(); await loadTags(); });

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
  const onboardingStatus = await api.onboarding.getStatus();
  if (onboardingStatus.ok && !onboardingStatus.data.completed) {
    showOnboarding();
    return;
  }

  api.routines.generate({ daysAhead:14 }).catch(()=>{});
  render();
}
init();
